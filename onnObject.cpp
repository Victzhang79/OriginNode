#include "onnObject.h"
#include <QMultiMap>

static QSettings *onnSetting;
static onnKey onnObjectKey;
static QHash<QString,QString> onnArgument;
static QHash<QByteArray,QByteArray> onnBoss;
static QMultiHash<QByteArray,QByteArray> onnBossforAddress;
static leveldb::DB *onnObjectDB;
static QStringList onnReadableContract;
static QHash<QString,onnBossBlock> *onnBlockChain = new QHash<QString,onnBossBlock>;
static QHash<QString,lua_State *> *onnObjectContract = new QHash<QString,lua_State *>;
static Hub *onnWebsocket;// = new Hub();
static NetSync *onnSync;
static QStringList onnPeerList;
static QStringList onnPeerLose;
static QTimer *onnTimer = new QTimer();
static QList<QByteArray> onnWebsocketAddress;
static QList<QByteArray> onnWebsocketPeers;
static QHash<QString,onnSyncQueue> onnSyncData;
static QHash<QString,onnSyncQueue> onnSyncRequest;
static QHash<QString,onnSyncQueue> onnSyncResponse;
static int onnSyncRequestCount = 0;
static int onnSyncResponseCount = 0;
static QStringList onnClientList;
static QMultiHash<QByteArray,QByteArray> onnChangeBossData;
static QStringList onnBlackList;
static QReadWriteLock onnRWlock;
static QMutex onnLock;
static int onnGas = 0;

onnObject::onnObject(QString pType){
    objType = pType;
    flagStart = false;
}
onnObject::~onnObject(){}

void onnObject::init(){emit doInit();}
void onnObject::onInit(){emit doInitFinish();}
void onnObject::onInitFinish(){}
void onnObject::onStart(){
    std::cout << "object start" << std::endl;
    flagStart = true;
    emit doStartFinish();
}
void onnObject::onStartFinish(){}
void onnObject::onChangeTimer(QByteArray,QByteArray){}

QByteArray onnObject::Encrypt(QByteArray pHex,QByteArray pMsg)
{
    //BUG << pMsg;
    QByteArray result;
    QByteArray keyiv = QByteArray::fromHex(GETSHA256(QByteArray::fromHex(pHex)));
    unsigned char key[EVP_MAX_KEY_LENGTH] = {0};  //保存密钥的数组
    unsigned char iv[EVP_MAX_KEY_LENGTH] = {0};   //保存初始化向量的数组
    EVP_CIPHER_CTX ctx;         //EVP加密上下文环境
    unsigned char out[1024] = {0};        //保存密文的缓冲区
    int outl;
    int rv;
    int i;

    //设置key和iv
    for(i=0;i<24;i++)
    {
        key[i]=(unsigned char)keyiv.at(i);
    }
    for(i=0;i<8;i++)
    {
        iv[i]=(unsigned char)keyiv.at(i+24);
    }

    //初始化ctx
    EVP_CIPHER_CTX_init(&ctx);
    rv = EVP_EncryptInit_ex(&ctx,EVP_des_ede3_cbc(),NULL,key,iv);
    if(rv != 1)
    {
        printf("Err\n");
        return result;
    }
    rv = EVP_EncryptUpdate(&ctx,out,&outl,(const unsigned char *)pMsg.data(),pMsg.count());//加密
    if(rv != 1)
    {
        //fail
        return result;
    }
    result.append((const char *)out,outl);
    rv = EVP_EncryptFinal_ex(&ctx,out,&outl);
    if(rv != 1)
    {
        EVP_CIPHER_CTX_cleanup(&ctx);
        return result;
    }
    QByteArray result1;
    result1.append((const char *)out,outl);
    //BUG << result.toHex();
    //BUG << result1.toHex();
    EVP_CIPHER_CTX_cleanup(&ctx);   //清除EVP加密上下文环境
    return (result+result1).toHex();
}

QByteArray onnObject::Decrypt(QByteArray pHex,QByteArray pMsg)
{
    //BUG << pMsg;
    QByteArray result;
    QByteArray secmsg = QByteArray::fromHex(pMsg);
    QByteArray keyiv = QByteArray::fromHex(GETSHA256(QByteArray::fromHex(pHex)));
    unsigned char key[EVP_MAX_KEY_LENGTH] = {0};      //保存密钥的数组
    unsigned char iv[EVP_MAX_KEY_LENGTH] = {0};       //保存初始化向量的数组
    EVP_CIPHER_CTX ctx;             //EVP加密上下文环境
    unsigned char out[1024+EVP_MAX_KEY_LENGTH] = {0}; //保存解密后明文的缓冲区数组
    int outl;
    int rv;
    int i;

    for(i=0;i<24;i++)
    {
        key[i]=(unsigned char)keyiv.at(i);
    }
    for(i=0;i<8;i++)
    {
        iv[i]=(unsigned char)keyiv.at(i+24);
    }

    //初始化ctx
    EVP_CIPHER_CTX_init(&ctx);
    rv = EVP_DecryptInit_ex(&ctx,EVP_des_ede3_cbc(),NULL,key,iv);
    if(rv != 1)
    {
        EVP_CIPHER_CTX_cleanup(&ctx);
        return result;
    }
    rv = EVP_DecryptUpdate(&ctx,out,&outl,(const unsigned char *)secmsg.data(),secmsg.count());//解密
    if(rv != 1)
    {
        //fail
        EVP_CIPHER_CTX_cleanup(&ctx);
        return result;
    }
    result.append((const char *)out,outl);

    rv = EVP_DecryptFinal_ex(&ctx,out,&outl);
    if(rv != 1)
    {
        EVP_CIPHER_CTX_cleanup(&ctx);
        return result;
    }
    QByteArray result1;
    result1.append((const char *)out,outl);
    EVP_CIPHER_CTX_cleanup(&ctx);//清除EVP加密上下文环境
    //BUG << result+result1 << (result+result1).count();
    return result+result1;
}

QByteArray onnObject::getBlock0(){
    /*
    QFile f("0");
    f.open(QIODevice::ReadOnly);
    QByteArray curBlockSource = f.readAll();
    f.close();
    QByteArray curBlockSource1 = doDeploy("0",curBlockSource,"6e756c6c");
    onnBlock curBlock = createBlock(0,\
                                    QDateTime::currentMSecsSinceEpoch(),\
                                    GETSHA256(curBlockSource1),\
                                    curBlockSource1);
    return toString(curBlock);
    */
    QByteArray curBlock0 = "0@1538114066626@4b8ab10a8f677dd6cebc3ecb68efca65324deec22ea8381c2062ae7957a27556@35363936643062653834356532383662363630373162313034356361663064303364323066623235363238353661393866336536323931316332653138656339@C045A59A8BB94063E15E9270C03268E82EEDE9F9655F671242B3C359D60228B2D15827E88A0DC689CC6A6287635FC75243BB323036F27D9D92BBA00F58A330A9&deploy$18cee66a7de6f665dc71c5ef9233a0e93473df3bcfc91c278d06c5503ffaeb4ecdc2b75e74580ce53cd9dd91c217f64baf7e3833981884139638375c79690bc2$0$6a736f6e203d207265717569726520276a736f6e270a674c6173744d6f64696679203d20273230313820303730362031303a3030270a6755736572202020203d206e696c0a674d616b65722020203d206e696c0a674e616d65202020203d2027626f737320636f6e7472616374270a6753796d626f6c20203d2027626f7373270a6742616c616e6365203d207b7d0a67467265657a656e203d207b7d0a67546f74616c2020203d20313030303030303030300a674f776e65722020203d206e696c0a6746656520202020203d20302e310a67466565506f6f6c203d20300a6749636f6e202020203d2027270a67426f7373202020203d207b7d0a6750656572732020203d2027270a6753656564202020203d20300a674f726465722020203d207b7d0a674f726465724944203d202731270a674964656e746974793d207b7d0a6744657374726f79203d207b7d0a0a66756e6374696f6e205f73657455736572287055736572290a202020206755736572203d2070557365720a656e640a0a66756e6374696f6e205f6765745573657228290a2020202072657475726e2067557365720a656e640a0a66756e6374696f6e205f7365744d616b6572287055736572290a20202020674d616b65723d2070557365720a656e640a0a66756e6374696f6e205f736574506565727328704c697374290a20202020675065657273203d20704c6973740a656e640a0a66756e6374696f6e205f646f52616e6428704d6178290a202020206d6174682e72616e646f6d73656564286753656564290a2020202072657475726e206d6174682e72616e646f6d28312c704d6178290a656e640a0a66756e6374696f6e205f67657442616c616e63654f66287055736572290a202020206966206742616c616e63655b70557365725d203d3d206e696c207468656e0a092020202072657475726e20300a20202020656e640a202020202020202072657475726e206742616c616e63655b70557365725d0a656e640a0a66756e6374696f6e205f676574546f74616c28290a2020202072657475726e2067546f74616c0a656e640a0a66756e6374696f6e205f64657374726f79287053796d626f6c290a202020206966206755736572203d3d2067426f73735b7053796d626f6c5d5b276f776e6572275d207468656e0a2020202020202020674964656e746974795b67426f73735b7053796d626f6c5d5b276d616b6572275d5d203d206e696c0a202020202020202069662067467265657a656e5b67426f73735b7053796d626f6c5d5b276f776e6572275d5d203c3d2031207468656e0a2020202020202020202020206742616c616e63655b674f776e65725d203d206742616c616e63655b674f776e65725d202b2067467265657a656e5b67426f73735b7053796d626f6c5d5b276f776e6572275d5d0a20202020202020202020202067467265657a656e5b67426f73735b7053796d626f6c5d5b276f776e6572275d5d203d20300a2020202020202020656c73650a2020202020202020202020206c6f63616c20637572506179203d2067467265657a656e5b67426f73735b7053796d626f6c5d5b276f776e6572275d5d2f320a2020202020202020202020206742616c616e63655b674f776e65725d203d206742616c616e63655b674f776e65725d202b206375725061790a2020202020202020202020206742616c616e63655b67426f73735b7053796d626f6c5d5b276f776e6572275d5d203d206742616c616e63655b67426f73735b7053796d626f6c5d5b276f776e6572275d5d202b202867467265657a656e5b67426f73735b7053796d626f6c5d5b276f776e6572275d5d2d637572506179290a20202020202020202020202067467265657a656e5b67426f73735b7053796d626f6c5d5b276f776e6572275d5d203d20300a2020202020202020656e640a202020202020202072657475726e20226f6b220a20202020656e640a2020202069662067467265657a656e5b67426f73735b7053796d626f6c5d5b276f776e6572275d5d203e2031207468656e0a202020202020202072657475726e20276661696c270a20202020656e640a202020206742616c616e63655b674f776e65725d203d206742616c616e63655b674f776e65725d202b2067467265657a656e5b67426f73735b7053796d626f6c5d5b276f776e6572275d5d0a2020202067467265657a656e5b67426f73735b7053796d626f6c5d5b276f776e6572275d5d203d20300a2020202072657475726e20226f6b220a656e640a0a66756e6374696f6e205f6765744e657874426f7373287042616c616e6365290a202020206c6f63616c206375724c697374203d205f73706c6974286750656572732c20272c27290a20202020696620236375724c697374203d3d2030207468656e0a20202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a202020202020202072657475726e20276661696c270a20202020656e640a202020207072696e74286a736f6e2e656e636f6465286375724c69737429290a202020206c6f63616c2069203d20310a202020206c6f63616c207467744c697374203d207b7d0a202020206c6f63616c207467744c69737431203d207b7d0a202020207768696c652069203c3d20236375724c69737420646f0a20202020202020206966206742616c616e63655b6375724c6973745b695d5d207e3d206e696c20616e64206742616c616e63655b6375724c6973745b695d5d203e20746f6e756d626572287042616c616e636529207468656e0a2020202020202020202020207461626c652e696e7365727428207467744c6973742c206375724c6973745b695d20290a202020202020202020202020696620674964656e746974795b6375724c6973745b695d5d203d3d206e696c206f7220674964656e746974795b6375724c6973745b695d5d203d3d2030207468656e0a202020202020202020202020202020207461626c652e696e7365727428207467744c697374312c206375724c6973745b695d20290a202020202020202020202020656e640a2020202020202020656e640a202020202020202069203d20692b310a20202020656e640a202020206c6f63616c20637572436f756e74203d20237467744c6973740a20202020696620637572436f756e74203d3d2030207468656e0a202020202020202072657475726e206375724c6973745b315d0a20202020656e640a202020206c6f63616c20637572436f756e7431203d20237467744c697374310a202020202d2d7072696e74286a736f6e2e656e636f6465287467744c69737429290a20202020696620637572436f756e7431203e2030207468656e0a20202020202020206c6f63616c20637572496e64657831203d205f646f52616e6428637572436f756e7431290a202020202020202072657475726e207467744c697374315b637572496e646578315d0a20202020656c73650a20202020202020206c6f63616c20637572496e646578203d205f646f52616e6428637572436f756e74290a202020202020202072657475726e207467744c6973745b637572496e6465785d0a20202020656e640a656e640a0a66756e6374696f6e205f7365744e657874426f7373287053796d626f6c2c7042616c616e6365290a2020202069662067426f73735b7053796d626f6c5d203d3d206e696c207468656e0a20202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a202020202020202072657475726e20276661696c270a20202020656e640a202020206c6f63616c206375724e657874203d205f6765744e657874426f7373287042616c616e6365290a202020206966206375724e657874203d3d20276661696c27207468656e0a20202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a202020202020202072657475726e20276661696c270a20202020656e640a202020206c6f63616c206375724d616b65723d2067426f73735b7053796d626f6c5d5b276d616b6572275d0a20202020674964656e746974795b6375724d616b65725d203d20674964656e746974795b6375724d616b65725d2d310a20202020696620674964656e746974795b6375724e6578745d203d3d206e696c207468656e0a2020202020202020674964656e746974795b6375724e6578745d203d20300a20202020656e640a20202020674964656e746974795b6375724e6578745d20203d20674964656e746974795b6375724e6578745d2b310a2020202067426f73735b7053796d626f6c5d5b276d616b6572275d203d206375724e6578740a2020202072657475726e206375724e6578740a656e640a0a66756e6374696f6e205f73657452617465287053796d626f6c290a2020202067426f73735b7053796d626f6c5d5b2772617465275d20203d20737472696e672e666f726d61742827252e3066272c2067426f73735b7053796d626f6c5d5b27746f74616c275d2f67467265657a656e5b67426f73735b7053796d626f6c5d5b276f776e6572275d5d290a656e640a0a66756e6374696f6e205f7365744465706c6f79426f7373287053796d626f6c2c7042616c616e63652c70546f74616c2c70467265657a656e290a202020206966205f7472616e73666572546f467265657a656e53656c662867557365722c70467265657a656e29203d3d20276661696c27207468656e0a20202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a202020202020202072657475726e20276661696c270a20202020656e640a2020202069662067467265657a656e5b67557365725d203d3d206e696c207468656e0a20202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a202020202020202072657475726e20276661696c270a20202020656e640a20202020696620746f6e756d62657228737472696e672e666f726d61742827252e3066272c2067467265657a656e5b67557365725d2f746f6e756d6265722870546f74616c292929203e20313030303030207468656e0a20202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a202020202020202072657475726e20276661696c270a20202020656e640a2020202069662067426f73735b7053796d626f6c5d207e3d206e696c207468656e0a20202020202020207072696e74286a736f6e2e656e636f64652867426f73735b7053796d626f6c5d29290a20202020202020202d2d72657475726e205f676574526573756c742867557365722c275f7365744465706c6f79426f7373272c66616c73652c27626f737320657869737427290a20202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a202020202020202072657475726e20276661696c270a20202020656e640a2020202067426f73735b7053796d626f6c5d203d207b7d0a202020206c6f63616c206375724e657874203d205f6765744e657874426f7373287042616c616e6365290a202020206966206375724e657874203d3d20276661696c27207468656e0a20202020202020202d2d72657475726e205f676574526573756c742867557365722c275f7365744465706c6f79426f7373272c66616c73652c276375724e657874206661696c27290a20202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a202020202020202072657475726e20276661696c270a20202020656e640a20202020696620674964656e746974795b6375724e6578745d203d3d206e696c207468656e0a2020202020202020674964656e746974795b6375724e6578745d203d20300a20202020656e640a20202020674964656e746974795b6375724e6578745d203d20674964656e746974795b6375724e6578745d2b310a2020202067426f73735b7053796d626f6c5d5b276d616b6572275d203d206375724e6578740a2020202067426f73735b7053796d626f6c5d5b27746f74616c275d203d20746f6e756d6265722870546f74616c290a2020202067426f73735b7053796d626f6c5d5b27756e757365275d203d20746f6e756d6265722870546f74616c290a202020205f736574546f6b656e4f776e6572287053796d626f6c2c6755736572290a20202020696620746f6e756d6265722870546f74616c29203c3d2030207468656e0a202020202020202067426f73735b7053796d626f6c5d5b2772617465275d20203d20300a20202020656c73650a20202020202020205f73657452617465287053796d626f6c290a20202020656e640a202020200a202020206753656564203d2067536565642b310a2020202072657475726e206375724e6578740a656e640a0a66756e6374696f6e205f73706c6974287374722c2064656c696d69746572290a096966207374723d3d6e696c206f72207374723d3d2727206f722064656c696d697465723d3d6e696c207468656e0a090972657475726e206e696c0a09656e640a090a202020206c6f63616c20726573756c74203d207b7d0a20202020666f72206d6174636820696e20287374722e2e64656c696d69746572293a676d617463682822282e2d29222e2e64656c696d697465722920646f0a20202020202020207461626c652e696e7365727428726573756c742c206d61746368290a20202020656e640a2020202072657475726e20726573756c740a656e640a0a66756e6374696f6e205f616464526573756c742870557365722c704d6574686f642c70526573756c742c704d73672c70416c6c290a202020206c6f63616c20627566666572203d207b7d0a202020206c6f63616c20726573756c74203d2070416c6c0a202020206275666665725b276d6574686f64275d203d20704d6574686f640a202020206275666665725b27726573756c74275d203d2070526573756c740a202020206275666665725b276d7367275d202020203d20704d73670a202020206275666665725b276f776e6572275d20203d2070557365720a202020206275666665725b2773796d626f6c275d203d206753796d626f6c0a202020207461626c652e696e7365727428726573756c742c627566666572290a2020202072657475726e20726573756c740a656e640a0a66756e6374696f6e205f676574526573756c742870557365722c704d6574686f642c70526573756c742c704d7367290a202020206c6f63616c20627566666572203d207b7d0a202020206c6f63616c20726573756c74203d205f616464526573756c742870557365722c704d6574686f642c70526573756c742c704d73672c627566666572290a2020202072657475726e206a736f6e2e656e636f646528726573756c74290a656e640a0a66756e6374696f6e205f4973496e5461626c652876616c75652c2074626c290a20202020666f72206b2c7620696e206970616972732874626c2920646f0a202020202020202069662076203d3d2076616c7565207468656e0a20202020202020202020202072657475726e20747275653b0a2020202020202020656e640a20202020656e640a2020202072657475726e2066616c73653b0a656e640a0a66756e6374696f6e205f6765744f776e657228290a2020202072657475726e20674f776e65720a656e640a0a66756e6374696f6e20696e697428290a20202020696620674f776e6572207e3d206e696c207468656e0a20202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a202020202020202072657475726e20276661696c270a20202020656e640a202020207072696e74286755736572290a20202020674f776e6572203d2067557365720a202020206742616c616e63655b67557365725d203d2067546f74616c0a0a2020202067426f73735b6753796d626f6c5d203d207b7d0a2020202067426f73735b6753796d626f6c5d5b276d616b6572275d203d2067557365720a2020202067426f73735b6753796d626f6c5d5b27746f74616c275d203d2067546f74616c0a0a202020206753656564203d2067536565642b310a0a202020206c6f63616c20637572526573756c74203d207b7d0a202020205f616464526573756c742867557365722c27696e6974272c747275652c67426f73735b6753796d626f6c5d2c637572526573756c74290a202020205f616464526573756c742867557365722c2767657442616c616e63654f66272c747275652c6742616c616e63655b67557365725d2c637572526573756c74290a2020202072657475726e206a736f6e2e656e636f646528637572526573756c74290a656e640a0a66756e6374696f6e207365744665652870466565290a202020206966206755736572207e3d20674f776e6572207468656e0a20202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a202020202020202072657475726e20276661696c270a20202020656e640a202020206c6f63616c20637572466565203d20746f6e756d6265722870466565290a20202020696620637572466565203c2030207468656e0a20202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a202020202020202072657475726e20276661696c270a20202020656e640a20202020696620637572466565203e2031207468656e0a20202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a202020202020202072657475726e20276661696c270a20202020656e640a2020202067466565203d20746f6e756d6265722870466565290a2020202072657475726e205f676574526573756c742867557365722c27736574466565272c747275652c67466565290a656e640a0a66756e6374696f6e2074616b65466565506f6f6c28290a202020206966206755736572207e3d20674f776e6572207468656e0a20202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a202020202020202072657475726e20276661696c270a20202020656e640a2020202069662067466565506f6f6c203c2031207468656e0a20202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a202020202020202072657475726e20276661696c270a20202020656e640a202020206742616c616e63655b67557365725d203d206742616c616e63655b67557365725d2b67466565506f6f6c0a2020202067466565506f6f6c203d20300a2020202072657475726e205f676574526573756c742867557365722c2767657442616c616e63654f66272c747275652c6742616c616e63655b67557365725d290a656e640a0a66756e6374696f6e20736574426f73734d616b6572287053796d626f6c2c7055736572290a2020202069662067426f73735b7053796d626f6c5d5b276f776e6572275d207e3d206755736572207468656e0a20202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a202020202020202072657475726e20276661696c270a20202020656e640a20202020696620674964656e746974795b70557365725d207e3d206e696c20616e6420674964656e746974795b70557365725d203e2030207468656e0a20202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a202020202020202072657475726e20276661696c270a20202020656e640a2020202069662067426f73735b7053796d626f6c5d5b276d616b6572275d203d3d206e696c207468656e0a20202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a202020202020202072657475726e20276661696c270a20202020656e640a202020206966206742616c616e63655b67557365725d203c20312b67466565207468656e0a20202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a202020202020202072657475726e20276661696c270a20202020656e640a202020206c6f63616c206375724d616b6572203d2067426f73735b7053796d626f6c5d5b276d616b6572275d0a2020202067426f73735b7053796d626f6c5d5b276d616b6572275d203d2070557365720a20202020674964656e746974795b6375724d616b65725d203d20674964656e746974795b6375724d616b65725d2d310a20202020696620674964656e746974795b70557365725d203d3d206e696c207468656e0a2020202020202020674964656e746974795b70557365725d203d20300a20202020656e640a20202020674964656e746974795b70557365725d202020203d20674964656e746974795b70557365725d2b310a202020206c6f63616c2074526573756c74203d207472616e73666572286375724d616b65722c31290a202020206c6f63616c20637572526573756c74203d207b7d0a202020205f616464526573756c74286375724d616b65722c27736574426f73734d616b6572272c747275652c7053796d626f6c2e2e273f272e2e70557365722c637572526573756c74290a202020205f616464526573756c742870557365722c27736574426f73734d616b6572272c747275652c7053796d626f6c2e2e273f272e2e70557365722c637572526573756c74290a202020205f616464526573756c742867557365722c27736574426f73734d616b6572272c747275652c7053796d626f6c2e2e273f272e2e70557365722c637572526573756c74290a202020205f616464526573756c7428272a272c27736574426f73734d616b6572272c747275652c74526573756c742c637572526573756c74290a2020202072657475726e206a736f6e2e656e636f646528637572526573756c74290a656e640a0a66756e6374696f6e206765744f7264657228290a20202020696620674f726465725b67557365725d203d3d206e696c207468656e0a202020202020202072657475726e205f676574526573756c742867557365722c276765744f72646572272c747275652c276e756c6c27290a20202020656e640a2020202072657475726e205f676574526573756c742867557365722c276765744f72646572272c747275652c674f726465725b67557365725d290a656e640a0a66756e6374696f6e20676574426f73734d616b6572287053796d626f6c290a2020202069662067426f73735b7053796d626f6c5d5b276d616b6572275d203d3d206e696c207468656e0a20202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a202020202020202072657475726e20276661696c270a20202020656e640a2020202072657475726e205f676574526573756c742867557365722c27676574426f73734d616b6572272c747275652c67426f73735b7053796d626f6c5d5b276d616b6572275d290a656e640a0a66756e6374696f6e2067657446656528290a202020206c6f63616c20637572526573756c74203d207b7d0a202020205f616464526573756c742867557365722c27676574466565272c747275652c674665652c637572526573756c74290a202020205f616464526573756c742867557365722c27676574466565506f6f6c272c747275652c67466565506f6f6c2c637572526573756c74290a2020202072657475726e206a736f6e2e656e636f646528637572526573756c74290a656e640a0a66756e6374696f6e2067657453796d626f6c28290a2020202072657475726e205f676574526573756c742867557365722c2767657453796d626f6c272c747275652c6753796d626f6c290a656e640a0a66756e6374696f6e20676574546f74616c537570706c7928290a2020202072657475726e205f676574526573756c742867557365722c27676574546f74616c537570706c79272c747275652c67546f74616c290a656e640a0a66756e6374696f6e206765744e616d6528290a2020202072657475726e205f676574526573756c742867557365722c276765744e616d65272c747275652c674e616d65290a656e640a0a66756e6374696f6e2067657442616c616e63654f66287055736572290a202020206966206742616c616e63655b70557365725d203d3d206e696c207468656e0a092020202072657475726e205f676574526573756c742867557365722c2767657442616c616e63654f66272c747275652c30290a20202020656e640a202020202020202072657475726e205f676574526573756c742867557365722c2767657442616c616e63654f66272c747275652c6742616c616e63655b70557365725d290a656e640a0a66756e6374696f6e2067657449636f6e28290a2020202072657475726e205f676574526573756c742867557365722c2767657449636f6e272c747275652c6749636f6e290a656e640a0a66756e6374696f6e2073657449636f6e287049636f6e290a20202020696620674f776e6572207e3d206755736572207468656e0a20202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a202020202020202072657475726e20276661696c270a20202020656e640a20202020696620737472696e672e6c656e28207049636f6e2029203e2032303438207468656e0a20202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a202020202020202072657475726e20276661696c270a20202020656e640a202020206749636f6e203d207049636f6e0a656e640a0a66756e6374696f6e207472616e736665722870546f2c70416d6f756e74290a202020206c6f63616c20637572416d6f756e74203d20746f6e756d6265722870416d6f756e74290a20202020696620637572416d6f756e74203e2067546f74616c207468656e0a20202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a202020202020202072657475726e20276661696c270a20202020656e640a20202020696620637572416d6f756e74203c3d2067466565207468656e0a20202020202020202d2d72657475726e205f676574526573756c742867557365722c277472616e73666572272c66616c73652c27616d6f756e74203c3d203027290a20202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a202020202020202072657475726e20276661696c270a20202020656e640a202020206966206742616c616e63655b67557365725d203c20637572416d6f756e742b67466565207468656e0a20202020202020202d2d72657475726e205f676574526573756c742867557365722c277472616e73666572272c66616c73652c2773656e64657220616d6f756e74203c20637572416d6f756e7427290a20202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a202020202020202072657475726e20276661696c270a20202020656e640a20202020696620674964656e746974795b67557365725d207e3d206e696c207468656e0a20202020202020206c6f63616c20637572546f74616c203d206742616c616e63655b67557365725d202d20637572416d6f756e740a2020202020202020696620637572546f74616c203c20674964656e746974795b67557365725d202a203130303030207468656e0a2020202020202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a20202020202020202020202072657475726e20276661696c270a2020202020202020656e640a20202020656e640a202020206966206742616c616e63655b70546f5d203d3d206e696c207468656e0a09202020206742616c616e63655b70546f5d203d20300a20202020656e640a202020206c6f63616c20637572526573756c74203d207b7d0a2020202067466565506f6f6c203d2067466565506f6f6c202b20674665650a202020206742616c616e63655b67557365725d203d206742616c616e63655b67557365725d202d20637572416d6f756e740a202020206742616c616e63655b67557365725d203d206742616c616e63655b67557365725d202d20674665650a202020206742616c616e63655b70546f5d203d206742616c616e63655b70546f5d202b20637572416d6f756e740a202020205f616464526573756c742867557365722c2767657442616c616e63654f66272c747275652c6742616c616e63655b67557365725d2c637572526573756c74290a202020205f616464526573756c742870546f2c2767657442616c616e63654f66272c747275652c6742616c616e63655b70546f5d2c637572526573756c74290a202020206753656564203d2067536565642b310a2020202072657475726e206a736f6e2e656e636f646528637572526573756c74290a656e640a0a66756e6374696f6e207472616e73666572546f426f7373287053796d626f6c2c70416d6f756e74290a202020206c6f63616c20637572416d6f756e74203d20746f6e756d6265722870416d6f756e74290a2020202069662067426f73735b7053796d626f6c5d203d3d206e696c207468656e0a20202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a202020202020202072657475726e20276661696c270a20202020656e640a20202020696620674964656e746974795b67557365725d207e3d206e696c207468656e0a20202020202020206c6f63616c20637572546f74616c203d206742616c616e63655b67557365725d202d20637572416d6f756e740a2020202020202020696620637572546f74616c203c20674964656e746974795b67557365725d202a203130303030207468656e0a2020202020202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a20202020202020202020202072657475726e20276661696c270a2020202020202020656e640a20202020656e640a202020206966205f7472616e73666572546f467265657a656e53656c662867426f73735b7053796d626f6c5d5b276f776e6572275d2c70416d6f756e7429203d3d20276661696c27207468656e0a20202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a202020202020202072657475726e20276661696c270a20202020656e640a202020205f73657452617465287053796d626f6c290a202020206c6f63616c20637572526573756c74203d207b7d0a202020205f616464526573756c742867557365722c277472616e73666572546f426f7373272c747275652c70416d6f756e742c637572526573756c74290a202020205f616464526573756c742867557365722c2767657452617465272c747275652c67426f73735b7053796d626f6c5d5b2772617465275d2c637572526573756c74290a2020202072657475726e206a736f6e2e656e636f646528637572526573756c74290a656e640a0a66756e6374696f6e205f7472616e73666572546f467265657a656e53656c662870546f2c70416d6f756e74290a202020206c6f63616c20637572416d6f756e74203d20746f6e756d6265722870416d6f756e74290a20202020696620637572416d6f756e74203e2067546f74616c207468656e0a20202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a202020202020202072657475726e20276661696c270a20202020656e640a20202020696620637572416d6f756e74203c3d2067466565207468656e0a20202020202020202d2d72657475726e205f676574526573756c742867557365722c277472616e73666572272c66616c73652c27616d6f756e74203c3d203027290a20202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a202020202020202072657475726e20276661696c270a20202020656e640a202020206966206742616c616e63655b67557365725d203c20637572416d6f756e742b67466565207468656e0a20202020202020202d2d72657475726e205f676574526573756c742867557365722c277472616e73666572272c66616c73652c2773656e64657220616d6f756e74203c20637572416d6f756e7427290a20202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a202020202020202072657475726e20276661696c270a20202020656e640a2020202069662067467265657a656e5b70546f5d203d3d206e696c207468656e0a092020202067467265657a656e5b70546f5d203d20300a20202020656e640a202020206c6f63616c20637572526573756c74203d207b7d0a2020202067466565506f6f6c203d2067466565506f6f6c202b20674665650a202020206742616c616e63655b67557365725d203d206742616c616e63655b67557365725d202d20637572416d6f756e740a202020206742616c616e63655b67557365725d203d206742616c616e63655b67557365725d202d20674665650a2020202067467265657a656e5b70546f5d203d2067467265657a656e5b70546f5d202b20637572416d6f756e740a202020205f616464526573756c742867557365722c2767657442616c616e63654f66272c747275652c6742616c616e63655b67557365725d2c637572526573756c74290a202020205f616464526573756c742870546f2c27676574467265657a656e272c747275652c67467265657a656e5b70546f5d2c637572526573756c74290a2020202072657475726e206a736f6e2e656e636f646528637572526573756c74290a656e640a0a66756e6374696f6e20676574467265657a656e28290a2020202072657475726e205f676574526573756c742867557365722c27676574467265657a656e272c747275652c67467265657a656e5b67557365725d290a656e640a0a66756e6374696f6e2067657452617465287053796d626f6c290a2020202069662067426f73735b7053796d626f6c5d203d3d206e696c207468656e0a202020202020202072657475726e205f676574526573756c742867557365722c2767657452617465272c747275652c30290a20202020656c73650a202020202020202072657475726e205f676574526573756c742867557365722c2767657452617465272c747275652c67426f73735b7053796d626f6c5d5b2772617465275d290a20202020656e640a656e640a0a66756e6374696f6e205f736574546f6b656e4f776e6572287053796d626f6c2c7055736572290a2020202069662067426f73735b7053796d626f6c5d203d3d206e696c207468656e0a20202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a202020202020202072657475726e20276661696c270a20202020656e640a2020202067426f73735b7053796d626f6c5d5b276f776e6572275d203d2070557365720a2020202072657475726e20276f6b270a656e640a0a66756e6374696f6e205f7472616e73666572546f467265657a656e287053796d626f6c2c70557365722c70416d6f756e74290a2020202069662067426f73735b7053796d626f6c5d203d3d206e696c207468656e0a20202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a202020202020202072657475726e20276661696c270a20202020656e640a202020206966206742616c616e63655b67557365725d203c20746f6e756d6265722870416d6f756e74292b67466565207468656e0a20202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a202020202020202072657475726e20276661696c270a20202020656e640a202020206742616c616e63655b67557365725d203d206742616c616e63655b67557365725d2d28746f6e756d6265722870416d6f756e74292b67466565290a2020202067467265657a656e5b70557365725d203d2067467265657a656e5b70557365725d2b28746f6e756d6265722870416d6f756e7429290a2020202072657475726e20276f6b270a656e640a0a66756e6374696f6e205f7472616e73666572546f42616c616e6365287053796d626f6c2c7046726f6d2c70546f2c70416d6f756e74290a2020202069662067426f73735b7053796d626f6c5d203d3d206e696c207468656e0a20202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a202020202020202072657475726e20276661696c270a20202020656e640a2020202069662067467265657a656e5b7046726f6d5d203c20746f6e756d6265722870416d6f756e7429207468656e0a20202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a202020202020202072657475726e20276661696c270a20202020656e640a202020206966206742616c616e63655b67557365725d203c2067466565207468656e0a20202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a202020202020202072657475726e20276661696c270a20202020656e640a202020206742616c616e63655b67557365725d203d206742616c616e63655b67557365725d2d674665650a2020202067467265657a656e5b7046726f6d5d203d2067467265657a656e5b7046726f6d5d2d746f6e756d6265722870416d6f756e74290a202020206742616c616e63655b70546f5d203d206742616c616e63655b70546f5d2b746f6e756d6265722870416d6f756e74290a2020202072657475726e20276f6b270a656e640a0a66756e6374696f6e20746f6b656e427579287053796d626f6c2c70416d6f756e74290a202020206966207053796d626f6c203d3d20273027207468656e0a20202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a202020202020202072657475726e20276661696c270a20202020656e640a2020202069662067426f73735b7053796d626f6c5d5b27756e757365275d203c20746f6e756d6265722870416d6f756e7429207468656e0a20202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a202020202020202072657475726e20276661696c270a20202020656e640a202020206c6f63616c206375724f776e657220203d2067426f73735b7053796d626f6c5d5b276f776e6572275d0a202020206966206375724f776e6572203d3d206755736572207468656e0a20202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a202020202020202072657475726e20276661696c270a20202020656e640a202020206c6f63616c206e6565645573653020203d20737472696e672e666f726d6174282022252e3266222c28312f67426f73735b7053796d626f6c5d5b2772617465275d292a70416d6f756e74290a202020207072696e74286e65656455736530290a20202020696620746f6e756d626572286e6565645573653029203c2031207468656e0a20202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a202020202020202072657475726e20276661696c270a20202020656e640a202020206c6f63616c20637572526573756c74203d205f7472616e73666572546f467265657a656e287053796d626f6c2c6375724f776e65722c6e65656455736530290a20202020696620637572526573756c74203d3d20276661696c27207468656e0a20202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a202020202020202072657475726e20276661696c270a20202020656e640a0a2020202067466565506f6f6c203d2067466565506f6f6c202b20674665650a0a20202020674f726465725b674f7264657249445d203d207b7d0a20202020674f726465725b674f7264657249445d5b2775736572275d2020203d2067557365720a20202020674f726465725b674f7264657249445d5b276f776e6572275d20203d206375724f776e65720a20202020674f726465725b674f7264657249445d5b27646972656374275d203d2027627579270a20202020674f726465725b674f7264657249445d5b2773796d626f6c275d203d207053796d626f6c0a20202020674f726465725b674f7264657249445d5b27616d6f756e74275d203d2070416d6f756e740a20202020674f726465725b674f7264657249445d5b276e656564757365275d3d206e656564557365300a0a2020202067426f73735b7053796d626f6c5d5b27756e757365275d203d2067426f73735b7053796d626f6c5d5b27756e757365275d2d70416d6f756e740a202020200a20202020696620674f726465725b67557365725d203d3d206e696c207468656e0a2020202020202020674f726465725b67557365725d203d207b7d0a20202020656e640a202020207461626c652e696e7365727428674f726465725b67557365725d2c674f726465724944290a202020206c6f63616c2063757242726f6164203d207b7d0a202020205f616464526573756c742867557365722c27746f6b656e427579272c747275652c674f7264657249442c63757242726f6164290a202020205f616464526573756c74286375724f776e65722c27746f6b656e427579272c747275652c674f7264657249442c63757242726f6164290a20202020674f726465724944203d20737472696e672e666f726d6174282022252e3066222c674f7264657249442b3120290a2020202072657475726e206a736f6e2e656e636f64652863757242726f6164290a656e640a0a66756e6374696f6e20746f6b656e53656c6c287053796d626f6c2c70416d6f756e74290a202020206966207053796d626f6c203d3d20273027207468656e0a20202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a202020202020202072657475726e20276661696c270a20202020656e640a202020206c6f63616c206375724f776e657220203d2067426f73735b7053796d626f6c5d5b276f776e6572275d0a202020206966206375724f776e6572203d3d206755736572207468656e0a20202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a202020202020202072657475726e20276661696c270a20202020656e640a0a202020206966206742616c616e63655b67557365725d203c2067466565207468656e0a20202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a202020202020202072657475726e20276661696c270a20202020656e640a202020206c6f63616c206e6565645573653020203d20737472696e672e666f726d6174282022252e3266222c28312f67426f73735b7053796d626f6c5d5b2772617465275d292a70416d6f756e74290a202020207072696e74286e65656455736530290a20202020696620746f6e756d626572286e6565645573653029203c2031207468656e0a20202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a202020202020202072657475726e20276661696c270a20202020656e640a0a2020202069662067467265657a656e5b6375724f776e65725d203c20746f6e756d626572286e6565645573653029207468656e0a20202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a202020202020202072657475726e20276661696c270a20202020656e640a0a202020206742616c616e63655b67557365725d203d206742616c616e63655b67557365725d2d674665650a2020202067466565506f6f6c203d2067466565506f6f6c2b674665650a0a20202020674f726465725b674f7264657249445d203d207b7d0a20202020674f726465725b674f7264657249445d5b2775736572275d2020203d2067557365720a20202020674f726465725b674f7264657249445d5b276f776e6572275d20203d206375724f776e65720a20202020674f726465725b674f7264657249445d5b27646972656374275d203d202773656c6c270a20202020674f726465725b674f7264657249445d5b2773796d626f6c275d203d207053796d626f6c0a20202020674f726465725b674f7264657249445d5b27616d6f756e74275d203d2070416d6f756e740a20202020674f726465725b674f7264657249445d5b276e656564757365275d3d206e656564557365300a0a202020207072696e7428674f726465724944290a0a20202020696620674f726465725b67557365725d203d3d206e696c207468656e0a2020202020202020674f726465725b67557365725d203d207b7d0a20202020656e640a202020207461626c652e696e7365727428674f726465725b67557365725d2c674f726465724944290a202020206c6f63616c2063757242726f6164203d207b7d0a202020205f616464526573756c742867557365722c27746f6b656e53656c6c272c747275652c674f7264657249442c63757242726f6164290a202020205f616464526573756c74286375724f776e65722c27746f6b656e53656c6c272c747275652c674f7264657249442c63757242726f6164290a20202020674f726465724944203d20737472696e672e666f726d6174282022252e3066222c674f7264657249442b3120290a2020202072657475726e206a736f6e2e656e636f64652863757242726f6164290a656e640a0a66756e6374696f6e205f72656d6f76654f726465722870557365722c704f726465724944290a20202020674f726465725b674f7264657249445d203d206e696c0a20202020666f7220693d312c23674f726465725b70557365725d2c3120646f0a2020202020202020696620674f726465725b70557365725d5b695d203d3d20704f726465724944207468656e0a2020202020202020202020207072696e7428275f72656d6f76654f72646572272c692c704f726465724944290a2020202020202020202020207461626c652e72656d6f76652820674f726465725b70557365725d2c206920290a202020202020202020202020627265616b0a2020202020202020656e640a20202020656e640a656e640a0a66756e6374696f6e20746f6b656e436f6e6669726d28704f726465724944290a202020206c6f63616c206375724f72646572203d20674f726465725b704f7264657249445d0a202020206c6f63616c206375724f776e6572203d206375724f726465725b276f776e6572275d0a202020206c6f63616c2063757253796d626f6c3d206375724f726465725b2773796d626f6c275d0a202020206c6f63616c2063757242726f6164203d207b7d0a202020206966206375724f726465725b27646972656374275d203d3d202762757927207468656e0a20202020202020206966206755736572207e3d206375724f726465725b2775736572275d207468656e0a2020202020202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a20202020202020202020202072657475726e20276661696c270a2020202020202020656e640a20202020202020206c6f63616c20637572526573756c7431203d205f7472616e73666572546f42616c616e6365286375724f726465725b2773796d626f6c275d2c6375724f726465725b276f776e6572275d2c6375724f726465725b276f776e6572275d2c6375724f726465725b276e656564757365275d290a2020202020202020696620637572526573756c7431203d3d20276661696c27207468656e0a2020202020202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a20202020202020202020202072657475726e20276661696c270a2020202020202020656e640a20202020202020205f72656d6f76654f726465722867557365722c704f726465724944290a20202020202020205f616464526573756c742867557365722c27746f6b656e436f6e6669726d272c747275652c704f7264657249442c63757242726f6164290a20202020202020205f616464526573756c74286375724f776e65722c2767657442616c616e63654f66272c747275652c6742616c616e63655b6375724f776e65725d2c63757242726f6164290a202020202020202072657475726e206a736f6e2e656e636f64652863757242726f6164290a20202020656c7365206966206375724f726465725b27646972656374275d203d3d202773656c6c27207468656e0a20202020202020206966206755736572207e3d206375724f726465725b276f776e6572275d207468656e0a2020202020202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a20202020202020202020202072657475726e20276661696c270a2020202020202020656e640a202020202020202069662067426f73735b63757253796d626f6c5d5b27746f74616c275d203c2067426f73735b63757253796d626f6c5d5b27756e757365275d2b6375724f726465725b27616d6f756e74275d207468656e0a2020202020202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a20202020202020202020202072657475726e20276661696c270a2020202020202020656e640a20202020202020206c6f63616c20637572526573756c7432203d205f7472616e73666572546f42616c616e6365286375724f726465725b2773796d626f6c275d2c6375724f726465725b276f776e6572275d2c6375724f726465725b2775736572275d2c6375724f726465725b276e656564757365275d290a2020202020202020696620637572526573756c7432203d3d20276661696c27207468656e0a2020202020202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a20202020202020202020202072657475726e20276661696c270a2020202020202020656e640a0a202020202020202067426f73735b63757253796d626f6c5d5b27756e757365275d203d2067426f73735b63757253796d626f6c5d5b27756e757365275d2b6375724f726465725b27616d6f756e74275d0a20202020202020205f736574526174652863757253796d626f6c290a0a20202020202020205f72656d6f76654f72646572286375724f726465725b2775736572275d2c704f726465724944290a20202020202020205f616464526573756c74286375724f776e65722c27746f6b656e436f6e6669726d272c747275652c704f7264657249442c63757242726f6164290a20202020202020205f616464526573756c74286375724f726465725b2775736572275d2c2767657442616c616e63654f66272c747275652c6742616c616e63655b6375724f726465725b2775736572275d5d2c63757242726f6164290a202020202020202072657475726e206a736f6e2e656e636f64652863757242726f6164290a20202020656c73650a20202020202020207072696e742864656275672e676574696e666f2831292e63757272656e746c696e652c64656275672e676574696e666f2831292e6e616d65290a202020202020202072657475726e20276661696c270a20202020656e640a656e640a656e64$6e756c6c$1538114049318@18cee66a7de6f665dc71c5ef9233a0e93473df3bcfc91c278d06c5503ffaeb4ecdc2b75e74580ce53cd9dd91c217f64baf7e3833981884139638375c79690bc2@411CE7D7CD2679B9B95F7202025ADDD32FDAEF9ED722651FDD6AACDA576CA871371443A9A4C1323A77832ACD3E236E5871358A31DF638F203ADA90D72416A37D";
    return curBlock0;
}

void onnObject::makeBlock0(){
    QFile f("0.lua");
    f.open(QIODevice::ReadOnly);
    QByteArray curContract = f.readAll();
    f.close();
    QByteArray curData = doDeploy("0",curContract.toHex(),QByteArray("null").toHex());
    onnBlock curBlock = createBlock(0,0,getHash(curData).toHex(),curData);
    QFile f1("0");
    f1.open(QIODevice::WriteOnly);
    f1.write(toString(curBlock));
    f1.close();
}

void onnObject::initSleep(){
    qDebug() << "init ONN blockchain system";
    for(int i=0;i<45;i++){
        BUG << 45-i;
        QThread::sleep(1);
    }
}

void onnObject::initKey(){
    string curAppkey;
    QString curFile = "key.ini";
    if(!getArgument("-f").isEmpty()){
        curFile = getArgument("-f");
    }
    onnSetting = new QSettings(curFile,QSettings::IniFormat);
    if(hasAppkey()){
        onnObjectKey.appkey = onnSetting->value("appkey").toString().toLatin1();
        cout << "Enter your password" << endl;
        cin>>curAppkey;
        if(onnObjectKey.appkey != GETPSD(curAppkey.c_str())){
            cout << "password not correct" << endl;
            exit(-1);
        }
    }else{
        while(curAppkey.size()<6){
            curAppkey.clear();
            cout << "Enter a new password (length must be >= 6)" << endl;
            cin>>curAppkey;
        }
        onnObjectKey.appkey = GETPSD(curAppkey.c_str());
        onnSetting->setValue("appkey",onnObjectKey.appkey);
    }
    if(hasPubkey()){
        onnObjectKey.pubkey = onnSetting->value("pubkey").toString().toLatin1();
        onnObjectKey.prikey = Decrypt(GETSHA256(curAppkey.c_str()),onnSetting->value("prikey").toString().toLatin1());
    }else{
        makeKey(GETSHA256(curAppkey.c_str()));
    }
    onnObjectKey.address = GETADDR(onnObjectKey.pubkey);
    if(onnArgument.contains("-e")){
        cout << onnObjectKey.prikey.data() << endl;
        cout << onnObjectKey.pubkey.data() << endl;
        cout << GETADDR(onnObjectKey.pubkey).data() << endl;
        exit(1);
    }
    if(onnArgument.contains("-i")){
        onnSetting->setValue("prikey",Encrypt(GETSHA256(curAppkey.c_str()),onnArgument.value("-i").toLatin1()));
        onnSetting->setValue("pubkey",computePubkey(onnArgument.value("-i").toLatin1()));
        cout << GETADDR(computePubkey(onnArgument.value("-i").toLatin1())).data() << endl;
        onnSetting->sync();
        exit(1);
    }
}

QByteArray onnObject::computePubkey(QByteArray pPri){
    uint8_t pp[65] = {0};
    uECC_compute_public_key((uint8_t *)QByteArray::fromHex(pPri).data(),pp,uECC_secp256k1());
    QByteArray final = (char *)pp;
    return final.left(64).toHex();
}

bool onnObject::hasAppkey(){
    if (!onnSetting->contains("appkey")){
        return false;
    }
    return true;
}

void onnObject::updAppkey(QByteArray pKey){
    onnObjectKey.appkey = pKey;
    onnSetting->setValue("appkey",onnObjectKey.appkey);
}

bool onnObject::hasPubkey(){
    if (!onnSetting->contains("pubkey")){
        return false;
    }
    return true;
}

void onnObject::makeKey(QByteArray pHex){
    getkey();
    onnObjectKey.pubkey = getPublicKey();
    onnObjectKey.prikey = getPrivateKey();
    onnObjectKey.prikey = onnObjectKey.prikey.left(64);   //need use AES
    onnObjectKey.pubkey = computePubkey(onnObjectKey.prikey);
    onnSetting->setValue("pubkey",onnObjectKey.pubkey);
    onnSetting->setValue("prikey",Encrypt(pHex,onnObjectKey.prikey));
}

QByteArray onnObject::getSignature(QByteArray pMsg){
    QByteArray hash = GETSHA256(pMsg);
    sign(onnObjectKey.prikey.data(),hash.data());
    return QByteArray(getSign()).left(128);
}

QByteArray onnObject::getSignHash(QByteArray pHash){
    sign(onnObjectKey.prikey.data(),pHash.data());
    return QByteArray(getSign()).left(128);
}

QByteArray onnObject::getPubkey(){
    return onnObjectKey.pubkey;
}
QByteArray onnObject::getPrikey(){
    return onnObjectKey.prikey;
}
QByteArray onnObject::getAddress(){
    return onnObjectKey.address;
}

QByteArray onnObject::getHash(QByteArray pData){
    return QCryptographicHash::hash(pData,QCryptographicHash::Sha256);
}

bool onnObject::getVerify(QByteArray pub1,QByteArray msg1,QByteArray sig1){
    if(pub1.count()!=128 || sig1.count()!=128)return false;
    FieldElem x,y;
    Number msg,r,s;
    GroupElemJac pub;
    Signature sig;
    x.SetHex(pub1.left(64).data());
    y.SetHex(pub1.right(64).data());
    GroupElem aff(x,y);
    pub.SetAffine(aff);
    msg.SetHex(getHash(msg1).toHex().data());
    r.SetHex(sig1.left(64).data());
    s.SetHex(sig1.right(64).data());
    sig.SetRS(r,s);
    return sig.Verify(pub, msg);
}
/////////////////////////////////////////////////////////////////////////////////////////////
QString onnObject::getTaget(QString type,QString pubkey,QString name,QString code,QString arg,QString sig) {
    QString data = type + "$" + pubkey + "$" + name + "$" + code + "$" + arg;
    QString block = sig + "&" + data;
    return block;
}

QString onnObject::docmd(QString type,QString pubkey,QString prikey,QString name,QString func,QString arg) {
    QString msg = type + "$" + pubkey + "$" + name + "$" + func + "$" + arg;
    QByteArray hash = GETSHA256(msg.toLatin1());
    sign(prikey.toLatin1().data(),hash.data());
    QByteArray sig = getSign();
    sig = sig.left(128);
    QString block = getTaget(type, pubkey, name, func, arg, sig);
    return block;
}

QByteArray onnObject::doMethodGet(QString pContract,QString pMethod,QString pArg){
    QString block = pContract+"$"+pMethod+"$"+pArg+"$"+getPubkey();
    return block.toLatin1();
}
QByteArray onnObject::doMethodSet(QString pContract, QString pMethod, QString pArg){
    QString block = docmd("method",getPubkey(),getPrikey(),pContract,pMethod,pArg);
    return block.toLatin1();
}
QByteArray onnObject::doCustomSet(QString pType,QString pContract,QString pMethod,QString pArg){
    QString block = docmd(pType,getPubkey(),getPrikey(),pContract,pMethod,pArg);
    return block.toLatin1();
}
QByteArray onnObject::doDeploy(QString pContract,QString pCode,QString pArg){
    QString block = docmd("deploy",getPubkey(),getPrikey(),pContract,pCode,pArg);
    return block.toLatin1();
}
QByteArray onnObject::doHandlerGet(QByteArray pData){
    if(pData.contains("$")){
        pData.remove(0,1);
        return doMethodGet(pData);
    }
    if(pData.left(5) == "/help" || pData == "/favicon.ico"){
        QStringList helpInfo;
        helpInfo.append("/help");
        helpInfo.append("/list");
        helpInfo.append("/last + 0");
        helpInfo.append("/block + 0-0");
        helpInfo.append("/peers");
        helpInfo.append("/maker + contract");
        helpInfo.append("/boss + pub");
        helpInfo.append("/balance + contract,pub");
        helpInfo.append("/address");
        return helpInfo.join("\n").toLatin1();
    }
    if(pData == "/list"){
        return getContracts().join("\n").toLatin1();
    }
    if(pData.left(5) == "/last"){
        return toString(getBlock(pData.remove(0,5)));
    }
    if(pData.left(6) == "/block"){
        return getDatabaseBlock(pData.remove(0,6));
    }
    if(pData.left(6) == "/peers"){
        BUG << getPeerList();
        return getPeerList().join("\n").toLatin1();
    }
    if(pData.left(6) == "/maker"){
        return getBoss(pData.remove(0,6));
    }
    if(pData.left(5) == "/boss"){
        return getBossFromAddress(pData.remove(0,5)).join("\n");
    }
    if(pData.left(8) == "/balance"){
        return QByteArray::number(getContractBalance(pData.remove(0,8).split(',').first(),pData.remove(0,8).split(',').last()));
    }
    if(pData.left(8) == "/address"){
        return onnObjectKey.address;
    }
    pData.remove(0,1);
    return doMethodGet(pData);
}
////////////////////////////////////////////////////////////////////////////////////////
void onnObject::initArgv(int argc, char *argv[]){
    QString onnVersion = "0.9.1.4";
    if(argc>1){
        for(int i=1;i<argc;i=i+2){
            if(i+1>argc)
                break;
            onnArgument.insert(argv[i],argv[i+1]);
        }
    }
    if(onnArgument.contains("-h")){
        cout << "usage：ONN [option]" << endl;
        cout << "    -p     RPC listen port, default 3000" << endl;
        cout << "    -ws    websocket listen port, default 3001" << endl;
        cout << "    -i     import a private key, default use key.ini" << endl;
        cout << "    -e     export private key" << endl;
        cout << "    -t     set contract name, enable timer for run contract function _timeout()" << endl;
        cout << "    -s     set msec timer step when you use -t" << endl;
        cout << "    -v     show version" << endl;
        cout << "    -h     show this info" << endl;
        exit(1);
    }
    if(onnArgument.contains("-v")){
        cout << onnVersion.toStdString() << endl;
        exit(1);
    }
}

QString onnObject::getArgument(QString pKey){
    if(onnArgument.contains(pKey)){
        return onnArgument.value(pKey);
    }
    return "";
}
QString onnObject::getLocalIP(){
    QString ipAddr;
    QList<QHostAddress> AddressList = QNetworkInterface::allAddresses();
    for(QHostAddress address:AddressList){
        if(address.protocol() == QAbstractSocket::IPv4Protocol){
            if (address.toString().contains("127.0.")){
                continue;
            }
            return address.toString();
        }
    }
    return ipAddr;
}
void onnObject::setPeerList(QStringList pList){
    onnPeerList = pList;
}
void onnObject::setPeerLose(QStringList pList){
    onnPeerLose = pList;
}
QStringList onnObject::getPeerList(){
    return onnPeerList;
}
QStringList onnObject::getPeerLose(){
    return onnPeerLose;
}
QByteArray onnObject::calcHash(onnBlock pBlock){
    return getHash(pBlock.blockIndex+\
                              pBlock.blockTimestamp+\
                              pBlock.blockHashPrev+\
                              pBlock.blockData+\
                              pBlock.blockMaker).toHex();
}
void onnObject::setUdpClientList(QStringList pList){
    onnClientList = pList;
}
QStringList onnObject::getUdpClientList(){
    return onnClientList;
}
bool onnObject::hasUdpClientList(QString pAddress){
    return onnClientList.contains(pAddress);
}
//////////////////////////////////////////////////////////////////////////////////////////////////
void onnObject::initDatabase(){
    QString pFile = "db";
    if(!getArgument("-d").isEmpty()){
        pFile = getArgument("-d");
    }
    leveldb::Options options;
    options.create_if_missing = true;
    leveldb::Status status = leveldb::DB::Open(options, pFile.toLatin1().data(), &onnObjectDB);
    assert(status.ok());
}

QByteArray onnObject::getDatabaseBlock(QByteArray pKey){
    string value;
    leveldb::Status s;
    s = onnObjectDB->Get(leveldb::ReadOptions(), pKey.data(), &value);
    if(!s.ok()){
        return "null";
    }
    return value.c_str();
}
bool onnObject::setDatabaseBlock(QByteArray pKey,QByteArray pVar){
    leveldb::WriteOptions write_options;
    write_options.sync = true;
    leveldb::Status s = onnObjectDB->Put(leveldb::WriteOptions(), pKey.data(), pVar.data());
    if (!s.ok()){
        cout << "setData fail:" << pKey.data() << pVar.data() << endl;
    }
    return s.ok();
}
/////////////////////////////////////////////////////////////////////////////////////////////
void onnObject::insertBlock(QString pContract,onnBlock pBlock){
    onnBossBlock curBlock;
    if(onnBlockChain->contains(pContract)){
        curBlock = onnBlockChain->value(pContract);
    }else{
        curBlock.blockDeploy  = pBlock;
    }
    curBlock.name = pContract.toLatin1();
    curBlock.blockCurrent = pBlock;
    onnBlockChain->insert(pContract,curBlock);
}
onnBlock onnObject::getBlock(QString pContract){
    onnBlock curBlock;
    if(hasBlock(pContract.toLatin1()))
        return onnBlockChain->value(pContract).blockCurrent;
    return curBlock;
}
onnBossBlock onnObject::getBossBlock(QString pContract){
    onnBossBlock curBlock;
    if(hasBlock(pContract.toLatin1()))
        return onnBlockChain->value(pContract);
    return curBlock;
}
QByteArray onnObject::toString(onnBlock pBlock){
    return pBlock.blockIndex+"@"+pBlock.blockTimestamp+"@"+pBlock.blockHashPrev+"@"+pBlock.blockHash\
            +"@"+pBlock.blockData+"@"+pBlock.blockMaker+"@"+pBlock.blockMakerSign;
}

bool onnObject::hasBlock(QByteArray pKey){
    return onnBlockChain->contains(pKey);
}
onnBlock onnObject::createBlock(QByteArray pData){
    onnBlock curBlock;
    QList<QByteArray> data = pData.split('@');
    if(data.count()<7)
        return curBlock;
    curBlock.blockIndex = data.at(0);
    curBlock.blockTimestamp = data.at(1);
    curBlock.blockHashPrev = data.at(2);
    curBlock.blockHash = data.at(3);
    curBlock.blockData = data.at(4);
    curBlock.blockMaker = data.at(5);
    curBlock.blockMakerSign = data.at(6);
    return curBlock;
}
onnBlock onnObject::createBlock(qint64 pIndex,qint64 pTime,QString pHashPrev,QByteArray pData){
    onnBlock curBlock;
    curBlock.blockIndex = QByteArray::number(pIndex);
    curBlock.blockTimestamp = QByteArray::number(pTime);//QDateTime::currentMSecsSinceEpoch()
    curBlock.blockHashPrev = pHashPrev.toLatin1();
    curBlock.blockData = pData;
    curBlock.blockMaker = getPubkey();
    curBlock.blockHash = calcHash(curBlock);
    curBlock.blockMakerSign = getSignHash(curBlock.blockHash);
    return curBlock;
}
//////////////////////////////////////////////////////////////////////////////////////////
QString onnObject::doGetRandom(){
    QString result;
    _doMethodR(getContract("0"),"_doRand",QString::number(getPeerList().count()),getPubkey(),result);
    return result;
}
QString onnObject::doGetRandom(int pMax){
    QString result;
    _doMethodR(getContract("0"),"_doRand",QString::number(pMax),getPubkey(),result);
    return result;
}
bool onnObject::_doMethod(QString pContract,QString pFunction,QString pArg,QString pkey,QString &pResult){
    onnLock.lock();
    lua_State *luaInterface = getContract(pContract.toLatin1());
    if(!luaInterface){
        onnLock.unlock();
        pResult = "method fail: contract not exist";
        return false;
    }
    bool curResult = _doMethod(luaInterface,pFunction,pArg,pkey,pResult);
    onnLock.unlock();
    return curResult;
}
bool onnObject::_doMethod(lua_State *luaInterface,QString pFunction,QString pArg,QString pkey,QString &ret){
    QString _setUser = "_setUser\0";
    lua_getglobal(luaInterface, _setUser.toLatin1().data());
    lua_pushstring(luaInterface, pkey.toLatin1().data());
    if(lua_pcall(luaInterface, 1, 1, 0) != 0){
        BUG << "error _setUser" << lua_tostring(luaInterface,-1);
        ret = QString("error lua_pcall _setUser ")+QString(__LINE__)+","+pFunction+","+pArg+","+pkey;
        onnGas = lua_getGas();
        lua_resetGas();
        return false;
    }

    lua_settop(luaInterface,0);

    int arglen = 0;
    lua_getglobal(luaInterface, pFunction.toLatin1().data());
    if(pArg == "null"){
        arglen = 0;
    }else if(!pArg.contains("?")){
        arglen = 1;
        lua_pushstring(luaInterface, pArg.toLatin1().data());
    }else{
        auto curArg = pArg.split("?");
        arglen = curArg.count();
        for(int i=0;i<arglen;i++){
            lua_pushstring(luaInterface, curArg.at(i).toLatin1().data());
        }
    }
    //PrintLuaStack(luaInterface);
    if(lua_pcall(luaInterface, arglen, 1, 0) != 0){
        BUG << "error lua_pcall" << pFunction << pArg << lua_tostring(luaInterface,-1);;
        ret = QString("error lua_pcall _setUser ")+QString(__LINE__)+","+pFunction+","+pArg+","+pkey;
        onnGas = lua_getGas();
        lua_resetGas();
        return false;
    }
    if(lua_isstring(luaInterface, 1)){
        ret = lua_tostring(luaInterface, 1);
    }else if(lua_isinteger(luaInterface, 1) || lua_isnumber(luaInterface, 1)){
        ret = QString::number(lua_tointeger(luaInterface, 1));
    }else if(lua_isnumber(luaInterface, 1)){
        ret = QString::number(lua_tonumber(luaInterface, 1));
    }else{
        ret = "null";
    }
    onnGas = lua_getGas();
    lua_resetGas();
    lua_settop(luaInterface,0);
    //BUG << pFunction << onnGas;
    if(ret.left(4) == "fail")
        return false;
    return true;
}
bool onnObject::_doMethodW(lua_State *luaInterface,QString pFunction,QString pArg,QString pkey,QString &ret){
    //onnRWlock.lockForWrite();
    onnLock.lock();
    bool result = _doMethod(luaInterface,pFunction,pArg,pkey,ret);
    onnLock.unlock();
    //onnRWlock.unlock();
    return result;
}
bool onnObject::_doMethodR(lua_State *luaInterface,QString pFunction,QString pArg,QString pkey,QString &ret){
    //onnRWlock.lockForRead();
    onnLock.lock();
    bool result = _doMethod(luaInterface,pFunction,pArg,pkey,ret);
    onnLock.unlock();
    //onnRWlock.unlock();
    return result;
}
QByteArray onnObject::doMethodGet(QByteArray pMsg){
    //BUG << pMsg;
    QList<QByteArray> msgList = pMsg.split('$');
    if(msgList.count()<4){
        QString lc = "msgList.count()<4";
        return lc.toLatin1();
    }
    QString contract = msgList.at(0);
    QString method = msgList.at(1);
    QString arg = msgList.at(2);
    QString pkey = msgList.at(3);
    QString result;
    if(method.left(3) != "get"){
        QString lc = "method fail: only use get method";
        return lc.toLatin1();
    }
//    if(!hasContract(contract.toLatin1())){
//        QString lc = "method fail: contract not exist";
//        return lc.toLatin1();
//    }
    _doMethod(contract,method,QByteArray::fromHex(arg.toLatin1()),pkey,result);
    return result.toLatin1();
}
/////////////////////////////////////////////////////////////////////////////////////////////
void onnObject::addContract(QByteArray pContract,lua_State *&pInterface){
    onnReadableContract.append(pContract);
    onnObjectContract->insert(pContract,pInterface);
}

bool onnObject::hasContract(QByteArray pContract){
    return onnObjectContract->contains(pContract);
}

lua_State *onnObject::getContract(QByteArray pContract){
    return onnObjectContract->value(pContract);
}
QStringList onnObject::getContracts(){
    return onnObjectContract->keys();
}
QString onnObject::getContractOrigin(){
    QFile f("0.lua");
    f.open(QIODevice::ReadOnly);
    QByteArray data = f.readAll();
    f.close();
    return data;
}
bool onnObject::checkBlockIndexAndHash(QString pName,onnBlock curBlock){
    if(!hasContract("0")){
        return true;
    }
    if(curBlock.blockIndex.toLongLong()<=getBlock(pName).blockIndex.toLongLong()){
        BUG << "msg fail: curBlock.blockIndex<=getBlock(pName).blockIndex" << pName;
        return false;
    }else if(curBlock.blockIndex.toLongLong()>getBlock(pName).blockIndex.toLongLong()+1){
        BUG << "msg fail: curBlock.blockIndex>getBlock(pName).blockIndex+1" << curBlock.blockIndex << getBlock(pName).blockIndex;
        return false;
    }

    if(curBlock.blockHashPrev != getBlock(pName).blockHash){
        BUG << "msg fail: curBlock.blockHashPrev != getBlock(pName).blockHash" << pName;
        return false;
    }

    if(getBoss(pName.toLatin1()) != GETADDR(curBlock.blockMaker)){
        BUG << "msg fail: getBoss(pName.toLatin1()) != GETADDR(curBlock.blockMaker)" << pName;
        return false;
    }
    return true;
}
bool onnObject::checkBlockIndexAndHashDeploy(QString pName,onnBlock prvBlock,onnBlock curBlock){
    if(!hasContract("0")){
        return true;
    }
    if(curBlock.blockIndex.toLongLong()<=prvBlock.blockIndex.toLongLong()){
        BUG << "msg fail: curBlock.blockIndex<=prvBlock.blockIndex" << pName;
        return false;
    }else if(curBlock.blockIndex.toLongLong()>prvBlock.blockIndex.toLongLong()+1){
        BUG << "msg fail: curBlock.blockIndex>prvBlock.blockIndex+1" << curBlock.blockIndex << getBlock(pName).blockIndex;
        return false;
    }

    if(curBlock.blockHashPrev != prvBlock.blockHash){
        BUG << "msg fail: curBlock.blockHashPrev != prvBlock.blockHash" << pName;
        return false;
    }

    if(getBoss("0") != GETADDR(curBlock.blockMaker)){
        BUG << "msg fail: curIdentityPubkey 0 != GETADDR(curBlock.blockMaker)" << pName;
        return false;
    }
    return true;
}
bool onnObject::checkBlockNewIdentity(QString pName, QByteArray pData){
    QByteArray curBoss = getBoss(pName.toLatin1());
    if(curBoss.isEmpty()){
        return false;
    }
    if(curBoss != onnObjectKey.address){
        BUG << "send to boss" << pName << getBoss(pName.toLatin1());
        //emit doSendBlockChainData(pName,curIdentityPubkey,pData);
        emit doCustomRequire(pName,getBoss(pName.toLatin1()),"newblock",pData);
        return false;
    }
    return true;
}
//////////////////////////////////////////////////////////////////////////////////////////////
void onnObject::setBoss(QByteArray pContract,QByteArray pAddress){
    BUG << pContract << pAddress;
    if(onnBoss.contains(pContract)){
        rmBossFromAddress(onnBoss.value(pContract));
    }
    onnBoss.insert(pContract,pAddress);
    onnBossforAddress.insert(pAddress,pContract);
}
QByteArray onnObject::getBoss(QByteArray pContract){
    return onnBoss.value(pContract);
}
void onnObject::rmBoss(QByteArray pContract){
    onnBoss.remove(pContract);
}
void onnObject::rmBossFromAddress(QByteArray pAddress){
    onnBossforAddress.remove(pAddress);
}
QByteArrayList onnObject::getBossFromAddress(QByteArray pAddress){
    return onnBossforAddress.values(pAddress);
}
QByteArrayList onnObject::getBossAddressList(){
    return onnBoss.values();
}
QStringList onnObject::getBossLose(QStringList pLose){
    QStringList result;
    QByteArrayList curBossList = onnBoss.values();
    for(auto curAddress:pLose){
        if(curBossList.contains(curAddress.toLatin1())){
            if(!result.contains(curAddress)){
                result.append(curAddress);
            }
        }
    }
    return result;
}
QByteArrayList onnObject::getBossMissing(QStringList pList){
    QByteArrayList curBossList = onnBoss.values();
    for(auto curAddress:pList){
        if(curBossList.contains(curAddress.toLatin1())){
            curBossList.removeAll(curAddress.toLatin1());
        }
    }
    return curBossList;
}
QByteArrayList onnObject::getBossMissingContracts(){
    QByteArrayList result;
    QStringList curContracts = getContracts();
    for(auto curContract:curContracts){
        QByteArray curMaker = getBoss(curContract.toLatin1());
        if(!getPeerList().contains(curMaker)){
            result.append(curContract.toLatin1());
        }
    }
    return result;
}
QStringList onnObject::getOnlyWork(QStringList pList){
    QStringList result;
    QByteArrayList curBossList = getBossAddressList();
    for(auto curAddress:pList){
        if(!curBossList.contains(curAddress.toLatin1())){
            result.append(curAddress);
        }
    }
    return result;
}
//////////////////////////////////////////////////////////////////////////////////////////////
void onnObject::initNetSync(){
    initSleep();
    QSettings curSet("nettime.ini",QSettings::IniFormat);
    QString curVar = QString::number(QDateTime::currentSecsSinceEpoch());
    curSet.setValue("nettime",curVar);
    onnSync = new NetSync();
    onnSync->Init(GETADDR(getPubkey()));
}
NetSync *onnObject::getNetSync(){
    return onnSync;
}
////////////////////////////////////////////////////////////////////////////////////////////////
void onnObject::initWebsocketd(){
    onnWebsocket = new Hub();
    onnWebsocket->onConnection([&](uWS::WebSocket<uWS::SERVER> *ws, HttpRequest) {
        cout << ws->getAddress().address << endl;
        if(onnWebsocketAddress.contains(ws->getAddress().address)){
            ws->close();
        }else{
            onnWebsocketAddress.append(ws->getAddress().address);
            onnWebsocketPeers.append(QByteArray(ws->getAddress().address).remove(0,7)+":"+QByteArray::number(ws->getAddress().port));
        }
    });
    onnWebsocket->onDisconnection([&](uWS::WebSocket<uWS::SERVER> *ws, int, char *, size_t) {
        onnWebsocketAddress.removeAll(ws->getAddress().address);
        onnWebsocketPeers.removeAll(QByteArray(ws->getAddress().address)+":"+QByteArray::number(ws->getAddress().port));
    });
}
Hub *onnObject::getWebsocketd(){
    return onnWebsocket;
}
//////////////////////////////////////////////////////////////////////////////////////////////
void onnObject::setSyncQueue(QByteArray pContract,QByteArray pAddress,QByteArray pKey,QByteArray pStart,QByteArray pEnd){
    onnSyncQueue queue;
    queue.blockContract = pContract;
    queue.blockAddress = pAddress;
    queue.blockStart = pStart;
    queue.blockEnd = pEnd;
    queue.blockLastModify = QDateTime::currentMSecsSinceEpoch();
    if(pKey=="request"){
        onnSyncRequestCount++;
        onnSyncRequest.insert(pContract+"-"+pAddress+"-"+pKey,queue);
    }else if(pKey=="response"){
        onnSyncResponseCount++;
        onnSyncResponse.insert(pContract+"-"+pAddress+"-"+pKey,queue);
    }
    //onnSyncData.insert(pContract+"-"+pAddress+"-"+pKey,queue);
}
bool onnObject::updSyncQueueIndex(QByteArray pContract,QByteArray pAddress,QByteArray pKey,QByteArray pIndex){
    onnSyncQueue curData;// = onnSyncData.value(pContract+"-"+pAddress+"-"+pKey);
    if(pKey=="request"){
        curData = onnSyncRequest.value(pContract+"-"+pAddress+"-"+pKey);
    }else if(pKey=="response"){
        curData = onnSyncResponse.value(pContract+"-"+pAddress+"-"+pKey);
    }
    if(curData.blockCurrentIndex.toLongLong()<pIndex.toLongLong()){
        curData.blockCurrentIndex = pIndex;
        curData.blockLastModify = QDateTime::currentMSecsSinceEpoch();
    }else{
        return true;
    }
    if(pKey=="request"){
        onnSyncRequest.insert(pContract+"-"+pAddress+"-"+pKey,curData);
    }else if(pKey=="response"){
        onnSyncResponse.insert(pContract+"-"+pAddress+"-"+pKey,curData);
    }
    //onnSyncData.insert(pContract+"-"+pAddress+"-"+pKey,curData);
    if(pIndex.toLongLong()>=curData.blockEnd.toLongLong()){
        return false;
    }else{
        return true;
    }
}
onnSyncQueue onnObject::getSyncQueue(QByteArray pContract,QByteArray pAddress,QByteArray pKey){
    if(hasSyncQueue(pContract,pAddress,pKey)){
        if(pKey=="request"){
            return onnSyncRequest.value(pContract+"-"+pAddress+"-"+pKey);
        }else if(pKey=="response"){
            return onnSyncResponse.value(pContract+"-"+pAddress+"-"+pKey);
        }
        //return onnSyncData.value(pContract+"-"+pAddress+"-"+pKey);
    }
    return onnSyncQueue();
}
onnSyncQueue onnObject::getSyncQueue(QStringList pList){
    QByteArray pContract = pList.at(0).toLatin1();
    QByteArray pAddress = pList.at(1).toLatin1();
    QByteArray pKey = pList.at(2).toLatin1();
    if(hasSyncQueue(pContract,pAddress,pKey)){
        if(pKey=="request"){
            return onnSyncRequest.value(pContract+"-"+pAddress+"-"+pKey);
        }else if(pKey=="response"){
            return onnSyncResponse.value(pContract+"-"+pAddress+"-"+pKey);
        }
        //return onnSyncData.value(pContract+"-"+pAddress+"-"+pKey);
    }
    return onnSyncQueue();
}
QList<onnSyncQueue> onnObject::getSyncQueueList(QByteArray pContract,QByteArray pType){
    QList<onnSyncQueue> result;
    for(auto curData:onnSyncRequest.keys()){
        QStringList curLiist = curData.split("-");
        if(curLiist.first() == pContract && curLiist.last() == pType && curLiist.count() == 3){
            result.append(getSyncQueue(curLiist));
        }
    }
    return result;
}
bool onnObject::hasSyncQueueRequest(QByteArray pContract){
    for(auto curData:onnSyncRequest.keys()){
        if(curData.split("-").first() == pContract){
            return true;
        }
    }
    return false;
}
bool onnObject::hasSyncQueue(QByteArray pContract,QByteArray pAddress,QByteArray pKey){
    if(pKey=="request"){
        if(onnSyncRequest.contains(pContract+"-"+pAddress+"-"+pKey)){
            return true;
        }
    }else if(pKey=="response"){
        if(onnSyncResponse.contains(pContract+"-"+pAddress+"-"+pKey)){
            return true;
        }
    }
//    if(onnSyncData.contains(pContract+"-"+pAddress+"-"+pKey)){
//        return true;
//    }
    return false;
}
void onnObject::rmSyncQueue(QByteArray pContract,QByteArray pAddress,QByteArray pKey){
    //onnSyncData.remove(pContract+"-"+pAddress+"-"+pKey);
    if(pKey=="request"){
        onnSyncRequestCount--;
        onnSyncRequest.remove(pContract+"-"+pAddress+"-"+pKey);
    }else if(pKey=="response"){
        onnSyncResponseCount--;
        onnSyncResponse.remove(pContract+"-"+pAddress+"-"+pKey);
    }
}
void onnObject::rmSyncLose(QStringList pLose){
    for(auto curAddress:pLose){
        for(auto curContract:getContracts()){
            if(hasSyncQueue(curContract.toLatin1(),curAddress.toLatin1(),QString("request").toLatin1())){
                rmSyncQueue(curContract.toLatin1(),curAddress.toLatin1(),QString("request").toLatin1());
            }
            if(hasSyncQueue(curContract.toLatin1(),curAddress.toLatin1(),QString("response").toLatin1())){
                rmSyncQueue(curContract.toLatin1(),curAddress.toLatin1(),QString("response").toLatin1());
            }
        }
    }
}
int onnObject::getSyncRequestCount(){
    return onnSyncRequestCount;
}
int onnObject::getSyncResponseCount(){
    return onnSyncResponseCount;
}
//////////////////////////////////////////////////////////////////////////////////////////////
void onnObject::appendChangeBossRequest(QByteArray pBoss, QByteArray pData){
    onnChangeBossData.insertMulti(pBoss,pData);
}
bool onnObject::hasChangeBossRequest(QByteArray pBoss){
    return onnChangeBossData.contains(pBoss);
}
bool onnObject::hasChangeBossWorkerRequest(QByteArray pRequest){
    if(!onnChangeBossData.isEmpty())
        return onnChangeBossData.values().contains(pRequest);
    return false;
}
QByteArrayList onnObject::getChangeBossRequest(QByteArray pBoss){
    if(onnChangeBossData.contains(pBoss)){
        return onnChangeBossData.values(pBoss);
    }
    return QByteArrayList();
}
void onnObject::rmChangeBossRequest(QByteArray pBoss){
    onnChangeBossData.remove(pBoss);
}
double onnObject::getContractBalance(QByteArray pContract,QByteArray pAddress){
    if(!hasContract(pContract)){
        return 0;
    }
    QString result;
    if(_doMethodR(getContract(pContract),"_getBalanceOf",pAddress,pAddress,result)){
        if(result=="fail")
            return 0;
        return result.toDouble();
    }
    return 0;
}
double onnObject::getOnnBalance(QByteArray pAddr){
    QString result;
    if(_doMethodR(getContract("0"),"_getBalanceOf",pAddr,pAddr,result)){
        return result.toDouble();
    }
    return 0;
}
QByteArray onnObject::getOnnBossOwner(QByteArray pBoss){
    QString result;
    if(!hasContract(pBoss)){
        return "";
    }
    if(_doMethodR(getContract(pBoss),"_getOwner","null",onnObjectKey.address,result)){
        return result.toLatin1();
    }
    return "";
}
QByteArray onnObject::getOnnBossTotal(QByteArray pSymbol){
    QString result;
    if(!hasContract(pSymbol)){
        return "fail";
    }
    if(_doMethodR(getContract(pSymbol),"_getTotal","null",onnObjectKey.address,result)){
        return result.toLatin1();
    }
    return "fail";
}
QByteArray onnObject::getOnnBossMaker(QByteArray pSymbol){
    QString result;
    if(!hasContract(pSymbol)){
        return "fail";
    }
    if(_doMethodR(getContract(pSymbol),"getBossMaker",pSymbol,onnObjectKey.address,result)){
        return result.toLatin1();
    }
    return "fail";
}
QByteArray onnObject::setOnnBossMaker(QByteArray pSymbol, QByteArray pAddress){
    QString result;
    if(!hasContract(pSymbol)){
        return "fail";
    }
    if(_doMethodW(getContract(pSymbol),"setBossMaker",pSymbol+"?"+pAddress,onnObjectKey.address,result)){
        setBoss(pSymbol,pAddress);
        return result.toLatin1();
    }
    return "fail";
}
QString onnObject::setNextBoss(QString pArg){
    QString curResult;
    _doMethodW(getContract("0"),"_setNextBoss",pArg,onnObjectKey.address,curResult);
    if(curResult.isEmpty() || curResult.left(4) == "fail"){
        BUG << curResult;
        curResult = "fail";
    }
    return curResult;
}
QString onnObject::setDeployBoss(QString pArg, QString pKey){
    QString curResult;
    if(!_doMethodW(getContract("0"),"_setDeployBoss",pArg,pKey,curResult)){
        BUG << "fail";
        return "fail";
    }
    if(curResult.isEmpty() || curResult.left(4) == "fail"){
        BUG << curResult;
        curResult = "fail";
    }
    return curResult;
}
QString onnObject::setPeers(){
    QString curResult;
    _doMethodW(getContract("0"),"_setPeers",getPeerList().join(","),onnObjectKey.address,curResult);
    return curResult;
}
QByteArray onnObject::doOnnTransfer(QByteArray pSender,QByteArray pRecver,QByteArray pNumber){
    QString result;
    if(!hasContract("0")){
        return "fail";
    }
    if(_doMethodW(getContract("0"),"transfer",pRecver+"?"+pNumber,pSender,result)){
        return result.toLatin1();
    }
    return "fail";
}
bool onnObject::doOnnDestroy(QString pSymbol,QString pKey){
    QString result;
    if(!hasContract(pSymbol.toLatin1())){
        return false;
    }
    return _doMethodW(getContract(pSymbol.toLatin1()),"_destroy",pSymbol,pKey,result);
}
QMultiMap<qint64,QString> onnObject::getOnnBalanceUserList(QStringList pList){
    QMultiMap<qint64,QString> result;
    for(auto curAddr:pList){
        double curBalance = getOnnBalance(curAddr.toLatin1());
        result.insertMulti(curBalance,curAddr);
    }
    return result;
}
QStringList onnObject::getHaveBalanceWorker0(QStringList pList,qint64 pNumber){
    QStringList result;
    for(auto curPeer:pList){
        if(getOnnBalance(curPeer.toLatin1())<(double)pNumber){
            continue;
        }
        result.append(curPeer);
    }
    return result;
}
bool onnObject::checkCustomNetData(QByteArray pData, QByteArray pType, onnData &pResult){
    QList<QByteArray> listCmd = pData.split('&');
    if(listCmd.count()<2){
        BUG << "bad data: listCmd.count()<2" << pData;
        return false;
    }
    QByteArray sign = listCmd.at(0);
    QByteArray data = listCmd.at(1);
    QList<QByteArray> listData = data.split('$');
    if(listData.count()<5){
        BUG << "bad data: listData.count()<5" << pData;
        return false;
    }

    QByteArray type = listData.at(0);
    QByteArray pubkey = listData.at(1);
    QByteArray name = listData.at(2);
    QByteArray code = listData.at(3);
    QByteArray arg  = listData.at(4);

    if(!getVerify(pubkey,data,sign)){
        BUG << "msg fail: verify fail";
        return false;
    }

    if(!hasBlock(name)){
        BUG << "msg fail: !hasBlock(name)";
        return false;
    }

    if(type != pType){
        BUG << "msg fail: type !=" << pType;
        return false;
    }
    pResult.blockPubkey = pubkey;
    pResult.blockContract = name;
    pResult.blockType = pType;
    pResult.blockTarget = arg;
    onnBlock curBlock;
    curBlock.blockData = pData;
    pResult.block = curBlock;

    return true;
}
//////////////////////////////////////////////////////////////////////////////////////////////
void onnObject::onBlockOld(QByteArray pData){
    BUG;
    onnBlock curBlock = createBlock(pData);
    QByteArray curData = curBlock.blockData;

    QList<QByteArray> listCmd = curData.split('&');
    if(listCmd.count()<2){
        BUG << "bad data: listCmd.count()<2" << pData;
        return;
    }
    QByteArray sign = listCmd.at(0);
    QByteArray data = listCmd.at(1);
    QList<QByteArray> listData = data.split('$');
    if(listData.count()<5){
        BUG << "bad data: listData.count()<5" << pData;
        return;
    }

    QByteArray tgtData = "$";
    tgtData = tgtData+listData.at(listData.count()-2)+"$"+listData.last();
    data.remove(data.count()-tgtData.count(),tgtData.count());

    QByteArray type = listData.at(0);
    QByteArray pubkey = listData.at(1);
    QByteArray name = listData.at(2);
    QByteArray code = listData.at(3);
    QByteArray arg = QByteArray::fromHex(listData.at(4));
    QByteArray maker = curBlock.blockMaker;
    QByteArray makerSign = curBlock.blockMakerSign;
    QByteArray curBlockData =  onnObject::getHash(curBlock.blockIndex+\
                                                  curBlock.blockTimestamp+\
                                                  curBlock.blockHashPrev+\
                                                  curBlock.blockData+\
                                                  curBlock.blockMaker).toHex();
    BUG << curBlock.blockIndex << pubkey << data << sign;
    if(code == "init"){
        BUG << "bad block old: can not call init" << name;
        return;
    }
    if(getVerify(pubkey,data,sign)){
        BUG << "msg fail: verify fail" << pData;
        return;
    }

    if(getVerify(maker,curBlockData,makerSign)){
        BUG << "msg fail: maker verify fail" << pData;
        return;
    }

    if(type == "deploy"){
        if(hasBlock(name)){
            BUG << "bad deploy: contract exist" << name;
            return;
        }
        emit doDeployOld(pData);
    }else if(type == "method"){
        if(!hasBlock(name)){
            BUG << "bad method: contract not exist" << name;
            return;
        }
        if(code.left(3) == "get" || code.left(1) == "_"){
            BUG << "bad method: can not run private or get" << code ;
            return;
        }
        emit doMethodOld(pData);
    }else if(type == "peer"){
        if(!getBossFromAddress(GETADDR(maker)).contains("0")){
            BUG << "bad 0: maker != 0" << maker ;
            return;
        }
        emit doPeerOld(pData);
    }else if(type == "destroy"){
        if(!hasContract(name)){
            BUG << "bad destroy: contract not exist" << name;
            return;
        }
        if(maker != getBoss("0")){
            BUG << "bad destroy: maker != boss 0" << maker << getBoss("0");
            return;
        }
        emit doDestroyOld(pData);
    }else{
        BUG << "unknow type" << type;
    }
}
void onnObject::onDestroyOld(QByteArray pData){
    onnBlock curBlock = createBlock(pData);
    if(flagStart){
        QByteArray curHash = GETSHA256(curBlock.blockData);
        if(getDatabaseBlock(curHash) != "null"){
            BUG << "bad destroy old: hash data exist" << curHash;
            return;
        }else{
            setDatabaseBlock(curHash,curHash);
        }
    }
    QList<QByteArray> pList = curBlock.blockData.split('$');
    QString name = pList.at(2);
    QString codeHex = pList.at(3);
    QString arg = QByteArray::fromHex(pList.at(4));
    QString key = GETADDR(pList.at(1));
    if(!hasContract(name.toLatin1())){
        BUG << "bad destroy: contract not exist" << name;
        return;
    }
    if(!doOnnDestroy(name,key)){
        BUG << "doOnnDestroy fail";
        return;
    }
    lua_State *curContract = getContract(arg.toLatin1());
    lua_close(curContract);
    onnObjectContract->remove(arg);
    rmBoss(arg.toLatin1());
    insertBlock("0",curBlock);
    emit doDestroyOldOK(pData);
}
void onnObject::onDeployOld(QByteArray pData){
    onnBlock curBlock = createBlock(pData);
    if(flagStart){
        QByteArray curHash = GETSHA256(curBlock.blockData);
        if(getDatabaseBlock(curHash) != "null"){
            BUG << "bad deploy old: hash data exist" << curHash;
            return;
        }else{
            setDatabaseBlock(curHash,curHash);
        }
    }
    QList<QByteArray> pList = curBlock.blockData.split('$');
    QString name = pList.at(2);
    QString codeHex = pList.at(3);
    QString arg = QByteArray::fromHex(pList.at(4));
    QString key = GETADDR(pList.at(1));
    if(GETADDR(curBlock.blockMaker) != getBoss("0") && !getBoss("0").isEmpty()){
        if(name.count()<3 || name.count()>8){
            BUG << "bad deploy: name.count()<3 || name.count()>8" << name;
            return;
        }
    }
    if(hasContract(name.toLatin1())){
        BUG << "bad deploy: contract exist" << pData;
        return;
    }
    if(!checkBlockIndexAndHashDeploy(name,getBlock("0"),curBlock)){
        return;
    }
    QString code;
    if(codeHex.contains("i")){
        code = codeHex;
    }else{
        code = QByteArray::fromHex(codeHex.toLatin1());
    }
    if(code.contains("_G") && name != "0"){
        BUG << "bad deploy: contains _G" << name;
        return;
    }
    QString codeCost = QString::number(code.count()*2);
    //code.push_front(contractHead);
    lua_State *luaInterface = luaL_newstate();
    luaL_openlibs1(luaInterface);
    luaL_dostring(luaInterface,code.toLatin1().data());
    QString result;
    QString resultInit;
    if(!_doMethodW(luaInterface,"init",arg,key,resultInit)){
        lua_close(luaInterface);
        return;
    }
    QString curTotal;
    if(_doMethodR(luaInterface,"_getTotal","null",onnObjectKey.address,result)){
        curTotal = result;
    }else{
        curTotal = "0";
        BUG << "_getTotal fail" << result;
        lua_close(luaInterface);
        return;
    }
    if(!getContracts().isEmpty()){
        //result = setDeployBoss(name+"?10000?"+curTotal+"?"+codeCost,key);
        if(_doMethodW(getContract("0"),"_setDeployBoss",name+"?10000?"+curTotal+"?"+codeCost,key,result)){
            BUG << "setDeployBoss ok";
            setBoss(name.toLatin1(),result.toLatin1());
        }else{
            BUG << "setDeployBoss fail" << result;
            lua_close(luaInterface);
            return;
        }
    }
    if(flagStart && !resultInit.isEmpty() && resultInit != "null"){
        BUG << "doBroadcastAppNew" << resultInit;
        emit doBroadcastAppNew(resultInit.toLatin1());
    }
    if(getContracts().isEmpty()){
        setBoss("0",key.toLatin1());
    }
    emit doSetBossList(getBossAddressList());
    addContract(name.toLatin1(),luaInterface);
    insertBlock("0",curBlock);
    insertBlock(name.toLatin1(),curBlock);
    emit doDeployOldOK(name.toLatin1(),pData);
}
void onnObject::onMethodOld(QByteArray pData){
    onnBlock curBlock = createBlock(pData);
    QList<QByteArray> pList = curBlock.blockData.split('$');
    QString name = pList.at(2);
    if(flagStart){
        QByteArray curHash = GETSHA256(curBlock.blockData);
        if(getDatabaseBlock(curHash) != "null"){
            BUG << "bad method old: hash data exist" << curHash;
            emit doContractOldFail(name.toLatin1());
            return;
        }else{
            setDatabaseBlock(curHash,curHash);
        }
    }
    QString code = pList.at(3);
    QString arg = QByteArray::fromHex(pList.at(4));
    QString key = GETADDR(pList.at(1));
    QString result;
    if(!checkBlockIndexAndHash(name,curBlock)){
        BUG << "checkBlockIndexAndHash fail";
        emit doContractOldFail(name.toLatin1());
        return;
    }
    if(_doMethodW(getContract(name.toLatin1()),code,arg,key,result)){
        insertBlock(name.toLatin1(),curBlock);
        emit doMethodOldOK(name.toLatin1(),pData);
        if(flagStart){
            if(!result.isEmpty() && result != "null"){
                emit doBroadcastAppNew(result.toLatin1());
            }
        }else{
            if(!result.isEmpty() && result != "null"){
                emit doBroadcastAppOld(result.toLatin1());
            }
        }
    }else{
        BUG << "_doMethodW fail";
        emit doContractOldFail(name.toLatin1());
    }
}
void onnObject::onPeerOld(QByteArray pData){
    //BUG << pData;
    onnBlock curBlock = createBlock(pData);
    if(flagStart){
        QByteArray curHash = GETSHA256(curBlock.blockData);
        if(getDatabaseBlock(curHash) != "null"){
            BUG << "bad peer old: hash data exist" << curHash;
            return;
        }else{
            setDatabaseBlock(curHash,curHash);
        }
    }
    if(!checkBlockIndexAndHash("0",curBlock)){
        return;
    }
    QList<QByteArray> pList = curBlock.blockData.split('$');
    QByteArray arg = QByteArray::fromHex(pList.at(4));
    if(arg.contains('?')){
        QByteArrayList argList = arg.split('?');
        setPeerList(QString(argList.at(0)).split(","));
        setPeerLose(QString(argList.at(1)).split(","));
    }else{
        setPeerList(QString(arg).split(","));
    }
    setPeers();
    QByteArrayList curContractList = getBossMissingContracts();
    if(!curContractList.isEmpty())
        onBossMissing(curContractList);
    insertBlock("0",curBlock);
    emit doPeerOldOK(pData);
}
QStringList onnObject::getReadableContract(){
    return onnReadableContract;
}
bool onnObject::doFinishReadable(QString pContract){
    onnReadableContract.removeAll(pContract);
    QString curReadableContract;
    onnBlock prvBlock;
    onnBlock curBlock;
    QByteArray curValue;
    if(onnReadableContract.isEmpty()){
        flagStart = true;
        emit doStartFinish();
        return true;
    }else{
        while(!onnReadableContract.isEmpty()){
            onnBossBlock curBossBlock = getBossBlock(onnReadableContract.first());
            curReadableContract = curBossBlock.name;
            prvBlock = curBossBlock.blockDeploy;
            curValue = getDatabaseBlock(curBossBlock.name+"-"+QByteArray::number(prvBlock.blockIndex.toLongLong()+1));
            if(curValue == "null"){
                onnReadableContract.removeAll(curBossBlock.name);
            }else{
                curBlock = createBlock(curValue);
                break;
            }
        }
        if(onnReadableContract.isEmpty()){
            flagStart = true;
            emit doStartFinish();
            return true;
        }
    }
    if(curBlock.blockIndex.toLongLong()!=prvBlock.blockIndex.toLongLong()+1){
        BUG << curReadableContract << "curBlock.blockIndex.toLongLong()!=prvBlock.blockIndex.toLongLong()+1";
        return doFinishReadable(curReadableContract);
    }
    if(curBlock.blockHashPrev!=prvBlock.blockHash){
        BUG << curReadableContract << "curBlock.blockHashPrev!=prvBlock.blockHash";
        return doFinishReadable(curReadableContract);
    }
    emit doBlockOld(curValue);
    return false;
}
void onnObject::onPeerOldOK(QByteArray pData){
    onnBlock curBlock1 = createBlock(pData);
    if(getDatabaseBlock(QByteArray("0-")+curBlock1.blockIndex)=="null"){
        setDatabaseBlock(QByteArray("0-")+curBlock1.blockIndex,pData);
    }
    BUG << curBlock1.blockIndex;
    if(flagStart){
        return;
    }
    qint64 i = curBlock1.blockIndex.toLongLong()+1;
    QByteArray curKey = "0-";
    QByteArray prvValue = pData;
    QByteArray curValue = getDatabaseBlock(curKey+QByteArray::number(i));
    if(i==1){
        prvValue = getBlock0();
    }
    onnBlock curBlock;
    onnBlock prvBlock;
    if(curValue == "null"){
        doFinishReadable("0");
        return;
    }else{
        curBlock = createBlock(curValue);
        prvBlock = createBlock(prvValue);
    }
    if(curBlock.blockIndex.toLongLong()!=prvBlock.blockIndex.toLongLong()+1){
        BUG << "curBlock.blockIndex.toLongLong()!=prvBlock.blockIndex.toLongLong()+1";
        doFinishReadable("0");
        return;
    }
    if(curBlock.blockHashPrev!=prvBlock.blockHash){
        BUG << "curBlock.blockHashPrev!=prvBlock.blockHash";
        doFinishReadable("0");
        return;
    }
    emit doBlockOld(curValue);
}
void onnObject::onDeployOldOK(QByteArray pContract,QByteArray pData){
    onnBlock curBlock1 = createBlock(pData);
    if(getDatabaseBlock(pContract+"-"+curBlock1.blockIndex)=="null"){
        setDatabaseBlock(pContract+"-"+curBlock1.blockIndex,pData);
    }
    if(getDatabaseBlock(QByteArray("0-")+curBlock1.blockIndex)=="null"){
        setDatabaseBlock(QByteArray("0-")+curBlock1.blockIndex,pData);
    }
    BUG << pContract << curBlock1.blockIndex;
    if(flagStart){
        return;
    }
    qint64 i = curBlock1.blockIndex.toLongLong()+1;
    QByteArray curKey = "0-";
    QByteArray prvValue = pData;
    QByteArray curValue = getDatabaseBlock(curKey+QByteArray::number(i));
    if(i==1){
        prvValue = getBlock0();
    }
    if(curValue == "null"){
        doFinishReadable("0");
        return;
    }
    onnBlock curBlock = createBlock(curValue);
    onnBlock prvBlock = createBlock(prvValue);
    if(curBlock.blockIndex.toLongLong()!=prvBlock.blockIndex.toLongLong()+1){
        BUG << "curBlock.blockIndex.toLongLong()!=prvBlock.blockIndex.toLongLong()+1";
        doFinishReadable("0");
        return;
    }
    if(curBlock.blockHashPrev!=prvBlock.blockHash){
        BUG << "curBlock.blockHashPrev!=prvBlock.blockHash";
        doFinishReadable("0");
        return;
    }
    emit doBlockOld(curValue);
}
void onnObject::onMethodOldOK(QByteArray pContract,QByteArray pData){
    onnBlock curBlock1 = createBlock(pData);
    if(getDatabaseBlock(pContract+"-"+curBlock1.blockIndex)=="null"){
        setDatabaseBlock(pContract+"-"+curBlock1.blockIndex,pData);
    }
    BUG << pContract << curBlock1.blockIndex;
    if(flagStart){
        return;
    }
    qint64 i = curBlock1.blockIndex.toLongLong()+1;
    QByteArray curKey = pContract+"-";
    QByteArray prvValue = pData;
    QByteArray curValue = getDatabaseBlock(curKey+QByteArray::number(i));
    if(i==1){
        prvValue = getBlock0();
    }
    if(curValue == "null"){
        doFinishReadable(pContract);
        return;
    }
    onnBlock curBlock = createBlock(curValue);
    onnBlock prvBlock = createBlock(prvValue);
    if(curBlock.blockIndex.toLongLong()!=prvBlock.blockIndex.toLongLong()+1){
        BUG << "curBlock.blockIndex.toLongLong()!=prvBlock.blockIndex.toLongLong()+1";
        doFinishReadable(pContract);
        return;
    }
    if(curBlock.blockHashPrev!=prvBlock.blockHash){
        BUG << "curBlock.blockHashPrev!=prvBlock.blockHash";
        doFinishReadable(pContract);
        return;
    }
    emit doBlockOld(curValue);
}
void onnObject::onDestroyOldOK(QByteArray pData){
    onnBlock curBlock1 = createBlock(pData);
    if(getDatabaseBlock(QByteArray("0-")+curBlock1.blockIndex)=="null"){
        setDatabaseBlock(QByteArray("0-")+curBlock1.blockIndex,pData);
    }
    BUG << curBlock1.blockIndex;
    if(flagStart){
        return;
    }
    qint64 i = curBlock1.blockIndex.toLongLong()+1;
    QByteArray curKey = "0-";
    QByteArray prvValue = pData;
    QByteArray curValue = getDatabaseBlock(curKey+QByteArray::number(i));
    if(i==1){
        prvValue = getBlock0();
    }
    if(curValue == "null"){
        doFinishReadable("0");
        return;
    }
    onnBlock curBlock = createBlock(curValue);
    onnBlock prvBlock = createBlock(prvValue);
    if(curBlock.blockIndex.toLongLong()!=prvBlock.blockIndex.toLongLong()+1){
        BUG << "curBlock.blockIndex.toLongLong()!=prvBlock.blockIndex.toLongLong()+1";
        doFinishReadable("0");
        return;
    }
    if(curBlock.blockHashPrev!=prvBlock.blockHash){
        BUG << "curBlock.blockHashPrev!=prvBlock.blockHash";
        doFinishReadable("0");
        return;
    }
    emit doBlockOld(curValue);
}

void onnObject::onContractOldFail(QByteArray pContract){
    if(flagStart){
        return;
    }
    doFinishReadable(pContract);
}

void onnObject::onBlockNew(QByteArray pData){
    QList<QByteArray> listCmd = pData.split('&');
    if(listCmd.count()<2){
        BUG << "bad data: listCmd.count()<2" << pData;
        return;
    }
    QByteArray sign = listCmd.at(0);
    QByteArray data = listCmd.at(1);
    QList<QByteArray> listData = data.split('$');
    if(listData.count()<5){
        BUG << "bad data: listData.count()<5" << pData;
        return;
    }

    QByteArray type = listData.at(0);
    QByteArray pubkey = listData.at(1);
    QByteArray name = listData.at(2);
    QByteArray code = listData.at(3);
    QByteArray arg = QByteArray::fromHex(listData.at(4));

/*
    QByteArray curIdentityPubkey = GETADDR(getIdentity(name).toLatin1());
    if(curIdentityPubkey != onnObjectKey.address){
        BUG << "send to boss" << name;
        emit doSendBlockChainData(name,curIdentityPubkey,pData);
        return;
    }
*/
    if(code == "init"){
        BUG << "bad block new: can not call init" << name;
        return;
    }
    if(!getVerify(pubkey,data,sign)){
        BUG << "msg fail: verify fail" << pData;
        return;
    }

    if(type == "deploy"){
        if(hasContract(name)){
            BUG << "bad deploy: contract exist" << name;
            return;
        }
        if(GETADDR(pubkey) != getBoss("0")){
            if(name.count()<3 || name.count()>8){
                BUG << "bad deploy: name.count()<3 || name.count()>8" << name;
                return;
            }
        }
        emit doDeployNew(pData);
    }else if(type == "method"){
        if(code.left(3) == "get" || code.left(1) == "_"){
            BUG << "bad method: can not run private or get" << code ;
            return;
        }
        emit doMethodNew(pData);
    }else if(type == "peer"){
        if(name != "0"){
            BUG << "bad deploy: only 0 can update peer" << name;
            return;
        }
        emit doPeerNew(pData);
    }else if(type == "destroy"){
        if(!hasContract(name)){
            BUG << "bad destroy: contract not exist" << name;
            return;
        }
        emit doDestroyNew(pData);
    }else if(type == "timer"){
        if(pubkey != onnObjectKey.pubkey){
            BUG << "bad change timer: only node owner can do that" << pubkey;
            return;
        }
        emit doChangeTimer(name,code);
    }else{
        BUG << "Unknow" << name << type;
    }
}
void onnObject::onDestroyNew(QByteArray pData){
    QByteArray curHash = GETSHA256(pData);
    if(getDatabaseBlock(curHash) != "null"){
        BUG << "bad destroy: hash data exist" << curHash;
        return;
    }
    QList<QByteArray> pList = pData.split('$');
    QString name = pList.at(2);
    QString codeHex = pList.at(3);
    QString arg = QByteArray::fromHex(pList.at(4));
    QString key = GETADDR(pList.at(1));
    if(!hasContract(name.toLatin1())){
        BUG << "bad destroy: contract not exist" << name;
        return;
    }
    if(getBoss("0") != onnObjectKey.address){
        BUG << "send to boss 0" << getBoss("0");
        emit doCustomRequire(name,getBoss("0"),"newblock",pData);
        return;
    }
    if(!doOnnDestroy(name,key)){
        BUG << "doOnnDestroy fail";
        return;
    }
    lua_State *curContract = getContract(arg.toLatin1());
    lua_close(curContract);
    onnObjectContract->remove(arg);
    rmBoss(arg.toLatin1());
    onnBlock curBlock = createBlock(getBlock("0").blockIndex.toLongLong()+1,\
                                    QDateTime::currentMSecsSinceEpoch(),\
                                    getBlock("0").blockHash,\
                                    pData);
    insertBlock("0",curBlock);
    setDatabaseBlock(curHash,curHash);
    emit doDestroyNewOK(toString(curBlock));
}
void onnObject::onDeployNew(QByteArray pData){
    if(!getBossMissing(getPeerList()).isEmpty()){
        BUG << "bad deploy: an contract boss is missing" << getBossMissing(getPeerList());
        return;
    }
    QByteArray curHash = GETSHA256(pData);
    if(getDatabaseBlock(curHash) != "null"){
        BUG << "bad deploy: hash data exist" << curHash;
        return;
    }
    QList<QByteArray> pList = pData.split('$');
    QString name = pList.at(2);
    QString codeHex = pList.at(3);
    QString arg = QByteArray::fromHex(pList.at(4));
    QString key = GETADDR(pList.at(1));
    if(hasContract(name.toLatin1())){
        BUG << "bad deploy: contract exist" << name;
        return;
    }
    if(getBoss("0") != onnObjectKey.address){
        BUG << "send to boss" << name << getBoss("0");
        emit doCustomRequire(name,getBoss("0"),"newblock",pData);
        return;
    }
    QString code;
    if(codeHex.contains("i")){
        code = codeHex;
    }else{
        code = QByteArray::fromHex(codeHex.toLatin1());
    }
    if(code.contains("_G")){
        BUG << "bad deploy: contains _G" << name;
        return;
    }
    /*
    if(code.contains("require")){
        BUG << "bad deploy: contains require" << name;
        return;
    }
    */
    if(hasSyncQueueRequest("0")){
        BUG << "bad deploy: hasSyncQueueRequest 0";
        return;
    }
    QString codeCost = QString::number(code.count()*2);
    //code.push_front(contractHead);
    lua_State *luaInterface = luaL_newstate();
    luaL_openlibs1(luaInterface);
    luaL_dostring(luaInterface,code.toLatin1().data());
    QString result;
    QString resultInit;
    if(!_doMethodW(luaInterface,"init",arg,key,resultInit)){
        lua_close(luaInterface);
        return;
    }
    QString curTotal;
    if(_doMethodR(luaInterface,"_getTotal","null",onnObjectKey.address,result)){
        curTotal = result;
    }else{
        curTotal = "0";
    }
    if(curTotal == "0"){
        lua_close(luaInterface);
        return;
    }
    result = setDeployBoss(name+"?10000?"+curTotal+"?"+codeCost,key);
    if(result == "fail"){
        BUG << "setDeployBoss fail";
        lua_close(luaInterface);
        return;
    }else{
        BUG << "setDeployBoss ok";
        setBoss(name.toLatin1(),result.toLatin1());
    }
    if(!resultInit.isEmpty() && resultInit != "null"){
        BUG << "doBroadcastAppNew" << resultInit;
        emit doBroadcastAppNew(resultInit.toLatin1());
    }
    emit doSetBossList(getBossAddressList());
    addContract(name.toLatin1(),luaInterface);
    onnBlock curBlock = createBlock(getBlock("0").blockIndex.toLongLong()+1,\
                                    QDateTime::currentMSecsSinceEpoch(),\
                                    getBlock("0").blockHash,\
                                    pData);
    insertBlock("0",curBlock);
    insertBlock(name.toLatin1(),curBlock);
    setDatabaseBlock(curHash,curHash);
    emit doDeployNewOK(name.toLatin1(),toString(curBlock));
}
void onnObject::onMethodNew(QByteArray pData){
    QByteArray curHash = GETSHA256(pData);
    if(getDatabaseBlock(curHash) != "null"){
        BUG << "bad method: hash data exist" << curHash;
        return;
    }
    QList<QByteArray> pList = pData.split('$');
    QString name = pList.at(2);
    QString code = pList.at(3);
    QString arg = QByteArray::fromHex(pList.at(4));
    QString key = GETADDR(pList.at(1));
    QString result;
    if(name == "0" && code == "transfer" && !getBossMissing(getPeerList()).isEmpty()){
        BUG << "bad method: an contract boss is missing" << getBossMissing(getPeerList());
        return;
    }
    if(!checkBlockNewIdentity(name,pData)){
        return;
    }
    if(hasSyncQueueRequest(name.toLatin1())){
        BUG << "bad method: hasSyncQueueRequest" << name;
        return;
    }
    if(_doMethodW(getContract(name.toLatin1()),code,arg,key,result)){
        onnBlock curBlock = createBlock(getBlock(name.toLatin1()).blockIndex.toLongLong()+1,\
                                        QDateTime::currentMSecsSinceEpoch(),\
                                        getBlock(name.toLatin1()).blockHash,\
                                        pData);
        insertBlock(name.toLatin1(),curBlock);
        emit doMethodNewOK(name.toLatin1(),toString(curBlock));
        if(!result.isEmpty() && result != "null"){
            BUG << "doBroadcastAppNew" << result;
            emit doBroadcastAppNew(result.toLatin1());
        }
        setDatabaseBlock(curHash,curHash);
    }
}
void onnObject::onPeerNew(QByteArray pData){
    QByteArray curHash = GETSHA256(pData);
    if(getDatabaseBlock(curHash) != "null"){
        BUG << "bad peer: hash data exist" << curHash;
        return;
    }
    if(!getPeerList().isEmpty() && !getBossMissing(getPeerList()).isEmpty()){
        BUG << "bad peer: an contract boss is missing" << getBossMissing(getPeerList());
        return;
    }
    QList<QByteArray> pList = pData.split('$');
    QString arg = QByteArray::fromHex(pList.at(4));
    if(!checkBlockNewIdentity("0",pData)){
        return;
    }
    if(hasSyncQueueRequest("0")){
        BUG << "bad peers: hasSyncQueueRequest";
        return;
    }
    if(arg.contains("?")){
        QStringList argList = arg.split("?");
        if(getPeerList().join(",")==argList.at(1)){
            return;
        }
        setPeerList(argList.at(0).split(","));
        setPeerLose(argList.at(1).split(","));
    }else{
        if(getPeerList().join(",")==arg){
            return;
        }
        setPeerList(arg.split(","));
    }
    setPeers();
    QByteArrayList curContractList = getBossMissingContracts();
    if(!curContractList.isEmpty())
        onBossMissing(curContractList);
    onnBlock curBlock = createBlock(getBlock("0").blockIndex.toLongLong()+1,\
                                    QDateTime::currentMSecsSinceEpoch(),\
                                    getBlock("0").blockHash,\
                                    pData);
    insertBlock("0",curBlock);
    setDatabaseBlock(curHash,curHash);
    emit doPeerNewOK(toString(curBlock));
}
void onnObject::onPeerNewOK(QByteArray pData){
    //BUG << pData;
    onnBlock curBlock = createBlock(pData);
    setDatabaseBlock(QByteArray("0-")+curBlock.blockIndex,pData);
    //emit doBoardcastBlockChainLevel("0",onnObject::toString(curBlock));
    BUG << curBlock.blockIndex;
}
void onnObject::onDeployNewOK(QByteArray pContract,QByteArray pData){
    onnBlock curBlock = createBlock(pData);
    setDatabaseBlock(QByteArray("0-")+curBlock.blockIndex,pData);
    setDatabaseBlock(pContract+'-'+curBlock.blockIndex,pData);
    //emit doBoardcastBlockChainLevel("0",onnObject::toString(curBlock));
    BUG << pContract << curBlock.blockIndex;
}
void onnObject::onMethodNewOK(QByteArray pContract,QByteArray pData){
    if(!hasBlock(pContract)){
        BUG << "ERROR: contract not exist" << pContract;
        exit(-1);
    }
    onnBlock curBlock = createBlock(pData);
    setDatabaseBlock(pContract+'-'+curBlock.blockIndex,pData);
    //emit doBoardcastBlockChainLevel(pContract,onnObject::toString(curBlock));
    BUG << pContract << curBlock.blockIndex;
}
void onnObject::onDestroyNewOK(QByteArray pData){
    onnBlock curBlock = createBlock(pData);
    setDatabaseBlock(QByteArray("0-")+curBlock.blockIndex,pData);
    //emit doBoardcastBlockChainLevel(pContract,onnObject::toString(curBlock));
    BUG << curBlock.blockIndex;
}

void onnObject::onSaveBlock(QByteArray,QByteArray){}

void onnObject::onBlockOldFinish(){}

void onnObject::onUdpdPeer(QStringList pList, QStringList pLose, QStringList pNew){
    if(flagStart == false){
        BUG << "fail: flagStart == false";
        return;
    }else{
        if(pList.isEmpty()){
            BUG << "fail: pList.count()==0";
            return;
        }
        pList.append(onnObjectKey.address);
        emit doSetBossList(getBossAddressList());
    }
    if(!pLose.isEmpty()){
        rmSyncLose(pLose);
    }
    setUdpClientList(pList);
    //pList = getHaveBalanceWorker0(pList,10000);
    BUG;
    BUG << "list" << pList;
    BUG << "lose" << pLose;
    BUG << "new " << pNew;
    //for test disable
    if(!pList.isEmpty() && pList != getPeerList()){
        if(getBoss("0") == onnObjectKey.address){
            QByteArray curData;
            if(pLose.isEmpty())
                curData = doCustomSet("peer","0","peer",(pList.join(",")).toLatin1().toHex());
            else
                curData = doCustomSet("peer","0","peer",(pList.join(",")+"?"+pLose.join(",")).toLatin1().toHex());
            //emit doBlockNew(curData);
            QtConcurrent::run(QThreadPool::globalInstance(),this,&onnObject::onBlockNew,curData);
        }
    }
}
void onnObject::onBroadcastBlockChainLevel(QString pContract, QString pAddress, QString pIndex){
    //BUG << pContract << pAddress;
    if(!hasUdpClientList(pAddress)){
        BUG << "!hasUdpClientList(pAddress)";
        return;
    }/*
    onnBlock curBlock = createBlock(pData.toLatin1());
    if(curBlock.blockIndex.isEmpty()){
        BUG << "curBlock.blockIndex.isEmpty()";
        return;
    }*/
    if(pContract == "0" && pIndex == "0"){
        BUG << "pContract == 0 && pIndex == 0";
        return;
    }
    if(!hasBlock(pContract.toLatin1())){
        //emit doRequireBlockChainData(pContract,curBlock.blockMaker,0,curBlock.blockIndex);
        BUG << "!hasBlock(pContract.toLatin1())";
        return;
    }
    onnBlock localBlock = getBlock(pContract);

    if(pIndex.toLongLong()<=localBlock.blockIndex.toLongLong()){
        //BUG << "pIndex.toLongLong()<=localBlock.blockIndex.toLongLong()" << pIndex << localBlock.blockIndex;
        return;
    }/*else if(curBlock.blockIndex.toLongLong()==localBlock.blockIndex.toLongLong()+1){
        emit doBlockOld(pData.toLatin1());
        return;
    }
    */
    if(!hasSyncQueue(pContract.toLatin1(),pAddress.toLatin1(),"request")){
        BUG << "doRequireBlockChainData" << localBlock.blockIndex.toLongLong()+1 << pIndex;
        //emit doRequireBlockChainData(pContract,pAddress,QString::number(localBlock.blockIndex.toLongLong()+1),curBlock.blockIndex);
        emit doCustomRequire(pContract,pAddress.toLatin1(),"require",QString::number(localBlock.blockIndex.toLongLong()+1)+":"+pIndex);
        setSyncQueue(pContract.toLatin1(),pAddress.toLatin1(),"request",QString::number(localBlock.blockIndex.toLongLong()+1).toLatin1(),pIndex.toLatin1());
    }
}
void onnObject::onRequireBlockChainData(QString pContract, QString nodeAddress, QString start, QString end){
    BUG << pContract << nodeAddress << start << end;
    if(!hasBlock(pContract.toLatin1())){
        BUG << "msg fail: !hasBlock(pContract)" << pContract;
        return;
    }
    if(start.toLongLong()<0 || end.toLongLong()<0){
        BUG << "msg fail: start.toLongLong()<0 || end.toLongLong()<0" << start << end;
        return;
    }
    if(start.toLongLong()>end.toLongLong()){
        BUG << "msg fail: start.toLongLong()<=end.toLongLong()" << start << end;
        return;
    }
    QByteArray curStartKey = pContract.toLatin1()+"-"+start.toLatin1();
    QByteArray curEndKey   = pContract.toLatin1()+"-"+end.toLatin1();
    if(getDatabaseBlock(curStartKey) == "null"){
        BUG << "msg fail: getDatabaseBlock(curStartKey) == null" << curStartKey;
        return;
    }
    if(getDatabaseBlock(curEndKey) == "null"){
        BUG << "msg fail: getDatabaseBlock(curEndKey) == null" << curEndKey;
        return;
    }
    quint32 curSize = 0;
    QJsonArray curArray;
    QJsonDocument curDocument;
    QByteArray curKey,curVar;
    for(qint64 i=start.toLongLong();i<=end.toLongLong() && curSize<8800;i++){
        curKey = pContract.toLatin1()+"-"+QString::number(i).toLatin1();
        curVar = getDatabaseBlock(curKey);
        curSize += curVar.count();
        curArray.append(QString(curVar));
    }
    BUG << "doSendBlockChainData" << curArray.size() << start << end;
    onnBlock curBlock = createBlock(curVar);
    curDocument.setArray(curArray);
    //emit doSendBlockChainData(pContract,nodeAddress,curDocument.toJson());
    emit doCustomRequire(pContract,nodeAddress.toLatin1(),"send",curDocument.toJson());
    if(!hasSyncQueue(pContract.toLatin1(),nodeAddress.toLatin1(),"response")){
        setSyncQueue(pContract.toLatin1(),nodeAddress.toLatin1(),"response",curBlock.blockIndex,end.toLatin1());
    }
    if(!updSyncQueueIndex(pContract.toLatin1(),nodeAddress.toLatin1(),"response",curBlock.blockIndex)){
        BUG << "rmSyncQueue response" <<  pContract;
        rmSyncQueue(pContract.toLatin1(),nodeAddress.toLatin1(),"response");
    }
}
void onnObject::onSendBlockChainData(QString pContract, QString pAddress, QString pData){
    BUG << pContract << pAddress << pData.count();
    QJsonDocument curDocument = QJsonDocument::fromJson(pData.toLatin1());
    QJsonArray curArray = curDocument.array();
    if(curArray.isEmpty()){
        return;
    }
    for(auto curData:curArray)
        emit doBlockOld(curData.toString().toLatin1());
    QByteArray lastBlock = curArray.last().toString().toLatin1();
    onnBlock curBlock = createBlock(lastBlock);
    if(curBlock.blockIndex.isEmpty()){
        return;
    }
    if(hasSyncQueue(pContract.toLatin1(),pAddress.toLatin1(),"request")){
        if(!updSyncQueueIndex(pContract.toLatin1(),pAddress.toLatin1(),"request",curBlock.blockIndex)){
            BUG << "rmSyncQueue request" <<  pContract;
            rmSyncQueue(pContract.toLatin1(),pAddress.toLatin1(),"request");
        }
    }
}


void onnObject::onCustomRequire(QString contractID, QString addr, QString cmd, QString data){
    if(flagStart == false){
        BUG << "fail: falg == false";
        return;
    }
    //BUG << cmd;
    if(cmd=="newblock"){
        //emit doBlockNew(data.toLatin1());
        QtConcurrent::run(QThreadPool::globalInstance(),this,&onnObject::onBlockNew,data.toLatin1());
    }else if(cmd=="level"){
        QStringList levelData = data.split(",");
        for(auto curLevel:levelData){
            QStringList curData = curLevel.split(":");
            if(curData.count() != 2){
                BUG << "error: data error" << curData;
                continue;
            }
            onBroadcastBlockChainLevel(curData.first(),addr,curData.last());
        }
    }else if(cmd=="require"){
        QStringList startEnd = data.split(":");
        if(startEnd.count()<2){
            BUG << cmd << "fail: startEnd.count()<2" << data;
            return;
        }
        onRequireBlockChainData(contractID,addr,startEnd.at(0),startEnd.at(1));
    }else if(cmd=="send"){
        onSendBlockChainData(contractID,addr,data);
    }else{
        BUG << "fail: Unknow cmd" << cmd;
    }
}

void onnObject::onBossMissing(QByteArrayList pList){
    for(auto curContract:pList){
        if(curContract=="0")
            continue;
        QString curResult = setNextBoss(curContract+"?10000");

        if(curResult == "fail"){
            BUG << "fail: _setNextBoss fail" << curContract << curResult;
        }else{
            BUG << "fail: _setNextBoss ok" << curContract << curResult;
            setBoss(curContract,curResult.toLatin1());
        }
    }
}

void onnObject::onTimeout(){
    if(!flagStart){
        BUG << "fail: flagStart == false" << QThread::currentThreadId();
        return;
    }
    if(getUdpClientList().isEmpty()){
        BUG << "fail: pList.isEmpty()";
        return;
    }
    QStringList curPeerList = getUdpClientList();
    if(curPeerList.count() == 1 && curPeerList.first() == onnObjectKey.address){
        BUG << "fail: curPeerList.count() == 1 && ==" << onnObjectKey.address;
        return;
    }
    QStringList levelData;
    QHash<QString,onnBossBlock> curBlockChain = *onnBlockChain;
    QHash<QString,onnBossBlock> *curBlockChainPtr = &curBlockChain;
    for(auto curBlockIter=curBlockChainPtr->begin();curBlockIter!=curBlockChainPtr->end();curBlockIter++){
        //BUG << "doBroadcastBlockChainLevel" << curBlockIter.key() << curBlockIter.value().blockCurrent.blockIndex;
        //emit doCustomBroadcast(curBlockIter.key(),"level",curBlockIter.value().blockCurrent.blockIndex);
        if(levelData.isEmpty()){
            levelData.append(curBlockIter.key()+":"+curBlockIter.value().blockCurrent.blockIndex);
        }else{
            if(levelData.last().count()>10000){
                levelData.append(curBlockIter.key()+":"+curBlockIter.value().blockCurrent.blockIndex);
            }else{
                levelData.replace(levelData.count()-1,levelData.last()+","+curBlockIter.key()+":"+curBlockIter.value().blockCurrent.blockIndex);
            }
        }
    }
    for(auto curLevel:levelData){
        emit doCustomBroadcast("*","level",curLevel);
    }
    QList<onnSyncQueue> curRemove;
    for(auto cur=onnSyncRequest.begin();cur!=onnSyncRequest.end();cur++){
        onnSyncQueue curData;
        if(!hasSyncQueue(cur.value().blockContract,cur.value().blockAddress,"request")){
            continue;
        }
        if(onnBlackList.contains(cur.value().blockAddress)){
            curRemove.append(getSyncQueue(cur.value().blockContract,cur.value().blockAddress,"request"));
            //rmSyncQueue(cur.value().blockContract,cur.value().blockAddress,"request");
            continue;
        }
        curData = getSyncQueue(cur.value().blockContract,cur.value().blockAddress,"request");
        if(QDateTime::currentMSecsSinceEpoch()-curData.blockLastModify>60*1000){
            curRemove.append(curData);
            //rmSyncQueue(cur.value().blockContract,cur.value().blockAddress,"request");
            onnBlackList.append(cur.value().blockAddress);
            //emit doRequireBlockChainData(cur.value().blockContract,cur.value().blockAddress,curData.blockCurrentIndex,curData.blockEnd);
        }
    }
    for(auto cur:curRemove){
        rmSyncQueue(cur.blockContract,cur.blockAddress,"request");
    }
    if(curRemove.count()>0)
        BUG << "curRemove Sync request =" << curRemove.count();
    curRemove.clear();
    QList<onnSyncQueue> curSyncQueue;
    for(auto cur=onnSyncResponse.begin();cur!=onnSyncResponse.end();cur++){
        if(!hasSyncQueue(cur.value().blockContract,cur.value().blockAddress,"response")){
            continue;
        }
        onnSyncQueue curQueue = getSyncQueue(cur.value().blockContract,cur.value().blockAddress,"response");
        quint32 curSize = 0;
        QJsonArray curArray;
        QJsonDocument curDocument;
        QByteArray curKey,curVar;
        for(qint64 i=curQueue.blockCurrentIndex.toLongLong();i<=curQueue.blockEnd.toLongLong() && curSize<88000;i++){
            curKey = cur.value().blockContract+"-"+QString::number(i).toLatin1();
            curVar = getDatabaseBlock(curKey);
            curSize += curVar.count();
            curArray.append(QString(curVar));
        }
        if(curSize>100000 && curArray.count()>1){
            curSize -= curArray.last().toString().count();
            curArray.removeLast();
            curVar = curArray.last().toString().toLatin1();
        }
        onnBlock curBlock = createBlock(curVar);
        BUG << curBlock.blockIndex;
        curDocument.setArray(curArray);
        //emit doSendBlockChainData(cur.value().blockContract,cur.value().blockAddress,curDocument.toJson());
        emit doCustomRequire(cur.value().blockContract,cur.value().blockAddress,"send",curDocument.toJson());
        if(!updSyncQueueIndex(cur.value().blockContract,cur.value().blockAddress,"response",curBlock.blockIndex)){
            curSyncQueue.append(curQueue);
        }
    }
    for(auto cur:curSyncQueue){
        rmSyncQueue(cur.blockContract,cur.blockAddress,"response");
    }
    if(curSyncQueue.count()>0)
        BUG << "curSyncQueue Sync response =" << curSyncQueue.count();
    if(!getBossAddressList().contains(onnObjectKey.address)){
        return;
    }
    if(getPeerList().isEmpty()){
        return;
    }
    //QStringList curBossLose = getBossLose(pLose);
    QByteArrayList curBossLose = getBossMissing(getPeerList());
    if(curBossLose.isEmpty()){
        return;
    }
    for(auto curBossAddress:curBossLose){
        rmBossFromAddress(curBossAddress);
    }
}
