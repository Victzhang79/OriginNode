#include "onnObject.h"
#include <QMultiMap>

QSettings *onnSetting;
onnKey onnObjectKey;
QHash<QString,QString> onnArgument;
QHash<QByteArray,QByteArray> onnBoss;
QMultiHash<QByteArray,QByteArray> onnBossforAddress;
leveldb::DB *onnObjectDB;
QStringList onnReadableContract;
QHash<QString,onnBossBlock> *onnBlockChain = new QHash<QString,onnBossBlock>;
QHash<QString,lua_State *> *onnObjectContract = new QHash<QString,lua_State *>;
Hub *onnWebsocket = new Hub();
NetSync *onnSync;
QStringList onnPeerList;
QStringList onnPeerLose;
QTimer *onnTimer = new QTimer();
QList<QByteArray> onnWebsocketAddress;
QList<QByteArray> onnWebsocketPeers;
QHash<QString,onnSyncQueue> onnSyncData;
QHash<QString,onnSyncQueue> onnSyncRequest;
QHash<QString,onnSyncQueue> onnSyncResponse;
int onnSyncRequestCount = 0;
int onnSyncResponseCount = 0;
QStringList onnClientList;
QMultiHash<QByteArray,QByteArray> onnChangeBossData;
QStringList onnBlackList;
QReadWriteLock onnRWlock;
QMutex onnLock;
int onnGas = 0;

onnObject::onnObject(QString pType){
    objType = pType;
    flagStart = false;
}
onnObject::~onnObject(){}

void onnObject::init(){emit doInit();}
void onnObject::onInit(){emit doInitFinish();}
void onnObject::onInitFinish(){}
void onnObject::onStart(){
    std::cout << "object start" << std::endl;
    flagStart = true;
    emit doStartFinish();
}
void onnObject::onStartFinish(){}

QByteArray onnObject::Encrypt(QByteArray pHex,QByteArray pMsg)
{
    //BUG << pMsg;
    QByteArray result;
    QByteArray keyiv = QByteArray::fromHex(GETSHA256(QByteArray::fromHex(pHex)));
    unsigned char key[EVP_MAX_KEY_LENGTH] = {0};  //保存密钥的数组
    unsigned char iv[EVP_MAX_KEY_LENGTH] = {0};   //保存初始化向量的数组
    EVP_CIPHER_CTX ctx;         //EVP加密上下文环境
    unsigned char out[1024] = {0};        //保存密文的缓冲区
    int outl;
    int rv;
    int i;

    //设置key和iv
    for(i=0;i<24;i++)
    {
        key[i]=(unsigned char)keyiv.at(i);
    }
    for(i=0;i<8;i++)
    {
        iv[i]=(unsigned char)keyiv.at(i+24);
    }

    //初始化ctx
    EVP_CIPHER_CTX_init(&ctx);
    rv = EVP_EncryptInit_ex(&ctx,EVP_des_ede3_cbc(),NULL,key,iv);
    if(rv != 1)
    {
        printf("Err\n");
        return result;
    }
    rv = EVP_EncryptUpdate(&ctx,out,&outl,(const unsigned char *)pMsg.data(),pMsg.count());//加密
    if(rv != 1)
    {
        //fail
        return result;
    }
    result.append((const char *)out,outl);
    rv = EVP_EncryptFinal_ex(&ctx,out,&outl);
    if(rv != 1)
    {
        EVP_CIPHER_CTX_cleanup(&ctx);
        return result;
    }
    QByteArray result1;
    result1.append((const char *)out,outl);
    //BUG << result.toHex();
    //BUG << result1.toHex();
    EVP_CIPHER_CTX_cleanup(&ctx);   //清除EVP加密上下文环境
    return (result+result1).toHex();
}

QByteArray onnObject::Decrypt(QByteArray pHex,QByteArray pMsg)
{
    //BUG << pMsg;
    QByteArray result;
    QByteArray secmsg = QByteArray::fromHex(pMsg);
    QByteArray keyiv = QByteArray::fromHex(GETSHA256(QByteArray::fromHex(pHex)));
    unsigned char key[EVP_MAX_KEY_LENGTH] = {0};      //保存密钥的数组
    unsigned char iv[EVP_MAX_KEY_LENGTH] = {0};       //保存初始化向量的数组
    EVP_CIPHER_CTX ctx;             //EVP加密上下文环境
    unsigned char out[1024+EVP_MAX_KEY_LENGTH] = {0}; //保存解密后明文的缓冲区数组
    int outl;
    int rv;
    int i;

    for(i=0;i<24;i++)
    {
        key[i]=(unsigned char)keyiv.at(i);
    }
    for(i=0;i<8;i++)
    {
        iv[i]=(unsigned char)keyiv.at(i+24);
    }

    //初始化ctx
    EVP_CIPHER_CTX_init(&ctx);
    rv = EVP_DecryptInit_ex(&ctx,EVP_des_ede3_cbc(),NULL,key,iv);
    if(rv != 1)
    {
        EVP_CIPHER_CTX_cleanup(&ctx);
        return result;
    }
    rv = EVP_DecryptUpdate(&ctx,out,&outl,(const unsigned char *)secmsg.data(),secmsg.count());//解密
    if(rv != 1)
    {
        //fail
        EVP_CIPHER_CTX_cleanup(&ctx);
        return result;
    }
    result.append((const char *)out,outl);

    rv = EVP_DecryptFinal_ex(&ctx,out,&outl);
    if(rv != 1)
    {
        EVP_CIPHER_CTX_cleanup(&ctx);
        return result;
    }
    QByteArray result1;
    result1.append((const char *)out,outl);
    EVP_CIPHER_CTX_cleanup(&ctx);//清除EVP加密上下文环境
    //BUG << result+result1 << (result+result1).count();
    return result+result1;
}

QByteArray onnObject::getBlock0(){
    /*
    QFile f("0");
    f.open(QIODevice::ReadOnly);
    QByteArray curBlockSource = f.readAll();
    f.close();
    QByteArray curBlockSource1 = doDeploy("0",curBlockSource,"6e756c6c");
    onnBlock curBlock = createBlock(0,\
                                    QDateTime::currentMSecsSinceEpoch(),\
                                    GETSHA256(curBlockSource1),\
                                    curBlockSource1);
    return toString(curBlock);
    */
    QByteArray curBlock0 = \
            "0@1538108218293@cbf5d9894dcb59913f457d57c12649a971f08a68a4851bc01b2e42a016262a7c\
@663631653035636365376464303862393535663366366233373838313734636165313138333437653661666437633\
26130336461626533653265663031626365@46423334453046384633364544413844323933343245454433353034463\
934414132433935464631323535463644324543464430374233324535363035414535344341413039364346463137363\
8393937324543444337384241464338434444463739454443363839443844393241374434463632334434424143343231\
3136266465706c6f7924313843454536364137444536463636354443373143354546393233334130453933343733444633\
424346433931433237384430364335353033464641454234454344433242373545373435383043453533434439444439314\
3323137463634424146374533383333393831383834313339363338333735433739363930424332243024366137333666366\
5323033643230373236353731373536393732363532303237366137333666366532373061363734633631373337343464366\
6363436393636373932303364323032373332333033313338323033303337333033363230333133303361333033303237306\
1363735353733363537323230323032303230336432303665363936633061363734643631366236353732323032303230336\
            4323036653639366330613637346536313664363532303230323032303364323032373632366637333733323\
0363336663665373437323631363337343237306136373533373936643632366636633230323033643230323736323666373\
3373332373061363734323631366336313665363336353230336432303762376430613637343637323635363537613635366532303364323037623764306136373534366637343631366332303230323033643230333133303330333033303330333033303330333030613637346637373665363537323230323032303364323036653639366330613637343636353635323032303230323032303364323033303265333130613637343636353635353036663666366332303364323033303061363734393633366636653230323032303230336432303237323730613637343236663733373332303230323032303364323037623764306136373530363536353732373332303230323033643230323732373061363735333635363536343230323032303230336432303330306136373466373236343635373232303230323033643230376237643061363734663732363436353732343934343230336432303237333132373061363734393634363536653734363937343739336432303762376430613637343436353733373437323666373932303364323037623764306130613636373536653633373436393666366532303566373336353734353537333635373232383730353537333635373232393061323032303230323036373535373336353732323033643230373035353733363537323061363536653634306130613636373536653633373436393666366532303566363736353734353537333635373232383239306132303230323032303732363537343735373236653230363735353733363537323061363536653634306130613636373536653633373436393666366532303566373336353734346436313662363537323238373035353733363537323239306132303230323032303637346436313662363537323364323037303535373336353732306136353665363430613061363637353665363337343639366636653230356637333635373435303635363537323733323837303463363937333734323930613230323032303230363735303635363537323733323033643230373034633639373337343061363536653634306130613636373536653633373436393666366532303566363436663532363136653634323837303464363137383239306132303230323032303664363137343638326537323631366536343666366437333635363536343238363735333635363536343239306132303230323032303732363537343735373236653230366436313734363832653732363136653634366636643238333132633730346436313738323930613635366536343061306136363735366536333734363936663665323035663637363537343432363136633631366536333635346636363238373035353733363537323239306132303230323032303639363632303637343236313663363136653633363535623730353537333635373235643230336433643230366536393663323037343638363536653061303932303230323032303732363537343735373236653230333030613230323032303230363536653634306132303230323032303230323032303230373236353734373537323665323036373432363136633631366536333635356237303535373336353732356430613635366536343061306136363735366536333734363936663665323035663637363537343534366637343631366332383239306132303230323032303732363537343735373236653230363735343666373436313663306136353665363430613061363637353665363337343639366636653230356636343635373337343732366637393238373035333739366436323666366332393061323032303230323036393636323036373535373336353732323033643364323036373432366637333733356237303533373936643632366636633564356232373666373736653635373232373564323037343638363536653061323032303230323032303230323032303637343936343635366537343639373437393562363734323666373337333562373035333739366436323666366335643562323736643631366236353732323735643564323033643230366536393663306132303230323032303230323032303230363936363230363734363732363536353761363536653562363734323666373337333562373035333739366436323666366335643562323736663737366536353732323735643564323033633364323033313230373436383635366530613230323032303230323032303230323032303230323032303637343236313663363136653633363535623637346637373665363537323564323033643230363734323631366336313665363336353562363734663737366536353732356432303262323036373436373236353635376136353665356236373432366637333733356237303533373936643632366636633564356232373666373736653635373232373564356430613230323032303230323032303230323032303230323032303637343637323635363537613635366535623637343236663733373335623730353337393664363236663663356435623237366637373665363537323237356435643230336432303330306132303230323032303230323032303230363536633733363530613230323032303230323032303230323032303230323032303663366636333631366332303633373537323530363137393230336432303637343637323635363537613635366535623637343236663733373335623730353337393664363236663663356435623237366637373665363537323237356435643266333230613230323032303230323032303230323032303230323032303637343236313663363136653633363535623637346637373665363537323564323033643230363734323631366336313665363336353562363734663737366536353732356432303262323036333735373235303631373930613230323032303230323032303230323032303230323032303637343236313663363136653633363535623637343236663733373335623730353337393664363236663663356435623237366637373665363537323237356435643230336432303637343236313663363136653633363535623637343236663733373335623730353337393664363236663663356435623237366637373665363537323237356435643230326232303238363734363732363536353761363536653562363734323666373337333562373035333739366436323666366335643562323736663737366536353732323735643564326436333735373235303631373932393061323032303230323032303230323032303230323032303230363734363732363536353761363536653562363734323666373337333562373035333739366436323666366335643562323736663737366536353732323735643564323033643230333030613230323032303230323032303230323036353665363430613230323032303230323032303230323037323635373437353732366532303232366636623232306132303230323032303635366536343061323032303230323036393636323036373436373236353635376136353665356236373432366637333733356237303533373936643632366636633564356232373666373736653635373232373564356432303365323033313230373436383635366530613230323032303230323032303230323037323635373437353732366532303237363636313639366332373061323032303230323036353665363430613230323032303230363734323631366336313665363336353562363734663737366536353732356432303364323036373432363136633631366536333635356236373466373736653635373235643230326232303637343637323635363537613635366535623637343236663733373335623730353337393664363236663663356435623237366637373665363537323237356435643061323032303230323036373436373236353635376136353665356236373432366637333733356237303533373936643632366636633564356232373666373736653635373232373564356432303364323033303061323032303230323037323635373437353732366532303232366636623232306136353665363430613061363637353665363337343639366636653230356636373635373434653635373837343432366637333733323837303432363136633631366536333635323930613230323032303230366336663633363136633230363337353732346336393733373432303364323035663733373036633639373432383637353036353635373237333263323032373263323732393061323032303230323036393636323032333633373537323463363937333734323033643364323033303230373436383635366530613230323032303230323032303230323037303732363936653734323836343635363237353637326536373635373436393665363636663238333132393265363337353732373236353665373436633639366536353263363436353632373536373265363736353734363936653636366632383331323932653665363136643635323930613230323032303230323032303230323037323635373437353732366532303237363636313639366332373061323032303230323036353665363430613230323032303230373037323639366537343238366137333666366532653635366536333666363436353238363337353732346336393733373432393239306132303230323032303663366636333631366332303639323033643230333130613230323032303230366336663633363136633230373436373734346336393733373432303364323037623764306132303230323032303663366636333631366332303734363737343463363937333734333132303364323037623764306132303230323032303737363836393663363532303639323033633364323032333633373537323463363937333734323036343666306132303230323032303230323032303230363936363230363734323631366336313665363336353562363337353732346336393733373435623639356435643230376533643230366536393663323036313665363432303637343236313663363136653633363535623633373537323463363937333734356236393564356432303365323037343666366537353664363236353732323837303432363136633631366536333635323932303734363836353665306132303230323032303230323032303230323032303230323037343631363236633635326536393665373336353732373432383230373436373734346336393733373432633230363337353732346336393733373435623639356432303239306132303230323032303230323032303230323032303230323036393636323036373439363436353665373436393734373935623633373537323463363937333734356236393564356432303364336432303665363936633230366637323230363734393634363536653734363937343739356236333735373234633639373337343562363935643564323033643364323033303230373436383635366530613230323032303230323032303230323032303230323032303230323032303230373436313632366336353265363936653733363537323734323832303734363737343463363937333734333132633230363337353732346336393733373435623639356432303239306132303230323032303230323032303230323032303230323036353665363430613230323032303230323032303230323036353665363430613230323032303230323032303230323036393230336432303639326233313061323032303230323036353665363430613230323032303230366336663633363136633230363337353732343336663735366537343230336432303233373436373734346336393733373430613230323032303230363936363230363337353732343336663735366537343230336433643230333032303734363836353665306132303230323032303230323032303230373236353734373537323665323036333735373234633639373337343562333135643061323032303230323036353665363430613230323032303230366336663633363136633230363337353732343336663735366537343331323033643230323337343637373434633639373337343331306132303230323032303264326437303732363936653734323836613733366636653265363536653633366636343635323837343637373434633639373337343239323930613230323032303230363936363230363337353732343336663735366537343331323033653230333032303734363836353665306132303230323032303230323032303230366336663633363136633230363337353732343936653634363537383331323033643230356636343666353236313665363432383633373537323433366637353665373433313239306132303230323032303230323032303230373236353734373537323665323037343637373434633639373337343331356236333735373234393665363436353738333135643061323032303230323036353663373336353061323032303230323032303230323032303663366636333631366332303633373537323439366536343635373832303364323035663634366635323631366536343238363337353732343336663735366537343239306132303230323032303230323032303230373236353734373537323665323037343637373434633639373337343562363337353732343936653634363537383564306132303230323032303635366536343061363536653634306130613636373536653633373436393666366532303566373336353734346536353738373434323666373337333238373035333739366436323666366332633730343236313663363136653633363532393061323032303230323036393636323036373432366637333733356237303533373936643632366636633564323033643364323036653639366332303734363836353665306132303230323032303230323032303230373037323639366537343238363436353632373536373265363736353734363936653636366632383331323932653633373537323732363536653734366336393665363532633634363536323735363732653637363537343639366536363666323833313239326536653631366436353239306132303230323032303230323032303230373236353734373537323665323032373636363136393663323730613230323032303230363536653634306132303230323032303663366636333631366332303633373537323465363537383734323033643230356636373635373434653635373837343432366637333733323837303432363136633631366536333635323930613230323032303230363936363230363337353732346536353738373432303364336432303237363636313639366332373230373436383635366530613230323032303230323032303230323037303732363936653734323836343635363237353637326536373635373436393665363636663238333132393265363337353732373236353665373436633639366536353263363436353632373536373265363736353734363936653636366632383331323932653665363136643635323930613230323032303230323032303230323037323635373437353732366532303237363636313639366332373061323032303230323036353665363430613230323032303230366336663633363136633230363337353732346436313662363537323364323036373432366637333733356237303533373936643632366636633564356232373664363136623635373232373564306132303230323032303637343936343635366537343639373437393562363337353732346436313662363537323564323033643230363734393634363536653734363937343739356236333735373234643631366236353732356432643331306132303230323032303639363632303637343936343635366537343639373437393562363337353732346536353738373435643230336433643230366536393663323037343638363536653061323032303230323032303230323032303637343936343635366537343639373437393562363337353732346536353738373435643230336432303330306132303230323032303635366536343061323032303230323036373439363436353665373436393734373935623633373537323465363537383734356432303230336432303637343936343635366537343639373437393562363337353732346536353738373435643262333130613230323032303230363734323666373337333562373035333739366436323666366335643562323736643631366236353732323735643230336432303633373537323465363537383734306132303230323032303732363537343735373236653230363337353732346536353738373430613635366536343061306136363735366536333734363936663665323035663733363537343532363137343635323837303533373936643632366636633239306132303230323032303637343236663733373335623730353337393664363236663663356435623237373236313734363532373564323032303364323037333734373236393665363732653636366637323664363137343238323732353265333036363237326332303637343236663733373335623730353337393664363236663663356435623237373436663734363136633237356432663637343637323635363537613635366535623637343236663733373335623730353337393664363236663663356435623237366637373665363537323237356435643239306136353665363430613061363637353665363337343639366636653230356637333635373434343635373036633666373934323666373337333238373035333739366436323666366332633730343236313663363136653633363532633730353436663734363136633263373034363732363536353761363536653239306132303230323032303639363632303566373437323631366537333636363537323534366634363732363536353761363536653533363536633636323836373535373336353732326337303436373236353635376136353665323932303364336432303237363636313639366332373230373436383635366530613230323032303230323032303230323037303732363936653734323836343635363237353637326536373635373436393665363636663238333132393265363337353732373236353665373436633639366536353263363436353632373536373265363736353734363936653636366632383331323932653665363136643635323930613230323032303230323032303230323037323635373437353732366532303237363636313639366332373061323032303230323036353665363430613230323032303230363936363230363734363732363536353761363536653562363735353733363537323564323033643364323036653639366332303734363836353665306132303230323032303230323032303230373037323639366537343238363436353632373536373265363736353734363936653636366632383331323932653633373537323732363536653734366336393665363532633634363536323735363732653637363537343639366536363666323833313239326536653631366436353239306132303230323032303230323032303230373236353734373537323665323032373636363136393663323730613230323032303230363536653634306132303230323032303639363632303734366636653735366436323635373232383733373437323639366536373265363636663732366436313734323832373235326533303636323732633230363734363732363536353761363536653562363735353733363537323564326637343666366537353664363236353732323837303534366637343631366332393239323932303365323033313330333033303330333032303734363836353665306132303230323032303230323032303230373037323639366537343238363436353632373536373265363736353734363936653636366632383331323932653633373537323732363536653734366336393665363532633634363536323735363732653637363537343639366536363666323833313239326536653631366436353239306132303230323032303230323032303230373236353734373537323665323032373636363136393663323730613230323032303230363536653634306132303230323032303639363632303637343236663733373335623730353337393664363236663663356432303765336432303665363936633230373436383635366530613230323032303230323032303230323037303732363936653734323836613733366636653265363536653633366636343635323836373432366637333733356237303533373936643632366636633564323932393061323032303230323032303230323032303264326437323635373437353732366532303566363736353734353236353733373536633734323836373535373336353732326332373566373336353734343436353730366336663739343236663733373332373263363636313663373336353263323736323666373337333230363537383639373337343237323930613230323032303230323032303230323037303732363936653734323836343635363237353637326536373635373436393665363636663238333132393265363337353732373236353665373436633639366536353263363436353632373536373265363736353734363936653636366632383331323932653665363136643635323930613230323032303230323032303230323037323635373437353732366532303237363636313639366332373061323032303230323036353665363430613230323032303230363734323666373337333562373035333739366436323666366335643230336432303762376430613230323032303230366336663633363136633230363337353732346536353738373432303364323035663637363537343465363537383734343236663733373332383730343236313663363136653633363532393061323032303230323036393636323036333735373234653635373837343230336433643230323736363631363936633237323037343638363536653061323032303230323032303230323032303264326437323635373437353732366532303566363736353734353236353733373536633734323836373535373336353732326332373566373336353734343436353730366336663739343236663733373332373263363636313663373336353263323736333735373234653635373837343230363636313639366332373239306132303230323032303230323032303230373037323639366537343238363436353632373536373265363736353734363936653636366632383331323932653633373537323732363536653734366336393665363532633634363536323735363732653637363537343639366536363666323833313239326536653631366436353239306132303230323032303230323032303230373236353734373537323665323032373636363136393663323730613230323032303230363536653634306132303230323032303639363632303637343936343635366537343639373437393562363337353732346536353738373435643230336433643230366536393663323037343638363536653061323032303230323032303230323032303637343936343635366537343639373437393562363337353732346536353738373435643230336432303330306132303230323032303635366536343061323032303230323036373439363436353665373436393734373935623633373537323465363537383734356432303364323036373439363436353665373436393734373935623633373537323465363537383734356432623331306132303230323032303637343236663733373335623730353337393664363236663663356435623237366436313662363537323237356432303364323036333735373234653635373837343061323032303230323036373432366637333733356237303533373936643632366636633564356232373734366637343631366332373564323033643230373436663665373536643632363537323238373035343666373436313663323930613230323032303230363734323666373337333562373035333739366436323666366335643562323737353665373537333635323735643230336432303734366636653735366436323635373232383730353436663734363136633239306132303230323032303566373336353734353436663662363536653466373736653635373232383730353337393664363236663663326336373535373336353732323930613230323032303230363936363230373436663665373536643632363537323238373035343666373436313663323932303363336432303330323037343638363536653061323032303230323032303230323032303637343236663733373335623730353337393664363236663663356435623237373236313734363532373564323032303364323033303061323032303230323036353663373336353061323032303230323032303230323032303566373336353734353236313734363532383730353337393664363236663663323930613230323032303230363536653634306132303230323032303061323032303230323036373533363536353634323033643230363735333635363536343262333130613230323032303230373236353734373537323665323036333735373234653635373837343061363536653634306130613636373536653633373436393666366532303566373337303663363937343238373337343732326332303634363536633639366436393734363537323239306130393639363632303733373437323364336436653639366332303666373232303733373437323364336432373237323036663732323036343635366336393664363937343635373233643364366536393663323037343638363536653061303930393732363537343735373236653230366536393663306130393635366536343061303930613230323032303230366336663633363136633230373236353733373536633734323033643230376237643061323032303230323036363666373232303664363137343633363832303639366532303238373337343732326532653634363536633639366436393734363537323239336136373664363137343633363832383232323832653264323932323265326536343635366336393664363937343635373232393230363436663061323032303230323032303230323032303734363136323663363532653639366537333635373237343238373236353733373536633734326332303664363137343633363832393061323032303230323036353665363430613230323032303230373236353734373537323665323037323635373337353663373430613635366536343061306136363735366536333734363936663665323035663631363436343532363537333735366337343238373035353733363537323263373034643635373436383666363432633730353236353733373536633734326337303464373336373263373034313663366332393061323032303230323036633666363336313663323036323735363636363635373232303364323037623764306132303230323032303663366636333631366332303732363537333735366337343230336432303730343136633663306132303230323032303632373536363636363537323562323736643635373436383666363432373564323033643230373034643635373436383666363430613230323032303230363237353636363636353732356232373732363537333735366337343237356432303364323037303532363537333735366337343061323032303230323036323735363636363635373235623237366437333637323735643230323032303230336432303730346437333637306132303230323032303632373536363636363537323562323736663737366536353732323735643230323033643230373035353733363537323061323032303230323036323735363636363635373235623237373337393664363236663663323735643230336432303637353337393664363236663663306132303230323032303734363136323663363532653639366537333635373237343238373236353733373536633734326336323735363636363635373232393061323032303230323037323635373437353732366532303732363537333735366337343061363536653634306130613636373536653633373436393666366532303566363736353734353236353733373536633734323837303535373336353732326337303464363537343638366636343263373035323635373337353663373432633730346437333637323930613230323032303230366336663633363136633230363237353636363636353732323033643230376237643061323032303230323036633666363336313663323037323635373337353663373432303364323035663631363436343532363537333735366337343238373035353733363537323263373034643635373436383666363432633730353236353733373536633734326337303464373336373263363237353636363636353732323930613230323032303230373236353734373537323665323036613733366636653265363536653633366636343635323837323635373337353663373432393061363536653634306130613636373536653633373436393666366532303566343937333439366535343631363236633635323837363631366337353635326332303734363236633239306132303230323032303636366637323230366232633736323036393665323036393730363136393732373332383734363236633239323036343666306132303230323032303230323032303230363936363230373632303364336432303736363136633735363532303734363836353665306132303230323032303230323032303230323032303230323037323635373437353732366532303734373237353635336230613230323032303230323032303230323036353665363430613230323032303230363536653634306132303230323032303732363537343735373236653230363636313663373336353362306136353665363430613061363637353665363337343639366636653230356636373635373434663737366536353732323832393061323032303230323037323635373437353732366532303637346637373665363537323061363536653634306130613636373536653633373436393666366532303639366536393734323832393061323032303230323036393636323036373466373736653635373232303765336432303665363936633230373436383635366530613230323032303230323032303230323037303732363936653734323836343635363237353637326536373635373436393665363636663238333132393265363337353732373236353665373436633639366536353263363436353632373536373265363736353734363936653636366632383331323932653665363136643635323930613230323032303230323032303230323037323635373437353732366532303237363636313639366332373061323032303230323036353665363430613230323032303230373037323639366537343238363735353733363537323239306132303230323032303637346637373665363537323230336432303637353537333635373230613230323032303230363734323631366336313665363336353562363735353733363537323564323033643230363735343666373436313663306130613230323032303230363734323666373337333562363735333739366436323666366335643230336432303762376430613230323032303230363734323666373337333562363735333739366436323666366335643562323736643631366236353732323735643230336432303637353537333635373230613230323032303230363734323666373337333562363735333739366436323666366335643562323737343666373436313663323735643230336432303637353436663734363136633061306132303230323032303637353336353635363432303364323036373533363536353634326233313061306132303230323032303663366636333631366332303633373537323532363537333735366337343230336432303762376430613230323032303230356636313634363435323635373337353663373432383637353537333635373232633237363936653639373432373263373437323735363532633637343236663733373335623637353337393664363236663663356432633633373537323532363537333735366337343239306132303230323032303566363136343634353236353733373536633734323836373535373336353732326332373637363537343432363136633631366536333635346636363237326337343732373536353263363734323631366336313665363336353562363735353733363537323564326336333735373235323635373337353663373432393061323032303230323037323635373437353732366532303661373336663665326536353665363336663634363532383633373537323532363537333735366337343239306136353665363430613061363637353665363337343639366636653230373336353734343636353635323837303436363536353239306132303230323032303639363632303637353537333635373232303765336432303637346637373665363537323230373436383635366530613230323032303230323032303230323037303732363936653734323836343635363237353637326536373635373436393665363636663238333132393265363337353732373236353665373436633639366536353263363436353632373536373265363736353734363936653636366632383331323932653665363136643635323930613230323032303230323032303230323037323635373437353732366532303237363636313639366332373061323032303230323036353665363430613230323032303230366336663633363136633230363337353732343636353635323033643230373436663665373536643632363537323238373034363635363532393061323032303230323036393636323036333735373234363635363532303363323033303230373436383635366530613230323032303230323032303230323037303732363936653734323836343635363237353637326536373635373436393665363636663238333132393265363337353732373236353665373436633639366536353263363436353632373536373265363736353734363936653636366632383331323932653665363136643635323930613230323032303230323032303230323037323635373437353732366532303237363636313639366332373061323032303230323036353665363430613230323032303230363936363230363337353732343636353635323033653230333132303734363836353665306132303230323032303230323032303230373037323639366537343238363436353632373536373265363736353734363936653636366632383331323932653633373537323732363536653734366336393665363532633634363536323735363732653637363537343639366536363666323833313239326536653631366436353239306132303230323032303230323032303230373236353734373537323665323032373636363136393663323730613230323032303230363536653634306132303230323032303637343636353635323033643230373436663665373536643632363537323238373034363635363532393061323032303230323037323635373437353732366532303566363736353734353236353733373536633734323836373535373336353732326332373733363537343436363536353237326337343732373536353263363734363635363532393061363536653634306130613636373536653633373436393666366532303734363136623635343636353635353036663666366332383239306132303230323032303639363632303637353537333635373232303765336432303637346637373665363537323230373436383635366530613230323032303230323032303230323037303732363936653734323836343635363237353637326536373635373436393665363636663238333132393265363337353732373236353665373436633639366536353263363436353632373536373265363736353734363936653636366632383331323932653665363136643635323930613230323032303230323032303230323037323635373437353732366532303237363636313639366332373061323032303230323036353665363430613230323032303230363936363230363734363635363535303666366636633230336332303331323037343638363536653061323032303230323032303230323032303730373236393665373432383634363536323735363732653637363537343639366536363666323833313239326536333735373237323635366537343663363936653635326336343635363237353637326536373635373436393665363636663238333132393265366536313664363532393061323032303230323032303230323032303732363537343735373236653230323736363631363936633237306132303230323032303635366536343061323032303230323036373432363136633631366536333635356236373535373336353732356432303364323036373432363136633631366536333635356236373535373336353732356432623637343636353635353036663666366330613230323032303230363734363635363535303666366636633230336432303330306132303230323032303732363537343735373236653230356636373635373435323635373337353663373432383637353537333635373232633237363736353734343236313663363136653633363534663636323732633734373237353635326336373432363136633631366536333635356236373535373336353732356432393061363536653634306130613636373536653633373436393666366532303733363537343432366637333733346436313662363537323238373035333739366436323666366332633730353537333635373232393061323032303230323036393636323036373432366637333733356237303533373936643632366636633564356232373666373736653635373232373564323037653364323036373535373336353732323037343638363536653061323032303230323032303230323032303730373236393665373432383634363536323735363732653637363537343639366536363666323833313239326536333735373237323635366537343663363936653635326336343635363237353637326536373635373436393665363636663238333132393265366536313664363532393061323032303230323032303230323032303732363537343735373236653230323736363631363936633237306132303230323032303635366536343061323032303230323036393636323036373439363436353665373436393734373935623730353537333635373235643230376533643230366536393663323036313665363432303637343936343635366537343639373437393562373035353733363537323564323033653230333032303734363836353665306132303230323032303230323032303230373037323639366537343238363436353632373536373265363736353734363936653636366632383331323932653633373537323732363536653734366336393665363532633634363536323735363732653637363537343639366536363666323833313239326536653631366436353239306132303230323032303230323032303230373236353734373537323665323032373636363136393663323730613230323032303230363536653634306132303230323032303639363632303637343236663733373335623730353337393664363236663663356435623237366436313662363537323237356432303364336432303665363936633230373436383635366530613230323032303230323032303230323037303732363936653734323836343635363237353637326536373635373436393665363636663238333132393265363337353732373236353665373436633639366536353263363436353632373536373265363736353734363936653636366632383331323932653665363136643635323930613230323032303230323032303230323037323635373437353732366532303237363636313639366332373061323032303230323036353665363430613230323032303230363936363230363734323631366336313665363336353562363735353733363537323564323033633230333132623637343636353635323037343638363536653061323032303230323032303230323032303730373236393665373432383634363536323735363732653637363537343639366536363666323833313239326536333735373237323635366537343663363936653635326336343635363237353637326536373635373436393665363636663238333132393265366536313664363532393061323032303230323032303230323032303732363537343735373236653230323736363631363936633237306132303230323032303635366536343061323032303230323036633666363336313663323036333735373234643631366236353732323033643230363734323666373337333562373035333739366436323666366335643562323736643631366236353732323735643061323032303230323036373432366637333733356237303533373936643632366636633564356232373664363136623635373232373564323033643230373035353733363537323061323032303230323036373439363436353665373436393734373935623633373537323464363136623635373235643230336432303637343936343635366537343639373437393562363337353732346436313662363537323564326433313061323032303230323036393636323036373439363436353665373436393734373935623730353537333635373235643230336433643230366536393663323037343638363536653061323032303230323032303230323032303637343936343635366537343639373437393562373035353733363537323564323033643230333030613230323032303230363536653634306132303230323032303637343936343635366537343639373437393562373035353733363537323564323032303230323033643230363734393634363536653734363937343739356237303535373336353732356432623331306132303230323032303663366636333631366332303734353236353733373536633734323033643230373437323631366537333636363537323238363337353732346436313662363537323263333132393061323032303230323036633666363336313663323036333735373235323635373337353663373432303364323037623764306132303230323032303566363136343634353236353733373536633734323836333735373234643631366236353732326332373733363537343432366637333733346436313662363537323237326337343732373536353263373035333739366436323666366332653265323733663237326532653730353537333635373232633633373537323532363537333735366337343239306132303230323032303566363136343634353236353733373536633734323837303535373336353732326332373733363537343432366637333733346436313662363537323237326337343732373536353263373035333739366436323666366332653265323733663237326532653730353537333635373232633633373537323532363537333735366337343239306132303230323032303566363136343634353236353733373536633734323836373535373336353732326332373733363537343432366637333733346436313662363537323237326337343732373536353263373035333739366436323666366332653265323733663237326532653730353537333635373232633633373537323532363537333735366337343239306132303230323032303566363136343634353236353733373536633734323832373261323732633237373336353734343236663733373334643631366236353732323732633734373237353635326337343532363537333735366337343263363337353732353236353733373536633734323930613230323032303230373236353734373537323665323036613733366636653265363536653633366636343635323836333735373235323635373337353663373432393061363536653634306130613636373536653633373436393666366532303637363537343466373236343635373232383239306132303230323032303639363632303637346637323634363537323562363735353733363537323564323033643364323036653639366332303734363836353665306132303230323032303230323032303230373236353734373537323665323035663637363537343532363537333735366337343238363735353733363537323263323736373635373434663732363436353732323732633734373237353635326332373665373536633663323732393061323032303230323036353665363430613230323032303230373236353734373537323665323035663637363537343532363537333735366337343238363735353733363537323263323736373635373434663732363436353732323732633734373237353635326336373466373236343635373235623637353537333635373235643239306136353665363430613061363637353665363337343639366636653230363736353734343236663733373334643631366236353732323837303533373936643632366636633239306132303230323032303639363632303637343236663733373335623730353337393664363236663663356435623237366436313662363537323237356432303364336432303665363936633230373436383635366530613230323032303230323032303230323037303732363936653734323836343635363237353637326536373635373436393665363636663238333132393265363337353732373236353665373436633639366536353263363436353632373536373265363736353734363936653636366632383331323932653665363136643635323930613230323032303230323032303230323037323635373437353732366532303237363636313639366332373061323032303230323036353665363430613230323032303230373236353734373537323665323035663637363537343532363537333735366337343238363735353733363537323263323736373635373434323666373337333464363136623635373232373263373437323735363532633637343236663733373335623730353337393664363236663663356435623237366436313662363537323237356432393061363536653634306130613636373536653633373436393666366532303637363537343436363536353238323930613230323032303230366336663633363136633230363337353732353236353733373536633734323033643230376237643061323032303230323035663631363436343532363537333735366337343238363735353733363537323263323736373635373434363635363532373263373437323735363532633637343636353635326336333735373235323635373337353663373432393061323032303230323035663631363436343532363537333735366337343238363735353733363537323263323736373635373434363635363535303666366636633237326337343732373536353263363734363635363535303666366636633263363337353732353236353733373536633734323930613230323032303230373236353734373537323665323036613733366636653265363536653633366636343635323836333735373235323635373337353663373432393061363536653634306130613636373536653633373436393666366532303637363537343533373936643632366636633238323930613230323032303230373236353734373537323665323035663637363537343532363537333735366337343238363735353733363537323263323736373635373435333739366436323666366332373263373437323735363532633637353337393664363236663663323930613635366536343061306136363735366536333734363936663665323036373635373435343666373436313663353337353730373036633739323832393061323032303230323037323635373437353732366532303566363736353734353236353733373536633734323836373535373336353732326332373637363537343534366637343631366335333735373037303663373932373263373437323735363532633637353436663734363136633239306136353665363430613061363637353665363337343639366636653230363736353734346536313664363532383239306132303230323032303732363537343735373236653230356636373635373435323635373337353663373432383637353537333635373232633237363736353734346536313664363532373263373437323735363532633637346536313664363532393061363536653634306130613636373536653633373436393666366532303637363537343432363136633631366536333635346636363238373035353733363537323239306132303230323032303639363632303637343236313663363136653633363535623730353537333635373235643230336433643230366536393663323037343638363536653061303932303230323032303732363537343735373236653230356636373635373435323635373337353663373432383637353537333635373232633237363736353734343236313663363136653633363534663636323732633734373237353635326333303239306132303230323032303635366536343061323032303230323032303230323032303732363537343735373236653230356636373635373435323635373337353663373432383637353537333635373232633237363736353734343236313663363136653633363534663636323732633734373237353635326336373432363136633631366536333635356237303535373336353732356432393061363536653634306130613636373536653633373436393666366532303637363537343439363336663665323832393061323032303230323037323635373437353732366532303566363736353734353236353733373536633734323836373535373336353732326332373637363537343439363336663665323732633734373237353635326336373439363336663665323930613635366536343061306136363735366536333734363936663665323037333635373434393633366636653238373034393633366636653239306132303230323032303639363632303637346637373665363537323230376533643230363735353733363537323230373436383635366530613230323032303230323032303230323037303732363936653734323836343635363237353637326536373635373436393665363636663238333132393265363337353732373236353665373436633639366536353263363436353632373536373265363736353734363936653636366632383331323932653665363136643635323930613230323032303230323032303230323037323635373437353732366532303237363636313639366332373061323032303230323036353665363430613230323032303230363936363230373337343732363936653637326536633635366532383230373034393633366636653230323932303365323033323330333433383230373436383635366530613230323032303230323032303230323037303732363936653734323836343635363237353637326536373635373436393665363636663238333132393265363337353732373236353665373436633639366536353263363436353632373536373265363736353734363936653636366632383331323932653665363136643635323930613230323032303230323032303230323037323635373437353732366532303237363636313639366332373061323032303230323036353665363430613230323032303230363734393633366636653230336432303730343936333666366530613635366536343061306136363735366536333734363936663665323037343732363136653733363636353732323837303534366632633730343136643666373536653734323930613230323032303230366336663633363136633230363337353732343136643666373536653734323033643230373436663665373536643632363537323238373034313664366637353665373432393061323032303230323036393636323036333735373234313664366637353665373432303365323036373534366637343631366332303734363836353665306132303230323032303230323032303230373037323639366537343238363436353632373536373265363736353734363936653636366632383331323932653633373537323732363536653734366336393665363532633634363536323735363732653637363537343639366536363666323833313239326536653631366436353239306132303230323032303230323032303230373236353734373537323665323032373636363136393663323730613230323032303230363536653634306132303230323032303639363632303633373537323431366436663735366537343230336333643230363734363635363532303734363836353665306132303230323032303230323032303230326432643732363537343735373236653230356636373635373435323635373337353663373432383637353537333635373232633237373437323631366537333636363537323237326336363631366337333635326332373631366436663735366537343230336333643230333032373239306132303230323032303230323032303230373037323639366537343238363436353632373536373265363736353734363936653636366632383331323932653633373537323732363536653734366336393665363532633634363536323735363732653637363537343639366536363666323833313239326536653631366436353239306132303230323032303230323032303230373236353734373537323665323032373636363136393663323730613230323032303230363536653634306132303230323032303639363632303637343236313663363136653633363535623637353537333635373235643230336332303633373537323431366436663735366537343262363734363635363532303734363836353665306132303230323032303230323032303230326432643732363537343735373236653230356636373635373435323635373337353663373432383637353537333635373232633237373437323631366537333636363537323237326336363631366337333635326332373733363536653634363537323230363136643666373536653734323033633230363337353732343136643666373536653734323732393061323032303230323032303230323032303730373236393665373432383634363536323735363732653637363537343639366536363666323833313239326536333735373237323635366537343663363936653635326336343635363237353637326536373635373436393665363636663238333132393265366536313664363532393061323032303230323032303230323032303732363537343735373236653230323736363631363936633237306132303230323032303635366536343061323032303230323036393636323036373439363436353665373436393734373935623637353537333635373235643230376533643230366536393663323037343638363536653061323032303230323032303230323032303663366636333631366332303633373537323534366637343631366332303364323036373432363136633631366536333635356236373535373336353732356432303264323036333735373234313664366637353665373430613230323032303230323032303230323036393636323036333735373235343666373436313663323033633230363734393634363536653734363937343739356236373535373336353732356432303261323033313330333033303330323037343638363536653061323032303230323032303230323032303230323032303230373037323639366537343238363436353632373536373265363736353734363936653636366632383331323932653633373537323732363536653734366336393665363532633634363536323735363732653637363537343639366536363666323833313239326536653631366436353239306132303230323032303230323032303230323032303230323037323635373437353732366532303237363636313639366332373061323032303230323032303230323032303635366536343061323032303230323036353665363430613230323032303230363936363230363734323631366336313665363336353562373035343666356432303364336432303665363936633230373436383635366530613039323032303230323036373432363136633631366536333635356237303534366635643230336432303330306132303230323032303635366536343061323032303230323036633666363336313663323036333735373235323635373337353663373432303364323037623764306132303230323032303637343636353635353036663666366332303364323036373436363536353530366636663663323032623230363734363635363530613230323032303230363734323631366336313665363336353562363735353733363537323564323033643230363734323631366336313665363336353562363735353733363537323564323032643230363337353732343136643666373536653734306132303230323032303637343236313663363136653633363535623637353537333635373235643230336432303637343236313663363136653633363535623637353537333635373235643230326432303637343636353635306132303230323032303637343236313663363136653633363535623730353436663564323033643230363734323631366336313665363336353562373035343666356432303262323036333735373234313664366637353665373430613230323032303230356636313634363435323635373337353663373432383637353537333635373232633237363736353734343236313663363136653633363534663636323732633734373237353635326336373432363136633631366536333635356236373535373336353732356432633633373537323532363537333735366337343239306132303230323032303566363136343634353236353733373536633734323837303534366632633237363736353734343236313663363136653633363534663636323732633734373237353635326336373432363136633631366536333635356237303534366635643263363337353732353236353733373536633734323930613230323032303230363735333635363536343230336432303637353336353635363432623331306132303230323032303732363537343735373236653230366137333666366532653635366536333666363436353238363337353732353236353733373536633734323930613635366536343061306136363735366536333734363936663665323037343732363136653733363636353732353436663432366637333733323837303533373936643632366636633263373034313664366637353665373432393061323032303230323036633666363336313663323036333735373234313664366637353665373432303364323037343666366537353664363236353732323837303431366436663735366537343239306132303230323032303639363632303637343236663733373335623730353337393664363236663663356432303364336432303665363936633230373436383635366530613230323032303230323032303230323037303732363936653734323836343635363237353637326536373635373436393665363636663238333132393265363337353732373236353665373436633639366536353263363436353632373536373265363736353734363936653636366632383331323932653665363136643635323930613230323032303230323032303230323037323635373437353732366532303237363636313639366332373061323032303230323036353665363430613230323032303230363936363230363734393634363536653734363937343739356236373535373336353732356432303765336432303665363936633230373436383635366530613230323032303230323032303230323036633666363336313663323036333735373235343666373436313663323033643230363734323631366336313665363336353562363735353733363537323564323032643230363337353732343136643666373536653734306132303230323032303230323032303230363936363230363337353732353436663734363136633230336332303637343936343635366537343639373437393562363735353733363537323564323032613230333133303330333033303230373436383635366530613230323032303230323032303230323032303230323032303730373236393665373432383634363536323735363732653637363537343639366536363666323833313239326536333735373237323635366537343663363936653635326336343635363237353637326536373635373436393665363636663238333132393265366536313664363532393061323032303230323032303230323032303230323032303230373236353734373537323665323032373636363136393663323730613230323032303230323032303230323036353665363430613230323032303230363536653634306132303230323032303639363632303566373437323631366537333636363537323534366634363732363536353761363536653533363536633636323836373432366637333733356237303533373936643632366636633564356232373666373736653635373232373564326337303431366436663735366537343239323033643364323032373636363136393663323732303734363836353665306132303230323032303230323032303230373037323639366537343238363436353632373536373265363736353734363936653636366632383331323932653633373537323732363536653734366336393665363532633634363536323735363732653637363537343639366536363666323833313239326536653631366436353239306132303230323032303230323032303230373236353734373537323665323032373636363136393663323730613230323032303230363536653634306132303230323032303566373336353734353236313734363532383730353337393664363236663663323930613230323032303230366336663633363136633230363337353732353236353733373536633734323033643230376237643061323032303230323035663631363436343532363537333735366337343238363735353733363537323263323737343732363136653733363636353732353436663432366637333733323732633734373237353635326337303431366436663735366537343263363337353732353236353733373536633734323930613230323032303230356636313634363435323635373337353663373432383637353537333635373232633237363736353734353236313734363532373263373437323735363532633637343236663733373335623730353337393664363236663663356435623237373236313734363532373564326336333735373235323635373337353663373432393061323032303230323037323635373437353732366532303661373336663665326536353665363336663634363532383633373537323532363537333735366337343239306136353665363430613061363637353665363337343639366636653230356637343732363136653733363636353732353436663436373236353635376136353665353336353663363632383730353436663263373034313664366637353665373432393061323032303230323036633666363336313663323036333735373234313664366637353665373432303364323037343666366537353664363236353732323837303431366436663735366537343239306132303230323032303639363632303633373537323431366436663735366537343230336532303637353436663734363136633230373436383635366530613230323032303230323032303230323037303732363936653734323836343635363237353637326536373635373436393665363636663238333132393265363337353732373236353665373436633639366536353263363436353632373536373265363736353734363936653636366632383331323932653665363136643635323930613230323032303230323032303230323037323635373437353732366532303237363636313639366332373061323032303230323036353665363430613230323032303230363936363230363337353732343136643666373536653734323033633364323036373436363536353230373436383635366530613230323032303230323032303230323032643264373236353734373537323665323035663637363537343532363537333735366337343238363735353733363537323263323737343732363136653733363636353732323732633636363136633733363532633237363136643666373536653734323033633364323033303237323930613230323032303230323032303230323037303732363936653734323836343635363237353637326536373635373436393665363636663238333132393265363337353732373236353665373436633639366536353263363436353632373536373265363736353734363936653636366632383331323932653665363136643635323930613230323032303230323032303230323037323635373437353732366532303237363636313639366332373061323032303230323036353665363430613230323032303230363936363230363734323631366336313665363336353562363735353733363537323564323033633230363337353732343136643666373536653734326236373436363536353230373436383635366530613230323032303230323032303230323032643264373236353734373537323665323035663637363537343532363537333735366337343238363735353733363537323263323737343732363136653733363636353732323732633636363136633733363532633237373336353665363436353732323036313664366637353665373432303363323036333735373234313664366637353665373432373239306132303230323032303230323032303230373037323639366537343238363436353632373536373265363736353734363936653636366632383331323932653633373537323732363536653734366336393665363532633634363536323735363732653637363537343639366536363666323833313239326536653631366436353239306132303230323032303230323032303230373236353734373537323665323032373636363136393663323730613230323032303230363536653634306132303230323032303639363632303637343637323635363537613635366535623730353436663564323033643364323036653639366332303734363836353665306130393230323032303230363734363732363536353761363536653562373035343666356432303364323033303061323032303230323036353665363430613230323032303230366336663633363136633230363337353732353236353733373536633734323033643230376237643061323032303230323036373436363536353530366636663663323033643230363734363635363535303666366636633230326232303637343636353635306132303230323032303637343236313663363136653633363535623637353537333635373235643230336432303637343236313663363136653633363535623637353537333635373235643230326432303633373537323431366436663735366537343061323032303230323036373432363136633631366536333635356236373535373336353732356432303364323036373432363136633631366536333635356236373535373336353732356432303264323036373436363536353061323032303230323036373436373236353635376136353665356237303534366635643230336432303637343637323635363537613635366535623730353436663564323032623230363337353732343136643666373536653734306132303230323032303566363136343634353236353733373536633734323836373535373336353732326332373637363537343432363136633631366536333635346636363237326337343732373536353263363734323631366336313665363336353562363735353733363537323564326336333735373235323635373337353663373432393061323032303230323035663631363436343532363537333735366337343238373035343666326332373637363537343436373236353635376136353665323732633734373237353635326336373436373236353635376136353665356237303534366635643263363337353732353236353733373536633734323930613230323032303230373236353734373537323665323036613733366636653265363536653633366636343635323836333735373235323635373337353663373432393061363536653634306130613636373536653633373436393666366532303637363537343436373236353635376136353665323832393061323032303230323037323635373437353732366532303566363736353734353236353733373536633734323836373535373336353732326332373637363537343436373236353635376136353665323732633734373237353635326336373436373236353635376136353665356236373535373336353732356432393061363536653634306130613636373536653633373436393666366532303637363537343532363137343635323837303533373936643632366636633239306132303230323032303639363632303637343236663733373335623730353337393664363236663663356432303364336432303665363936633230373436383635366530613230323032303230323032303230323037323635373437353732366532303566363736353734353236353733373536633734323836373535373336353732326332373637363537343532363137343635323732633734373237353635326333303239306132303230323032303635366337333635306132303230323032303230323032303230373236353734373537323665323035663637363537343532363537333735366337343238363735353733363537323263323736373635373435323631373436353237326337343732373536353263363734323666373337333562373035333739366436323666366335643562323737323631373436353237356432393061323032303230323036353665363430613635366536343061306136363735366536333734363936663665323035663733363537343534366636623635366534663737366536353732323837303533373936643632366636633263373035353733363537323239306132303230323032303639363632303637343236663733373335623730353337393664363236663663356432303364336432303665363936633230373436383635366530613230323032303230323032303230323037303732363936653734323836343635363237353637326536373635373436393665363636663238333132393265363337353732373236353665373436633639366536353263363436353632373536373265363736353734363936653636366632383331323932653665363136643635323930613230323032303230323032303230323037323635373437353732366532303237363636313639366332373061323032303230323036353665363430613230323032303230363734323666373337333562373035333739366436323666366335643562323736663737366536353732323735643230336432303730353537333635373230613230323032303230373236353734373537323665323032373666366232373061363536653634306130613636373536653633373436393666366532303566373437323631366537333636363537323534366634363732363536353761363536653238373035333739366436323666366332633730353537333635373232633730343136643666373536653734323930613230323032303230363936363230363734323666373337333562373035333739366436323666366335643230336433643230366536393663323037343638363536653061323032303230323032303230323032303730373236393665373432383634363536323735363732653637363537343639366536363666323833313239326536333735373237323635366537343663363936653635326336343635363237353637326536373635373436393665363636663238333132393265366536313664363532393061323032303230323032303230323032303732363537343735373236653230323736363631363936633237306132303230323032303635366536343061323032303230323036393636323036373432363136633631366536333635356236373535373336353732356432303363323037343666366537353664363236353732323837303431366436663735366537343239326236373436363536353230373436383635366530613230323032303230323032303230323037303732363936653734323836343635363237353637326536373635373436393665363636663238333132393265363337353732373236353665373436633639366536353263363436353632373536373265363736353734363936653636366632383331323932653665363136643635323930613230323032303230323032303230323037323635373437353732366532303237363636313639366332373061323032303230323036353665363430613230323032303230363734323631366336313665363336353562363735353733363537323564323033643230363734323631366336313665363336353562363735353733363537323564326432383734366636653735366436323635373232383730343136643666373536653734323932623637343636353635323930613230323032303230363734363732363536353761363536653562373035353733363537323564323033643230363734363732363536353761363536653562373035353733363537323564326232383734366636653735366436323635373232383730343136643666373536653734323932393061323032303230323037323635373437353732366532303237366636623237306136353665363430613061363637353665363337343639366636653230356637343732363136653733363636353732353436663432363136633631366536333635323837303533373936643632366636633263373034363732366636643263373035343666326337303431366436663735366537343239306132303230323032303639363632303637343236663733373335623730353337393664363236663663356432303364336432303665363936633230373436383635366530613230323032303230323032303230323037303732363936653734323836343635363237353637326536373635373436393665363636663238333132393265363337353732373236353665373436633639366536353263363436353632373536373265363736353734363936653636366632383331323932653665363136643635323930613230323032303230323032303230323037323635373437353732366532303237363636313639366332373061323032303230323036353665363430613230323032303230363936363230363734363732363536353761363536653562373034363732366636643564323033633230373436663665373536643632363537323238373034313664366637353665373432393230373436383635366530613230323032303230323032303230323037303732363936653734323836343635363237353637326536373635373436393665363636663238333132393265363337353732373236353665373436633639366536353263363436353632373536373265363736353734363936653636366632383331323932653665363136643635323930613230323032303230323032303230323037323635373437353732366532303237363636313639366332373061323032303230323036353665363430613230323032303230363936363230363734323631366336313665363336353562363735353733363537323564323033633230363734363635363532303734363836353665306132303230323032303230323032303230373037323639366537343238363436353632373536373265363736353734363936653636366632383331323932653633373537323732363536653734366336393665363532633634363536323735363732653637363537343639366536363666323833313239326536653631366436353239306132303230323032303230323032303230373236353734373537323665323032373636363136393663323730613230323032303230363536653634306132303230323032303637343236313663363136653633363535623637353537333635373235643230336432303637343236313663363136653633363535623637353537333635373235643264363734363635363530613230323032303230363734363732363536353761363536653562373034363732366636643564323033643230363734363732363536353761363536653562373034363732366636643564326437343666366537353664363236353732323837303431366436663735366537343239306132303230323032303637343236313663363136653633363535623730353436663564323033643230363734323631366336313665363336353562373035343666356432623734366636653735366436323635373232383730343136643666373536653734323930613230323032303230373236353734373537323665323032373666366232373061363536653634306130613636373536653633373436393666366532303734366636623635366534323735373932383730353337393664363236663663326337303431366436663735366537343239306132303230323032303639363632303730353337393664363236663663323033643364323032373330323732303734363836353665306132303230323032303230323032303230373037323639366537343238363436353632373536373265363736353734363936653636366632383331323932653633373537323732363536653734366336393665363532633634363536323735363732653637363537343639366536363666323833313239326536653631366436353239306132303230323032303230323032303230373236353734373537323665323032373636363136393663323730613230323032303230363536653634306132303230323032303639363632303637343236663733373335623730353337393664363236663663356435623237373536653735373336353237356432303363323037343666366537353664363236353732323837303431366436663735366537343239323037343638363536653061323032303230323032303230323032303730373236393665373432383634363536323735363732653637363537343639366536363666323833313239326536333735373237323635366537343663363936653635326336343635363237353637326536373635373436393665363636663238333132393265366536313664363532393061323032303230323032303230323032303732363537343735373236653230323736363631363936633237306132303230323032303635366536343061323032303230323036633666363336313663323036333735373234663737366536353732323032303364323036373432366637333733356237303533373936643632366636633564356232373666373736653635373232373564306132303230323032303639363632303633373537323466373736653635373232303364336432303637353537333635373232303734363836353665306132303230323032303230323032303230373037323639366537343238363436353632373536373265363736353734363936653636366632383331323932653633373537323732363536653734366336393665363532633634363536323735363732653637363537343639366536363666323833313239326536653631366436353239306132303230323032303230323032303230373236353734373537323665323032373636363136393663323730613230323032303230363536653634306132303230323032303663366636333631366332303665363536353634353537333635333032303230336432303733373437323639366536373265363636663732366436313734323832303232323532653332363632323263323833313266363734323666373337333562373035333739366436323666366335643562323737323631373436353237356432393261373034313664366637353665373432393061323032303230323037303732363936653734323836653635363536343535373336353330323930613230323032303230363936363230373436663665373536643632363537323238366536353635363435353733363533303239323033633230333132303734363836353665306132303230323032303230323032303230373037323639366537343238363436353632373536373265363736353734363936653636366632383331323932653633373537323732363536653734366336393665363532633634363536323735363732653637363537343639366536363666323833313239326536653631366436353239306132303230323032303230323032303230373236353734373537323665323032373636363136393663323730613230323032303230363536653634306132303230323032303663366636333631366332303633373537323532363537333735366337343230336432303566373437323631366537333636363537323534366634363732363536353761363536653238373035333739366436323666366332633633373537323466373736653635373232633665363536353634353537333635333032393061323032303230323036393636323036333735373235323635373337353663373432303364336432303237363636313639366332373230373436383635366530613230323032303230323032303230323037303732363936653734323836343635363237353637326536373635373436393665363636663238333132393265363337353732373236353665373436633639366536353263363436353632373536373265363736353734363936653636366632383331323932653665363136643635323930613230323032303230323032303230323037323635373437353732366532303237363636313639366332373061323032303230323036353665363430613061323032303230323036373436363536353530366636663663323033643230363734363635363535303666366636633230326232303637343636353635306130613230323032303230363734663732363436353732356236373466373236343635373234393434356432303364323037623764306132303230323032303637346637323634363537323562363734663732363436353732343934343564356232373735373336353732323735643230323032303364323036373535373336353732306132303230323032303637346637323634363537323562363734663732363436353732343934343564356232373666373736653635373232373564323032303364323036333735373234663737366536353732306132303230323032303637346637323634363537323562363734663732363436353732343934343564356232373634363937323635363337343237356432303364323032373632373537393237306132303230323032303637346637323634363537323562363734663732363436353732343934343564356232373733373936643632366636633237356432303364323037303533373936643632366636633061323032303230323036373466373236343635373235623637346637323634363537323439343435643562323736313664366637353665373432373564323033643230373034313664366637353665373430613230323032303230363734663732363436353732356236373466373236343635373234393434356435623237366536353635363437353733363532373564336432303665363536353634353537333635333030613061323032303230323036373432366637333733356237303533373936643632366636633564356232373735366537353733363532373564323033643230363734323666373337333562373035333739366436323666366335643562323737353665373537333635323735643264373034313664366637353665373430613230323032303230306132303230323032303639363632303637346637323634363537323562363735353733363537323564323033643364323036653639366332303734363836353665306132303230323032303230323032303230363734663732363436353732356236373535373336353732356432303364323037623764306132303230323032303635366536343061323032303230323037343631363236633635326536393665373336353732373432383637346637323634363537323562363735353733363537323564326336373466373236343635373234393434323930613230323032303230366336663633363136633230363337353732343237323666363136343230336432303762376430613230323032303230356636313634363435323635373337353663373432383637353537333635373232633237373436663662363536653432373537393237326337343732373536353263363734663732363436353732343934343263363337353732343237323666363136343239306132303230323032303566363136343634353236353733373536633734323836333735373234663737366536353732326332373734366636623635366534323735373932373263373437323735363532633637346637323634363537323439343432633633373537323432373236663631363432393061323032303230323036373466373236343635373234393434323033643230373337343732363936653637326536363666373236643631373432383230323232353265333036363232326336373466373236343635373234393434326233313230323930613230323032303230373236353734373537323665323036613733366636653265363536653633366636343635323836333735372436653735366336632431353338313038313931393737@18CEE66A7DE6F665DC71C5EF9233A0E93473DF3BCFC91C278D06C5503FFAEB4ECDC2B75E74580CE53CD9DD91C217F64BAF7E3833981884139638375C79690BC2@CC09C35C6D6F5899E6932B75724C739D83753C27507B1C7D31AC3C7B4CE2D30BF003C1CD0E325C35ADFB46433D707265DA9ADE12C9015044F04072E4002286A9";
    return curBlock0;
}

void onnObject::makeBlock0(){
    QFile f("0.lua");
    f.open(QIODevice::ReadOnly);
    QByteArray curContract = f.readAll();
    f.close();
    QByteArray curData = doDeploy("0",curContract.toHex(),QByteArray("null").toHex());
    onnBlock curBlock = createBlock(0,0,getHash(curData).toHex(),curData);
    QFile f1("0");
    f1.open(QIODevice::WriteOnly);
    f1.write(toString(curBlock));
    f1.close();
}

void onnObject::initKey(){
    string curAppkey;
    QString curFile = "key.ini";
    if(!getArgument("-f").isEmpty()){
        curFile = getArgument("-f");
    }
    onnSetting = new QSettings(curFile,QSettings::IniFormat);
    if(hasAppkey()){
        onnObjectKey.appkey = onnSetting->value("appkey").toString().toLatin1();
        cout << "Enter your password" << endl;
        cin>>curAppkey;
        if(onnObjectKey.appkey != GETPSD(curAppkey.c_str())){
            cout << "password not correct" << endl;
            exit(-1);
        }
    }else{
        while(curAppkey.size()<6){
            curAppkey.clear();
            cout << "Enter a new password (length must be >= 6)" << endl;
            cin>>curAppkey;
        }
        onnObjectKey.appkey = GETPSD(curAppkey.c_str());
        onnSetting->setValue("appkey",onnObjectKey.appkey);
    }
    if(hasPubkey()){
        onnObjectKey.pubkey = onnSetting->value("pubkey").toString().toLatin1();
        onnObjectKey.prikey = Decrypt(GETSHA256(curAppkey.c_str()),onnSetting->value("prikey").toString().toLatin1());
    }else{
        makeKey(GETSHA256(curAppkey.c_str()));
    }
    onnObjectKey.address = GETADDR(onnObjectKey.pubkey);
    if(onnArgument.contains("-e")){
        cout << onnObjectKey.prikey.data() << endl;
        cout << onnObjectKey.pubkey.data() << endl;
        cout << GETADDR(onnObjectKey.pubkey).data() << endl;
        exit(1);
    }
    if(onnArgument.contains("-i")){
        onnSetting->setValue("prikey",Encrypt(GETSHA256(curAppkey.c_str()),onnArgument.value("-i").toLatin1()));
        onnSetting->setValue("pubkey",computePubkey(onnArgument.value("-i").toLatin1()));
        cout << GETADDR(computePubkey(onnArgument.value("-i").toLatin1())).data() << endl;
        exit(1);
    }
}

QByteArray onnObject::computePubkey(QByteArray pPri){
    uint8_t pp[65] = {0};
    uECC_compute_public_key((uint8_t *)QByteArray::fromHex(pPri).data(),pp,uECC_secp256k1());
    QByteArray final = (char *)pp;
    return final.toHex();
}

bool onnObject::hasAppkey(){
    if (!onnSetting->contains("appkey")){
        return false;
    }
    return true;
}

void onnObject::updAppkey(QByteArray pKey){
    onnObjectKey.appkey = pKey;
    onnSetting->setValue("appkey",onnObjectKey.appkey);
}

bool onnObject::hasPubkey(){
    if (!onnSetting->contains("pubkey")){
        return false;
    }
    return true;
}

void onnObject::makeKey(QByteArray pHex){
    getkey();
    onnObjectKey.pubkey = getPublicKey();
    onnObjectKey.prikey = getPrivateKey();
    onnObjectKey.prikey = onnObjectKey.prikey.left(64);   //need use AES

    onnSetting->setValue("pubkey",onnObjectKey.pubkey);
    onnSetting->setValue("prikey",Encrypt(pHex,onnObjectKey.prikey));
}

QByteArray onnObject::getSignature(QByteArray pMsg){
    QByteArray hash = GETSHA256(pMsg);
    sign(onnObjectKey.prikey.data(),hash.data());
    return QByteArray(getSign()).left(128);
}

QByteArray onnObject::getSignHash(QByteArray pHash){
    sign(onnObjectKey.prikey.data(),pHash.data());
    return QByteArray(getSign()).left(128);
}

QByteArray onnObject::getPubkey(){
    return onnObjectKey.pubkey;
}
QByteArray onnObject::getPrikey(){
    return onnObjectKey.prikey;
}
QByteArray onnObject::getAddress(){
    return onnObjectKey.address;
}

QByteArray onnObject::getHash(QByteArray pData){
    return QCryptographicHash::hash(pData,QCryptographicHash::Sha256);
}

bool onnObject::getVerify(QByteArray pub1,QByteArray msg1,QByteArray sig1){
    if(pub1.count()!=128 || sig1.count()!=128)return false;
    FieldElem x,y;
    Number msg,r,s;
    GroupElemJac pub;
    Signature sig;
    x.SetHex(pub1.left(64).data());
    y.SetHex(pub1.right(64).data());
    GroupElem aff(x,y);
    pub.SetAffine(aff);
    msg.SetHex(getHash(msg1).toHex().data());
    r.SetHex(sig1.left(64).data());
    s.SetHex(sig1.right(64).data());
    sig.SetRS(r,s);
    return sig.Verify(pub, msg);
}
/////////////////////////////////////////////////////////////////////////////////////////////
QString onnObject::getTaget(QString type,QString pubkey,QString name,QString code,QString arg,QString sig) {
    QString data = type + "$" + pubkey + "$" + name + "$" + code + "$" + arg;
    QString block = sig + "&" + data;
    return block;
}

QString onnObject::docmd(QString type,QString pubkey,QString prikey,QString name,QString func,QString arg) {
    QString msg = type + "$" + pubkey + "$" + name + "$" + func + "$" + arg;
    QByteArray hash = GETSHA256(msg.toLatin1());
    sign(prikey.toLatin1().data(),hash.data());
    QByteArray sig = getSign();
    sig = sig.left(128);
    QString block = getTaget(type, pubkey, name, func, arg, sig);
    return block;
}

QByteArray onnObject::doMethodGet(QString pContract,QString pMethod,QString pArg){
    QString block = pContract+"$"+pMethod+"$"+pArg+"$"+getPubkey();
    return block.toLatin1();
}
QByteArray onnObject::doMethodSet(QString pContract, QString pMethod, QString pArg){
    QString block = docmd("method",getPubkey(),getPrikey(),pContract,pMethod,pArg);
    return block.toLatin1();
}
QByteArray onnObject::doCustomSet(QString pType,QString pContract,QString pMethod,QString pArg){
    QString block = docmd(pType,getPubkey(),getPrikey(),pContract,pMethod,pArg);
    return block.toLatin1();
}
QByteArray onnObject::doDeploy(QString pContract,QString pCode,QString pArg){
    QString block = docmd("deploy",getPubkey(),getPrikey(),pContract,pCode,pArg);
    return block.toLatin1();
}
QByteArray onnObject::doHandlerGet(QByteArray pData){
    if(pData.contains("$")){
        pData.remove(0,1);
        return doMethodGet(pData);
    }
    if(pData.left(5) == "/help" || pData == "/favicon.ico"){
        QStringList helpInfo;
        helpInfo.append("/help");
        helpInfo.append("/list");
        helpInfo.append("/last + 0");
        helpInfo.append("/block + 0-0");
        helpInfo.append("/peers");
        helpInfo.append("/maker + contract");
        helpInfo.append("/boss + pub");
        helpInfo.append("/balance + contract,pub");
        helpInfo.append("/address");
        return helpInfo.join("\n").toLatin1();
    }
    if(pData == "/list"){
        return getContracts().join("\n").toLatin1();
    }
    if(pData.left(5) == "/last"){
        return toString(getBlock(pData.remove(0,5)));
    }
    if(pData.left(6) == "/block"){
        return getDatabaseBlock(pData.remove(0,6));
    }
    if(pData.left(6) == "/peers"){
        BUG << getPeerList();
        return getPeerList().join("\n").toLatin1();
    }
    if(pData.left(6) == "/maker"){
        return getBoss(pData.remove(0,6));
    }
    if(pData.left(5) == "/boss"){
        return getBossFromAddress(pData.remove(0,5)).join("\n");
    }
    if(pData.left(8) == "/balance"){
        return QByteArray::number(getContractBalance(pData.remove(0,8).split(',').first(),pData.remove(0,8).split(',').last()));
    }
    if(pData.left(8) == "/address"){
        return onnObjectKey.address;
    }
    pData.remove(0,1);
    return doMethodGet(pData);
}
////////////////////////////////////////////////////////////////////////////////////////
void onnObject::initArgv(int argc, char *argv[]){
    QString onnVersion = "0.9.1.4";
    if(argc>1){
        for(int i=1;i<argc;i=i+2){
            if(i+1>argc)
                break;
            onnArgument.insert(argv[i],argv[i+1]);
        }
    }
    if(onnArgument.contains("-h")){
        cout << "usage：ONN [option]" << endl;
        cout << "    -p     RPC listen port, default 3000" << endl;
        cout << "    -ws    websocket listen port, default 3001" << endl;
        cout << "    -i     import a private key, default use key.ini" << endl;
        cout << "    -e     export private key" << endl;
        cout << "    -t     set contract name, enable timer for run contract function _timeout()" << endl;
        cout << "    -s     set msec timer step when you use -t" << endl;
        cout << "    -v     show version" << endl;
        cout << "    -h     show this info" << endl;
        exit(1);
    }
    if(onnArgument.contains("-v")){
        cout << onnVersion.toStdString() << endl;
        exit(1);
    }
}

QString onnObject::getArgument(QString pKey){
    if(onnArgument.contains(pKey)){
        return onnArgument.value(pKey);
    }
    return "";
}
QString onnObject::getLocalIP(){
    QString ipAddr;
    QList<QHostAddress> AddressList = QNetworkInterface::allAddresses();
    for(QHostAddress address:AddressList){
        if(address.protocol() == QAbstractSocket::IPv4Protocol){
            if (address.toString().contains("127.0.")){
                continue;
            }
            return address.toString();
        }
    }
    return ipAddr;
}
void onnObject::setPeerList(QStringList pList){
    onnPeerList = pList;
}
void onnObject::setPeerLose(QStringList pList){
    onnPeerLose = pList;
}
QStringList onnObject::getPeerList(){
    return onnPeerList;
}
QStringList onnObject::getPeerLose(){
    return onnPeerLose;
}
QByteArray onnObject::calcHash(onnBlock pBlock){
    return getHash(pBlock.blockIndex+\
                              pBlock.blockTimestamp+\
                              pBlock.blockHashPrev+\
                              pBlock.blockData+\
                              pBlock.blockMaker).toHex();
}
void onnObject::setUdpClientList(QStringList pList){
    onnClientList = pList;
}
QStringList onnObject::getUdpClientList(){
    return onnClientList;
}
bool onnObject::hasUdpClientList(QString pAddress){
    return onnClientList.contains(pAddress);
}
//////////////////////////////////////////////////////////////////////////////////////////////////
void onnObject::initDatabase(){
    QString pFile = "db";
    if(!getArgument("-d").isEmpty()){
        pFile = getArgument("-d");
    }
    leveldb::Options options;
    options.create_if_missing = true;
    leveldb::Status status = leveldb::DB::Open(options, pFile.toLatin1().data(), &onnObjectDB);
    assert(status.ok());
}

QByteArray onnObject::getDatabaseBlock(QByteArray pKey){
    string value;
    leveldb::Status s;
    s = onnObjectDB->Get(leveldb::ReadOptions(), pKey.data(), &value);
    if(!s.ok()){
        return "null";
    }
    return value.c_str();
}
bool onnObject::setDatabaseBlock(QByteArray pKey,QByteArray pVar){
    leveldb::WriteOptions write_options;
    write_options.sync = true;
    leveldb::Status s = onnObjectDB->Put(leveldb::WriteOptions(), pKey.data(), pVar.data());
    if (!s.ok()){
        cout << "setData fail:" << pKey.data() << pVar.data() << endl;
    }
    return s.ok();
}
/////////////////////////////////////////////////////////////////////////////////////////////
void onnObject::insertBlock(QString pContract,onnBlock pBlock){
    onnBossBlock curBlock;
    if(onnBlockChain->contains(pContract)){
        curBlock = onnBlockChain->value(pContract);
    }else{
        curBlock.blockDeploy  = pBlock;
    }
    curBlock.name = pContract.toLatin1();
    curBlock.blockCurrent = pBlock;
    onnBlockChain->insert(pContract,curBlock);
}
onnBlock onnObject::getBlock(QString pContract){
    onnBlock curBlock;
    if(hasBlock(pContract.toLatin1()))
        return onnBlockChain->value(pContract).blockCurrent;
    return curBlock;
}
onnBossBlock onnObject::getBossBlock(QString pContract){
    onnBossBlock curBlock;
    if(hasBlock(pContract.toLatin1()))
        return onnBlockChain->value(pContract);
    return curBlock;
}
QByteArray onnObject::toString(onnBlock pBlock){
    return pBlock.blockIndex+"@"+pBlock.blockTimestamp+"@"+pBlock.blockHashPrev+"@"+pBlock.blockHash\
            +"@"+pBlock.blockData+"@"+pBlock.blockMaker+"@"+pBlock.blockMakerSign;
}

bool onnObject::hasBlock(QByteArray pKey){
    return onnBlockChain->contains(pKey);
}
onnBlock onnObject::createBlock(QByteArray pData){
    onnBlock curBlock;
    QList<QByteArray> data = pData.split('@');
    if(data.count()<7)
        return curBlock;
    curBlock.blockIndex = data.at(0);
    curBlock.blockTimestamp = data.at(1);
    curBlock.blockHashPrev = data.at(2);
    curBlock.blockHash = data.at(3);
    curBlock.blockData = data.at(4);
    curBlock.blockMaker = data.at(5);
    curBlock.blockMakerSign = data.at(6);
    return curBlock;
}
onnBlock onnObject::createBlock(qint64 pIndex,qint64 pTime,QString pHashPrev,QByteArray pData){
    onnBlock curBlock;
    curBlock.blockIndex = QByteArray::number(pIndex);
    curBlock.blockTimestamp = QByteArray::number(pTime);//QDateTime::currentMSecsSinceEpoch()
    curBlock.blockHashPrev = pHashPrev.toLatin1();
    curBlock.blockData = pData;
    curBlock.blockMaker = getPubkey();
    curBlock.blockHash = calcHash(curBlock);
    curBlock.blockMakerSign = getSignHash(curBlock.blockHash);
    return curBlock;
}
//////////////////////////////////////////////////////////////////////////////////////////
QString onnObject::doGetRandom(){
    QString result;
    _doMethodR(getContract("0"),"_doRand",QString::number(getPeerList().count()),getPubkey(),result);
    return result;
}
QString onnObject::doGetRandom(int pMax){
    QString result;
    _doMethodR(getContract("0"),"_doRand",QString::number(pMax),getPubkey(),result);
    return result;
}
bool onnObject::_doMethod(QString pContract,QString pFunction,QString pArg,QString pkey,QString &pResult){
    onnLock.lock();
    lua_State *luaInterface = getContract(pContract.toLatin1());
    if(!luaInterface){
        onnLock.unlock();
        pResult = "method fail: contract not exist";
        return false;
    }
    bool curResult = _doMethod(luaInterface,pFunction,pArg,pkey,pResult);
    onnLock.unlock();
    return curResult;
}
bool onnObject::_doMethod(lua_State *luaInterface,QString pFunction,QString pArg,QString pkey,QString &ret){
    lua_getglobal(luaInterface, "_setUser");
    lua_pushstring(luaInterface, pkey.toLatin1().data());
    if(lua_pcall(luaInterface, 1, 1, 0) != 0){
        BUG << "error _setUser" << lua_tostring(luaInterface,-1);
        ret = QString("error lua_pcall _setUser ")+QString(__LINE__)+","+pFunction+","+pArg+","+pkey;
        onnGas = lua_getGas();
        lua_resetGas();
        return false;
    }
    lua_settop(luaInterface,0);

    int arglen = 0;
    lua_getglobal(luaInterface, pFunction.toLatin1().data());
    if(pArg == "null"){
        arglen = 0;
    }else if(!pArg.contains("?")){
        arglen = 1;
        lua_pushstring(luaInterface, pArg.toLatin1().data());
    }else{
        auto curArg = pArg.split("?");
        arglen = curArg.count();
        for(int i=0;i<arglen;i++){
            lua_pushstring(luaInterface, curArg.at(i).toLatin1().data());
        }
    }
    //PrintLuaStack(luaInterface);
    if(lua_pcall(luaInterface, arglen, 1, 0) != 0){
        BUG << "error lua_pcall" << pFunction << pArg << lua_tostring(luaInterface,-1);;
        ret = QString("error lua_pcall _setUser ")+QString(__LINE__)+","+pFunction+","+pArg+","+pkey;
        onnGas = lua_getGas();
        lua_resetGas();
        return false;
    }
    if(lua_isstring(luaInterface, 1)){
        ret = lua_tostring(luaInterface, 1);
    }else if(lua_isinteger(luaInterface, 1) || lua_isnumber(luaInterface, 1)){
        ret = QString::number(lua_tointeger(luaInterface, 1));
    }else if(lua_isnumber(luaInterface, 1)){
        ret = QString::number(lua_tonumber(luaInterface, 1));
    }else{
        ret = "null";
    }
    onnGas = lua_getGas();
    lua_resetGas();
    lua_settop(luaInterface,0);
    //BUG << pFunction << onnGas;
    if(ret.left(4) == "fail")
        return false;
    return true;
}
bool onnObject::_doMethodW(lua_State *luaInterface,QString pFunction,QString pArg,QString pkey,QString &ret){
    //onnRWlock.lockForWrite();
    onnLock.lock();
    bool result = _doMethod(luaInterface,pFunction,pArg,pkey,ret);
    onnLock.unlock();
    //onnRWlock.unlock();
    return result;
}
bool onnObject::_doMethodR(lua_State *luaInterface,QString pFunction,QString pArg,QString pkey,QString &ret){
    //onnRWlock.lockForRead();
    onnLock.lock();
    bool result = _doMethod(luaInterface,pFunction,pArg,pkey,ret);
    onnLock.unlock();
    //onnRWlock.unlock();
    return result;
}
QByteArray onnObject::doMethodGet(QByteArray pMsg){
    //BUG << pMsg;
    QList<QByteArray> msgList = pMsg.split('$');
    if(msgList.count()<4){
        QString lc = "msgList.count()<4";
        return lc.toLatin1();
    }
    QString contract = msgList.at(0);
    QString method = msgList.at(1);
    QString arg = msgList.at(2);
    QString pkey = msgList.at(3);
    QString result;
    if(method.left(3) != "get"){
        QString lc = "method fail: only use get method";
        return lc.toLatin1();
    }
//    if(!hasContract(contract.toLatin1())){
//        QString lc = "method fail: contract not exist";
//        return lc.toLatin1();
//    }
    _doMethod(contract,method,QByteArray::fromHex(arg.toLatin1()),pkey,result);
    return result.toLatin1();
}
/////////////////////////////////////////////////////////////////////////////////////////////
void onnObject::addContract(QByteArray pContract,lua_State *&pInterface){
    onnReadableContract.append(pContract);
    onnObjectContract->insert(pContract,pInterface);
}

bool onnObject::hasContract(QByteArray pContract){
    return onnObjectContract->contains(pContract);
}

lua_State *onnObject::getContract(QByteArray pContract){
    return onnObjectContract->value(pContract);
}
QStringList onnObject::getContracts(){
    return onnObjectContract->keys();
}
QString onnObject::getContractOrigin(){
    QFile f("0.lua");
    f.open(QIODevice::ReadOnly);
    QByteArray data = f.readAll();
    f.close();
    return data;
}
bool onnObject::checkBlockIndexAndHash(QString pName,onnBlock curBlock){
    if(!hasContract("0")){
        return true;
    }
    if(curBlock.blockIndex.toLongLong()<=getBlock(pName).blockIndex.toLongLong()){
        BUG << "msg fail: curBlock.blockIndex<=getBlock(pName).blockIndex" << pName;
        return false;
    }else if(curBlock.blockIndex.toLongLong()>getBlock(pName).blockIndex.toLongLong()+1){
        BUG << "msg fail: curBlock.blockIndex>getBlock(pName).blockIndex+1" << curBlock.blockIndex << getBlock(pName).blockIndex;
        return false;
    }

    if(curBlock.blockHashPrev != getBlock(pName).blockHash){
        BUG << "msg fail: curBlock.blockHashPrev != getBlock(pName).blockHash" << pName;
        return false;
    }

    if(getBoss(pName.toLatin1()) != GETADDR(curBlock.blockMaker)){
        BUG << "msg fail: getBoss(pName.toLatin1()) != GETADDR(curBlock.blockMaker)" << pName;
        return false;
    }
    return true;
}
bool onnObject::checkBlockIndexAndHashDeploy(QString pName,onnBlock prvBlock,onnBlock curBlock){
    if(!hasContract("0")){
        return true;
    }
    if(curBlock.blockIndex.toLongLong()<=prvBlock.blockIndex.toLongLong()){
        BUG << "msg fail: curBlock.blockIndex<=prvBlock.blockIndex" << pName;
        return false;
    }else if(curBlock.blockIndex.toLongLong()>prvBlock.blockIndex.toLongLong()+1){
        BUG << "msg fail: curBlock.blockIndex>prvBlock.blockIndex+1" << curBlock.blockIndex << getBlock(pName).blockIndex;
        return false;
    }

    if(curBlock.blockHashPrev != prvBlock.blockHash){
        BUG << "msg fail: curBlock.blockHashPrev != prvBlock.blockHash" << pName;
        return false;
    }

    if(getBoss("0") != GETADDR(curBlock.blockMaker)){
        BUG << "msg fail: curIdentityPubkey 0 != GETADDR(curBlock.blockMaker)" << pName;
        return false;
    }
    return true;
}
bool onnObject::checkBlockNewIdentity(QString pName, QByteArray pData){
    QByteArray curBoss = getBoss(pName.toLatin1());
    if(curBoss.isEmpty()){
        return false;
    }
    if(curBoss != onnObjectKey.address){
        BUG << "send to boss" << pName << getBoss(pName.toLatin1());
        //emit doSendBlockChainData(pName,curIdentityPubkey,pData);
        emit doCustomRequire(pName,getBoss(pName.toLatin1()),"newblock",pData);
        return false;
    }
    return true;
}
//////////////////////////////////////////////////////////////////////////////////////////////
void onnObject::setBoss(QByteArray pContract,QByteArray pAddress){
    BUG << pContract << pAddress;
    if(onnBoss.contains(pContract)){
        rmBossFromAddress(onnBoss.value(pContract));
    }
    onnBoss.insert(pContract,pAddress);
    onnBossforAddress.insert(pAddress,pContract);
}
QByteArray onnObject::getBoss(QByteArray pContract){
    return onnBoss.value(pContract);
}
void onnObject::rmBoss(QByteArray pContract){
    onnBoss.remove(pContract);
}
void onnObject::rmBossFromAddress(QByteArray pAddress){
    onnBossforAddress.remove(pAddress);
}
QByteArrayList onnObject::getBossFromAddress(QByteArray pAddress){
    return onnBossforAddress.values(pAddress);
}
QByteArrayList onnObject::getBossAddressList(){
    return onnBoss.values();
}
QStringList onnObject::getBossLose(QStringList pLose){
    QStringList result;
    QByteArrayList curBossList = onnBoss.values();
    for(auto curAddress:pLose){
        if(curBossList.contains(curAddress.toLatin1())){
            if(!result.contains(curAddress)){
                result.append(curAddress);
            }
        }
    }
    return result;
}
QByteArrayList onnObject::getBossMissing(QStringList pList){
    QByteArrayList curBossList = onnBoss.values();
    for(auto curAddress:pList){
        if(curBossList.contains(curAddress.toLatin1())){
            curBossList.removeAll(curAddress.toLatin1());
        }
    }
    return curBossList;
}
QByteArrayList onnObject::getBossMissingContracts(){
    QByteArrayList result;
    QStringList curContracts = getContracts();
    for(auto curContract:curContracts){
        QByteArray curMaker = getBoss(curContract.toLatin1());
        if(!getPeerList().contains(curMaker)){
            result.append(curContract.toLatin1());
        }
    }
    return result;
}
QStringList onnObject::getOnlyWork(QStringList pList){
    QStringList result;
    QByteArrayList curBossList = getBossAddressList();
    for(auto curAddress:pList){
        if(!curBossList.contains(curAddress.toLatin1())){
            result.append(curAddress);
        }
    }
    return result;
}
//////////////////////////////////////////////////////////////////////////////////////////////
void onnObject::initNetSync(){
    onnSync = new NetSync();
    onnSync->Init(GETADDR(getPubkey()));
}
NetSync *onnObject::getNetSync(){
    return onnSync;
}
////////////////////////////////////////////////////////////////////////////////////////////////
void onnObject::initWebsocketd(){
    onnWebsocket->onConnection([&](uWS::WebSocket<uWS::SERVER> *ws, HttpRequest) {
        cout << ws->getAddress().address << endl;
        if(onnWebsocketAddress.contains(ws->getAddress().address)){
            ws->close();
        }else{
            onnWebsocketAddress.append(ws->getAddress().address);
            onnWebsocketPeers.append(QByteArray(ws->getAddress().address).remove(0,7)+":"+QByteArray::number(ws->getAddress().port));
        }
    });
    onnWebsocket->onDisconnection([&](uWS::WebSocket<uWS::SERVER> *ws, int, char *, size_t) {
        onnWebsocketAddress.removeAll(ws->getAddress().address);
        onnWebsocketPeers.removeAll(QByteArray(ws->getAddress().address)+":"+QByteArray::number(ws->getAddress().port));
    });
}
Hub *onnObject::getWebsocketd(){
    return onnWebsocket;
}
//////////////////////////////////////////////////////////////////////////////////////////////
void onnObject::setSyncQueue(QByteArray pContract,QByteArray pAddress,QByteArray pKey,QByteArray pStart,QByteArray pEnd){
    onnSyncQueue queue;
    queue.blockContract = pContract;
    queue.blockAddress = pAddress;
    queue.blockStart = pStart;
    queue.blockEnd = pEnd;
    queue.blockLastModify = QDateTime::currentMSecsSinceEpoch();
    if(pKey=="request"){
        onnSyncRequestCount++;
        onnSyncRequest.insert(pContract+"-"+pAddress+"-"+pKey,queue);
    }else if(pKey=="response"){
        onnSyncResponseCount++;
        onnSyncResponse.insert(pContract+"-"+pAddress+"-"+pKey,queue);
    }
    //onnSyncData.insert(pContract+"-"+pAddress+"-"+pKey,queue);
}
bool onnObject::updSyncQueueIndex(QByteArray pContract,QByteArray pAddress,QByteArray pKey,QByteArray pIndex){
    onnSyncQueue curData;// = onnSyncData.value(pContract+"-"+pAddress+"-"+pKey);
    if(pKey=="request"){
        curData = onnSyncRequest.value(pContract+"-"+pAddress+"-"+pKey);
    }else if(pKey=="response"){
        curData = onnSyncResponse.value(pContract+"-"+pAddress+"-"+pKey);
    }
    if(curData.blockCurrentIndex.toLongLong()<pIndex.toLongLong()){
        curData.blockCurrentIndex = pIndex;
        curData.blockLastModify = QDateTime::currentMSecsSinceEpoch();
    }else{
        return true;
    }
    if(pKey=="request"){
        onnSyncRequest.insert(pContract+"-"+pAddress+"-"+pKey,curData);
    }else if(pKey=="response"){
        onnSyncResponse.insert(pContract+"-"+pAddress+"-"+pKey,curData);
    }
    //onnSyncData.insert(pContract+"-"+pAddress+"-"+pKey,curData);
    if(pIndex.toLongLong()>=curData.blockEnd.toLongLong()){
        return false;
    }else{
        return true;
    }
}
onnSyncQueue onnObject::getSyncQueue(QByteArray pContract,QByteArray pAddress,QByteArray pKey){
    if(hasSyncQueue(pContract,pAddress,pKey)){
        if(pKey=="request"){
            return onnSyncRequest.value(pContract+"-"+pAddress+"-"+pKey);
        }else if(pKey=="response"){
            return onnSyncResponse.value(pContract+"-"+pAddress+"-"+pKey);
        }
        //return onnSyncData.value(pContract+"-"+pAddress+"-"+pKey);
    }
    return onnSyncQueue();
}
onnSyncQueue onnObject::getSyncQueue(QStringList pList){
    QByteArray pContract = pList.at(0).toLatin1();
    QByteArray pAddress = pList.at(1).toLatin1();
    QByteArray pKey = pList.at(2).toLatin1();
    if(hasSyncQueue(pContract,pAddress,pKey)){
        if(pKey=="request"){
            return onnSyncRequest.value(pContract+"-"+pAddress+"-"+pKey);
        }else if(pKey=="response"){
            return onnSyncResponse.value(pContract+"-"+pAddress+"-"+pKey);
        }
        //return onnSyncData.value(pContract+"-"+pAddress+"-"+pKey);
    }
    return onnSyncQueue();
}
QList<onnSyncQueue> onnObject::getSyncQueueList(QByteArray pContract,QByteArray pType){
    QList<onnSyncQueue> result;
    for(auto curData:onnSyncRequest.keys()){
        QStringList curLiist = curData.split("-");
        if(curLiist.first() == pContract && curLiist.last() == pType && curLiist.count() == 3){
            result.append(getSyncQueue(curLiist));
        }
    }
    return result;
}
bool onnObject::hasSyncQueueRequest(QByteArray pContract){
    for(auto curData:onnSyncRequest.keys()){
        if(curData.split("-").first() == pContract){
            return true;
        }
    }
    return false;
}
bool onnObject::hasSyncQueue(QByteArray pContract,QByteArray pAddress,QByteArray pKey){
    if(pKey=="request"){
        if(onnSyncRequest.contains(pContract+"-"+pAddress+"-"+pKey)){
            return true;
        }
    }else if(pKey=="response"){
        if(onnSyncResponse.contains(pContract+"-"+pAddress+"-"+pKey)){
            return true;
        }
    }
//    if(onnSyncData.contains(pContract+"-"+pAddress+"-"+pKey)){
//        return true;
//    }
    return false;
}
void onnObject::rmSyncQueue(QByteArray pContract,QByteArray pAddress,QByteArray pKey){
    //onnSyncData.remove(pContract+"-"+pAddress+"-"+pKey);
    if(pKey=="request"){
        onnSyncRequestCount--;
        onnSyncRequest.remove(pContract+"-"+pAddress+"-"+pKey);
    }else if(pKey=="response"){
        onnSyncResponseCount--;
        onnSyncResponse.remove(pContract+"-"+pAddress+"-"+pKey);
    }
}
void onnObject::rmSyncLose(QStringList pLose){
    for(auto curAddress:pLose){
        for(auto curContract:getContracts()){
            if(hasSyncQueue(curContract.toLatin1(),curAddress.toLatin1(),QString("request").toLatin1())){
                rmSyncQueue(curContract.toLatin1(),curAddress.toLatin1(),QString("request").toLatin1());
            }
            if(hasSyncQueue(curContract.toLatin1(),curAddress.toLatin1(),QString("response").toLatin1())){
                rmSyncQueue(curContract.toLatin1(),curAddress.toLatin1(),QString("response").toLatin1());
            }
        }
    }
}
int onnObject::getSyncRequestCount(){
    return onnSyncRequestCount;
}
int onnObject::getSyncResponseCount(){
    return onnSyncResponseCount;
}
//////////////////////////////////////////////////////////////////////////////////////////////
void onnObject::appendChangeBossRequest(QByteArray pBoss, QByteArray pData){
    onnChangeBossData.insertMulti(pBoss,pData);
}
bool onnObject::hasChangeBossRequest(QByteArray pBoss){
    return onnChangeBossData.contains(pBoss);
}
bool onnObject::hasChangeBossWorkerRequest(QByteArray pRequest){
    if(!onnChangeBossData.isEmpty())
        return onnChangeBossData.values().contains(pRequest);
    return false;
}
QByteArrayList onnObject::getChangeBossRequest(QByteArray pBoss){
    if(onnChangeBossData.contains(pBoss)){
        return onnChangeBossData.values(pBoss);
    }
    return QByteArrayList();
}
void onnObject::rmChangeBossRequest(QByteArray pBoss){
    onnChangeBossData.remove(pBoss);
}
double onnObject::getContractBalance(QByteArray pContract,QByteArray pAddress){
    if(!hasContract(pContract)){
        return 0;
    }
    QString result;
    if(_doMethodR(getContract(pContract),"_getBalanceOf",pAddress,pAddress,result)){
        if(result=="fail")
            return 0;
        return result.toDouble();
    }
    return 0;
}
double onnObject::getOnnBalance(QByteArray pAddr){
    QString result;
    if(_doMethodR(getContract("0"),"_getBalanceOf",pAddr,pAddr,result)){
        return result.toDouble();
    }
    return 0;
}
QByteArray onnObject::getOnnBossOwner(QByteArray pBoss){
    QString result;
    if(!hasContract(pBoss)){
        return "";
    }
    if(_doMethodR(getContract(pBoss),"_getOwner","null",onnObjectKey.address,result)){
        return result.toLatin1();
    }
    return "";
}
QByteArray onnObject::getOnnBossTotal(QByteArray pSymbol){
    QString result;
    if(!hasContract(pSymbol)){
        return "fail";
    }
    if(_doMethodR(getContract(pSymbol),"_getTotal","null",onnObjectKey.address,result)){
        return result.toLatin1();
    }
    return "fail";
}
QByteArray onnObject::getOnnBossMaker(QByteArray pSymbol){
    QString result;
    if(!hasContract(pSymbol)){
        return "fail";
    }
    if(_doMethodR(getContract(pSymbol),"getBossMaker",pSymbol,onnObjectKey.address,result)){
        return result.toLatin1();
    }
    return "fail";
}
QByteArray onnObject::setOnnBossMaker(QByteArray pSymbol, QByteArray pAddress){
    QString result;
    if(!hasContract(pSymbol)){
        return "fail";
    }
    if(_doMethodW(getContract(pSymbol),"setBossMaker",pSymbol+"?"+pAddress,onnObjectKey.address,result)){
        setBoss(pSymbol,pAddress);
        return result.toLatin1();
    }
    return "fail";
}
QString onnObject::setNextBoss(QString pArg){
    QString curResult;
    _doMethodW(getContract("0"),"_setNextBoss",pArg,onnObjectKey.address,curResult);
    if(curResult.isEmpty() || curResult.left(4) == "fail"){
        BUG << curResult;
        curResult = "fail";
    }
    return curResult;
}
QString onnObject::setDeployBoss(QString pArg, QString pKey){
    QString curResult;
    if(!_doMethodW(getContract("0"),"_setDeployBoss",pArg,pKey,curResult)){
        BUG << "fail";
        return "fail";
    }
    if(curResult.isEmpty() || curResult.left(4) == "fail"){
        BUG << curResult;
        curResult = "fail";
    }
    return curResult;
}
QString onnObject::setPeers(){
    QString curResult;
    _doMethodW(getContract("0"),"_setPeers",getPeerList().join(","),onnObjectKey.address,curResult);
    return curResult;
}
QByteArray onnObject::doOnnTransfer(QByteArray pSender,QByteArray pRecver,QByteArray pNumber){
    QString result;
    if(!hasContract("0")){
        return "fail";
    }
    if(_doMethodW(getContract("0"),"transfer",pRecver+"?"+pNumber,pSender,result)){
        return result.toLatin1();
    }
    return "fail";
}
bool onnObject::doOnnDestroy(QString pSymbol,QString pKey){
    QString result;
    if(!hasContract(pSymbol.toLatin1())){
        return false;
    }
    return _doMethodW(getContract(pSymbol.toLatin1()),"_destroy",pSymbol,pKey,result);
}
QMultiMap<qint64,QString> onnObject::getOnnBalanceUserList(QStringList pList){
    QMultiMap<qint64,QString> result;
    for(auto curAddr:pList){
        double curBalance = getOnnBalance(curAddr.toLatin1());
        result.insertMulti(curBalance,curAddr);
    }
    return result;
}
QStringList onnObject::getHaveBalanceWorker0(QStringList pList,qint64 pNumber){
    QStringList result;
    for(auto curPeer:pList){
        if(getOnnBalance(curPeer.toLatin1())<(double)pNumber){
            continue;
        }
        result.append(curPeer);
    }
    return result;
}
bool onnObject::checkCustomNetData(QByteArray pData, QByteArray pType, onnData &pResult){
    QList<QByteArray> listCmd = pData.split('&');
    if(listCmd.count()<2){
        BUG << "bad data: listCmd.count()<2" << pData;
        return false;
    }
    QByteArray sign = listCmd.at(0);
    QByteArray data = listCmd.at(1);
    QList<QByteArray> listData = data.split('$');
    if(listData.count()<5){
        BUG << "bad data: listData.count()<5" << pData;
        return false;
    }

    QByteArray type = listData.at(0);
    QByteArray pubkey = listData.at(1);
    QByteArray name = listData.at(2);
    QByteArray code = listData.at(3);
    QByteArray arg  = listData.at(4);

    if(!getVerify(pubkey,data,sign)){
        BUG << "msg fail: verify fail";
        return false;
    }

    if(!hasBlock(name)){
        BUG << "msg fail: !hasBlock(name)";
        return false;
    }

    if(type != pType){
        BUG << "msg fail: type !=" << pType;
        return false;
    }
    pResult.blockPubkey = pubkey;
    pResult.blockContract = name;
    pResult.blockType = pType;
    pResult.blockTarget = arg;
    onnBlock curBlock;
    curBlock.blockData = pData;
    pResult.block = curBlock;

    return true;
}
//////////////////////////////////////////////////////////////////////////////////////////////
void onnObject::onBlockOld(QByteArray pData){
    BUG;
    onnBlock curBlock = createBlock(pData);
    QByteArray curData = curBlock.blockData;

    QList<QByteArray> listCmd = curData.split('&');
    if(listCmd.count()<2){
        BUG << "bad data: listCmd.count()<2" << pData;
        return;
    }
    QByteArray sign = listCmd.at(0);
    QByteArray data = listCmd.at(1);
    QList<QByteArray> listData = data.split('$');
    if(listData.count()<5){
        BUG << "bad data: listData.count()<5" << pData;
        return;
    }

    QByteArray tgtData = "$";
    tgtData = tgtData+listData.at(listData.count()-2)+"$"+listData.last();
    data.remove(data.count()-tgtData.count(),tgtData.count());

    QByteArray type = listData.at(0);
    QByteArray pubkey = listData.at(1);
    QByteArray name = listData.at(2);
    QByteArray code = listData.at(3);
    QByteArray arg = QByteArray::fromHex(listData.at(4));
    QByteArray maker = curBlock.blockMaker;
    QByteArray makerSign = curBlock.blockMakerSign;
    QByteArray curBlockData =  onnObject::getHash(curBlock.blockIndex+\
                                                  curBlock.blockTimestamp+\
                                                  curBlock.blockHashPrev+\
                                                  curBlock.blockData+\
                                                  curBlock.blockMaker).toHex();
    BUG << curBlock.blockIndex << pubkey << data << sign;
    if(code == "init"){
        BUG << "bad block old: can not call init" << name;
        return;
    }
    if(getVerify(pubkey,data,sign)){
        BUG << "msg fail: verify fail" << pData;
        return;
    }

    if(getVerify(maker,curBlockData,makerSign)){
        BUG << "msg fail: maker verify fail" << pData;
        return;
    }

    if(type == "deploy"){
        if(hasBlock(name)){
            BUG << "bad deploy: contract exist" << name;
            return;
        }
        emit doDeployOld(pData);
    }else if(type == "method"){
        if(!hasBlock(name)){
            BUG << "bad method: contract not exist" << name;
            return;
        }
        if(code.left(3) == "get" || code.left(1) == "_"){
            BUG << "bad method: can not run private or get" << code ;
            return;
        }
        emit doMethodOld(pData);
    }else if(type == "peer"){
        if(!getBossFromAddress(GETADDR(maker)).contains("0")){
            BUG << "bad 0: maker != 0" << maker ;
            return;
        }
        emit doPeerOld(pData);
    }else if(type == "destroy"){
        if(!hasContract(name)){
            BUG << "bad destroy: contract not exist" << name;
            return;
        }
        if(maker != getBoss("0")){
            BUG << "bad destroy: maker != boss 0" << maker << getBoss("0");
            return;
        }
        emit doDestroyOld(pData);
    }else{
        BUG << "unknow type" << type;
    }
}
void onnObject::onDestroyOld(QByteArray pData){
    onnBlock curBlock = createBlock(pData);
    if(flagStart){
        QByteArray curHash = GETSHA256(curBlock.blockData);
        if(getDatabaseBlock(curHash) != "null"){
            BUG << "bad destroy old: hash data exist" << curHash;
            return;
        }else{
            setDatabaseBlock(curHash,curHash);
        }
    }
    QList<QByteArray> pList = curBlock.blockData.split('$');
    QString name = pList.at(2);
    QString codeHex = pList.at(3);
    QString arg = QByteArray::fromHex(pList.at(4));
    QString key = GETADDR(pList.at(1));
    if(!hasContract(name.toLatin1())){
        BUG << "bad destroy: contract not exist" << name;
        return;
    }
    if(!doOnnDestroy(name,key)){
        BUG << "doOnnDestroy fail";
        return;
    }
    lua_State *curContract = getContract(arg.toLatin1());
    lua_close(curContract);
    onnObjectContract->remove(arg);
    rmBoss(arg.toLatin1());
    insertBlock("0",curBlock);
    emit doDestroyOldOK(pData);
}
void onnObject::onDeployOld(QByteArray pData){
    onnBlock curBlock = createBlock(pData);
    if(flagStart){
        QByteArray curHash = GETSHA256(curBlock.blockData);
        if(getDatabaseBlock(curHash) != "null"){
            BUG << "bad deploy old: hash data exist" << curHash;
            return;
        }else{
            setDatabaseBlock(curHash,curHash);
        }
    }
    QList<QByteArray> pList = curBlock.blockData.split('$');
    QString name = pList.at(2);
    QString codeHex = pList.at(3);
    QString arg = QByteArray::fromHex(pList.at(4));
    QString key = GETADDR(pList.at(1));
    if(hasContract(name.toLatin1())){
        BUG << "bad deploy: contract exist" << pData;
        return;
    }
    if(!checkBlockIndexAndHashDeploy(name,getBlock("0"),curBlock)){
        return;
    }
    QString code;
    if(codeHex.contains("i")){
        code = codeHex;
    }else{
        code = QByteArray::fromHex(codeHex.toLatin1());
    }
    if(code.contains("_G") && name != "0"){
        BUG << "bad deploy: contains _G" << name;
        return;
    }
    QString codeCost = QString::number(code.count()*2);
    //code.push_front(contractHead);
    lua_State *luaInterface = luaL_newstate();
    luaL_openlibs1(luaInterface);
    luaL_dostring(luaInterface,code.toLatin1().data());
    QString result;
    QString resultInit;
    if(!_doMethodW(luaInterface,"init",arg,key,resultInit)){
        lua_close(luaInterface);
        return;
    }
    QString curTotal;
    if(_doMethodR(luaInterface,"_getTotal","null",onnObjectKey.address,result)){
        curTotal = result;
    }else{
        curTotal = "0";
        BUG << "_getTotal fail" << result;
        lua_close(luaInterface);
        return;
    }
    if(!getContracts().isEmpty()){
        //result = setDeployBoss(name+"?10000?"+curTotal+"?"+codeCost,key);
        if(_doMethodW(getContract("0"),"_setDeployBoss",name+"?10000?"+curTotal+"?"+codeCost,key,result)){
            BUG << "setDeployBoss ok";
            setBoss(name.toLatin1(),result.toLatin1());
        }else{
            BUG << "setDeployBoss fail" << result;
            lua_close(luaInterface);
            return;
        }
    }
    if(flagStart && !resultInit.isEmpty() && resultInit != "null"){
        BUG << "doBroadcastAppNew" << resultInit;
        emit doBroadcastAppNew(resultInit.toLatin1());
    }
    if(getContracts().isEmpty()){
        setBoss("0",key.toLatin1());
    }
    emit doSetBossList(getBossAddressList());
    addContract(name.toLatin1(),luaInterface);
    insertBlock("0",curBlock);
    insertBlock(name.toLatin1(),curBlock);
    emit doDeployOldOK(name.toLatin1(),pData);
}
void onnObject::onMethodOld(QByteArray pData){
    onnBlock curBlock = createBlock(pData);
    if(flagStart){
        QByteArray curHash = GETSHA256(curBlock.blockData);
        if(getDatabaseBlock(curHash) != "null"){
            BUG << "bad method old: hash data exist" << curHash;
            return;
        }else{
            setDatabaseBlock(curHash,curHash);
        }
    }
    QList<QByteArray> pList = curBlock.blockData.split('$');
    QString name = pList.at(2);
    QString code = pList.at(3);
    QString arg = QByteArray::fromHex(pList.at(4));
    QString key = GETADDR(pList.at(1));
    QString result;
    if(!checkBlockIndexAndHash(name,curBlock)){
        return;
    }
    if(_doMethodW(getContract(name.toLatin1()),code,arg,key,result)){
        insertBlock(name.toLatin1(),curBlock);
        emit doMethodOldOK(name.toLatin1(),pData);
        if(flagStart){
            if(!result.isEmpty() && result != "null"){
                emit doBroadcastAppNew(result.toLatin1());
            }
        }else{
            if(!result.isEmpty() && result != "null"){
                emit doBroadcastAppOld(result.toLatin1());
            }
        }
    }
}
void onnObject::onPeerOld(QByteArray pData){
    //BUG << pData;
    onnBlock curBlock = createBlock(pData);
    if(flagStart){
        QByteArray curHash = GETSHA256(curBlock.blockData);
        if(getDatabaseBlock(curHash) != "null"){
            BUG << "bad peer old: hash data exist" << curHash;
            return;
        }else{
            setDatabaseBlock(curHash,curHash);
        }
    }
    if(!checkBlockIndexAndHash("0",curBlock)){
        return;
    }
    QList<QByteArray> pList = curBlock.blockData.split('$');
    QByteArray arg = QByteArray::fromHex(pList.at(4));
    if(arg.contains('?')){
        QByteArrayList argList = arg.split('?');
        setPeerList(QString(argList.at(0)).split(","));
        setPeerLose(QString(argList.at(1)).split(","));
    }else{
        setPeerList(QString(arg).split(","));
    }
    setPeers();
    QByteArrayList curContractList = getBossMissingContracts();
    if(!curContractList.isEmpty())
        onBossMissing(curContractList);
    insertBlock("0",curBlock);
    emit doPeerOldOK(pData);
}
QStringList onnObject::getReadableContract(){
    return onnReadableContract;
}
bool onnObject::doFinishReadable(QString pContract){
    onnReadableContract.removeAll(pContract);
    QString curReadableContract;
    onnBlock prvBlock;
    onnBlock curBlock;
    QByteArray curValue;
    if(onnReadableContract.isEmpty()){
        flagStart = true;
        emit doStartFinish();
        return true;
    }else{
        while(!onnReadableContract.isEmpty()){
            onnBossBlock curBossBlock = getBossBlock(onnReadableContract.first());
            curReadableContract = curBossBlock.name;
            prvBlock = curBossBlock.blockDeploy;
            curValue = getDatabaseBlock(curBossBlock.name+"-"+QByteArray::number(prvBlock.blockIndex.toLongLong()+1));
            if(curValue == "null"){
                onnReadableContract.removeAll(curBossBlock.name);
            }else{
                curBlock = createBlock(curValue);
                break;
            }
        }
        if(onnReadableContract.isEmpty()){
            flagStart = true;
            emit doStartFinish();
            return true;
        }
    }
    if(curBlock.blockIndex.toLongLong()!=prvBlock.blockIndex.toLongLong()+1){
        BUG << curReadableContract << "curBlock.blockIndex.toLongLong()!=prvBlock.blockIndex.toLongLong()+1";
        return doFinishReadable(curReadableContract);
    }
    if(curBlock.blockHashPrev!=prvBlock.blockHash){
        BUG << curReadableContract << "curBlock.blockHashPrev!=prvBlock.blockHash";
        return doFinishReadable(curReadableContract);
    }
    emit doBlockOld(curValue);
    return false;
}
void onnObject::onPeerOldOK(QByteArray pData){
    onnBlock curBlock1 = createBlock(pData);
    if(getDatabaseBlock(QByteArray("0-")+curBlock1.blockIndex)=="null"){
        setDatabaseBlock(QByteArray("0-")+curBlock1.blockIndex,pData);
    }
    BUG << curBlock1.blockIndex;
    if(flagStart){
        return;
    }
    qint64 i = curBlock1.blockIndex.toLongLong()+1;
    QByteArray curKey = "0-";
    QByteArray prvValue = pData;
    QByteArray curValue = getDatabaseBlock(curKey+QByteArray::number(i));
    if(i==1){
        prvValue = getBlock0();
    }
    onnBlock curBlock;
    onnBlock prvBlock;
    if(curValue == "null"){
        doFinishReadable("0");
        return;
    }else{
        curBlock = createBlock(curValue);
        prvBlock = createBlock(prvValue);
    }
    if(curBlock.blockIndex.toLongLong()!=prvBlock.blockIndex.toLongLong()+1){
        BUG << "curBlock.blockIndex.toLongLong()!=prvBlock.blockIndex.toLongLong()+1";
        doFinishReadable("0");
        return;
    }
    if(curBlock.blockHashPrev!=prvBlock.blockHash){
        BUG << "curBlock.blockHashPrev!=prvBlock.blockHash";
        doFinishReadable("0");
        return;
    }
    emit doBlockOld(curValue);
}
void onnObject::onDeployOldOK(QByteArray pContract,QByteArray pData){
    onnBlock curBlock1 = createBlock(pData);
    if(getDatabaseBlock(pContract+"-"+curBlock1.blockIndex)=="null"){
        setDatabaseBlock(pContract+"-"+curBlock1.blockIndex,pData);
    }
    if(getDatabaseBlock(QByteArray("0-")+curBlock1.blockIndex)=="null"){
        setDatabaseBlock(QByteArray("0-")+curBlock1.blockIndex,pData);
    }
    BUG << pContract << curBlock1.blockIndex;
    if(flagStart){
        return;
    }
    qint64 i = curBlock1.blockIndex.toLongLong()+1;
    QByteArray curKey = "0-";
    QByteArray prvValue = pData;
    QByteArray curValue = getDatabaseBlock(curKey+QByteArray::number(i));
    if(i==1){
        prvValue = getBlock0();
    }
    if(curValue == "null"){
        doFinishReadable("0");
        return;
    }
    onnBlock curBlock = createBlock(curValue);
    onnBlock prvBlock = createBlock(prvValue);
    if(curBlock.blockIndex.toLongLong()!=prvBlock.blockIndex.toLongLong()+1){
        BUG << "curBlock.blockIndex.toLongLong()!=prvBlock.blockIndex.toLongLong()+1";
        doFinishReadable("0");
        return;
    }
    if(curBlock.blockHashPrev!=prvBlock.blockHash){
        BUG << "curBlock.blockHashPrev!=prvBlock.blockHash";
        doFinishReadable("0");
        return;
    }
    emit doBlockOld(curValue);
}
void onnObject::onMethodOldOK(QByteArray pContract,QByteArray pData){
    onnBlock curBlock1 = createBlock(pData);
    if(getDatabaseBlock(pContract+"-"+curBlock1.blockIndex)=="null"){
        setDatabaseBlock(pContract+"-"+curBlock1.blockIndex,pData);
    }
    BUG << pContract << curBlock1.blockIndex;
    if(flagStart){
        return;
    }
    qint64 i = curBlock1.blockIndex.toLongLong()+1;
    QByteArray curKey = pContract+"-";
    QByteArray prvValue = pData;
    QByteArray curValue = getDatabaseBlock(curKey+QByteArray::number(i));
    if(i==1){
        prvValue = getBlock0();
    }
    if(curValue == "null"){
        doFinishReadable(pContract);
        return;
    }
    onnBlock curBlock = createBlock(curValue);
    onnBlock prvBlock = createBlock(prvValue);
    if(curBlock.blockIndex.toLongLong()!=prvBlock.blockIndex.toLongLong()+1){
        BUG << "curBlock.blockIndex.toLongLong()!=prvBlock.blockIndex.toLongLong()+1";
        doFinishReadable(pContract);
        return;
    }
    if(curBlock.blockHashPrev!=prvBlock.blockHash){
        BUG << "curBlock.blockHashPrev!=prvBlock.blockHash";
        doFinishReadable(pContract);
        return;
    }
    emit doBlockOld(curValue);
}
void onnObject::onDestroyOldOK(QByteArray pData){
    onnBlock curBlock1 = createBlock(pData);
    if(getDatabaseBlock(QByteArray("0-")+curBlock1.blockIndex)=="null"){
        setDatabaseBlock(QByteArray("0-")+curBlock1.blockIndex,pData);
    }
    BUG << curBlock1.blockIndex;
    if(flagStart){
        return;
    }
    qint64 i = curBlock1.blockIndex.toLongLong()+1;
    QByteArray curKey = "0-";
    QByteArray prvValue = pData;
    QByteArray curValue = getDatabaseBlock(curKey+QByteArray::number(i));
    if(i==1){
        prvValue = getBlock0();
    }
    if(curValue == "null"){
        doFinishReadable("0");
        return;
    }
    onnBlock curBlock = createBlock(curValue);
    onnBlock prvBlock = createBlock(prvValue);
    if(curBlock.blockIndex.toLongLong()!=prvBlock.blockIndex.toLongLong()+1){
        BUG << "curBlock.blockIndex.toLongLong()!=prvBlock.blockIndex.toLongLong()+1";
        doFinishReadable("0");
        return;
    }
    if(curBlock.blockHashPrev!=prvBlock.blockHash){
        BUG << "curBlock.blockHashPrev!=prvBlock.blockHash";
        doFinishReadable("0");
        return;
    }
    emit doBlockOld(curValue);
}

void onnObject::onBlockNew(QByteArray pData){
    QList<QByteArray> listCmd = pData.split('&');
    if(listCmd.count()<2){
        BUG << "bad data: listCmd.count()<2" << pData;
        return;
    }
    QByteArray sign = listCmd.at(0);
    QByteArray data = listCmd.at(1);
    QList<QByteArray> listData = data.split('$');
    if(listData.count()<5){
        BUG << "bad data: listData.count()<5" << pData;
        return;
    }

    QByteArray type = listData.at(0);
    QByteArray pubkey = listData.at(1);
    QByteArray name = listData.at(2);
    QByteArray code = listData.at(3);
    QByteArray arg = QByteArray::fromHex(listData.at(4));

/*
    QByteArray curIdentityPubkey = GETADDR(getIdentity(name).toLatin1());
    if(curIdentityPubkey != onnObjectKey.address){
        BUG << "send to boss" << name;
        emit doSendBlockChainData(name,curIdentityPubkey,pData);
        return;
    }
*/
    if(code == "init"){
        BUG << "bad block new: can not call init" << name;
        return;
    }
    if(!getVerify(pubkey,data,sign)){
        BUG << "msg fail: verify fail" << pData;
        return;
    }

    if(type == "deploy"){
        if(hasContract(name)){
            BUG << "bad deploy: contract exist" << name;
            return;
        }
        emit doDeployNew(pData);
    }else if(type == "method"){
        if(code.left(3) == "get" || code.left(1) == "_"){
            BUG << "bad method: can not run private or get" << code ;
            return;
        }
        emit doMethodNew(pData);
    }else if(type == "peer"){
        if(name != "0"){
            BUG << "bad deploy: only 0 can update peer" << name;
            return;
        }
        emit doPeerNew(pData);
    }else if(type == "destroy"){
        if(!hasContract(name)){
            BUG << "bad destroy: contract not exist" << name;
            return;
        }
        emit doDestroyNew(pData);
    }else{
        BUG << "Unknow" << name << type;
    }
}
void onnObject::onDestroyNew(QByteArray pData){
    QByteArray curHash = GETSHA256(pData);
    if(getDatabaseBlock(curHash) != "null"){
        BUG << "bad destroy: hash data exist" << curHash;
        return;
    }
    QList<QByteArray> pList = pData.split('$');
    QString name = pList.at(2);
    QString codeHex = pList.at(3);
    QString arg = QByteArray::fromHex(pList.at(4));
    QString key = GETADDR(pList.at(1));
    if(!hasContract(name.toLatin1())){
        BUG << "bad destroy: contract not exist" << name;
        return;
    }
    if(getBoss("0") != onnObjectKey.address){
        BUG << "send to boss 0" << getBoss("0");
        emit doCustomRequire(name,getBoss("0"),"newblock",pData);
        return;
    }
    if(!doOnnDestroy(name,key)){
        BUG << "doOnnDestroy fail";
        return;
    }
    lua_State *curContract = getContract(arg.toLatin1());
    lua_close(curContract);
    onnObjectContract->remove(arg);
    rmBoss(arg.toLatin1());
    onnBlock curBlock = createBlock(getBlock("0").blockIndex.toLongLong()+1,\
                                    QDateTime::currentMSecsSinceEpoch(),\
                                    getBlock("0").blockHash,\
                                    pData);
    insertBlock("0",curBlock);
    setDatabaseBlock(curHash,curHash);
    emit doDestroyNewOK(toString(curBlock));
}
void onnObject::onDeployNew(QByteArray pData){
    if(!getBossMissing(getPeerList()).isEmpty()){
        BUG << "bad deploy: an contract boss is missing" << getBossMissing(getPeerList());
        return;
    }
    QByteArray curHash = GETSHA256(pData);
    if(getDatabaseBlock(curHash) != "null"){
        BUG << "bad deploy: hash data exist" << curHash;
        return;
    }
    QList<QByteArray> pList = pData.split('$');
    QString name = pList.at(2);
    QString codeHex = pList.at(3);
    QString arg = QByteArray::fromHex(pList.at(4));
    QString key = GETADDR(pList.at(1));
    if(hasContract(name.toLatin1())){
        BUG << "bad deploy: contract exist" << name;
        return;
    }
    if(getBoss("0") != onnObjectKey.address){
        BUG << "send to boss" << name << getBoss("0");
        emit doCustomRequire(name,getBoss("0"),"newblock",pData);
        return;
    }
    QString code;
    if(codeHex.contains("i")){
        code = codeHex;
    }else{
        code = QByteArray::fromHex(codeHex.toLatin1());
    }
    if(code.contains("_G")){
        BUG << "bad deploy: contains _G" << name;
        return;
    }
    /*
    if(code.contains("require")){
        BUG << "bad deploy: contains require" << name;
        return;
    }
    */
    if(hasSyncQueueRequest("0")){
        BUG << "bad deploy: hasSyncQueueRequest 0";
        return;
    }
    QString codeCost = QString::number(code.count()*2);
    //code.push_front(contractHead);
    lua_State *luaInterface = luaL_newstate();
    luaL_openlibs1(luaInterface);
    luaL_dostring(luaInterface,code.toLatin1().data());
    QString result;
    QString resultInit;
    if(!_doMethodW(luaInterface,"init",arg,key,resultInit)){
        lua_close(luaInterface);
        return;
    }
    QString curTotal;
    if(_doMethodR(luaInterface,"_getTotal","null",onnObjectKey.address,result)){
        curTotal = result;
    }else{
        curTotal = "0";
    }
    if(curTotal == "0"){
        lua_close(luaInterface);
        return;
    }
    result = setDeployBoss(name+"?10000?"+curTotal+"?"+codeCost,key);
    if(result == "fail"){
        BUG << "setDeployBoss fail";
        lua_close(luaInterface);
        return;
    }else{
        BUG << "setDeployBoss ok";
        setBoss(name.toLatin1(),result.toLatin1());
    }
    if(!resultInit.isEmpty() && resultInit != "null"){
        BUG << "doBroadcastAppNew" << resultInit;
        emit doBroadcastAppNew(resultInit.toLatin1());
    }
    emit doSetBossList(getBossAddressList());
    addContract(name.toLatin1(),luaInterface);
    onnBlock curBlock = createBlock(getBlock("0").blockIndex.toLongLong()+1,\
                                    QDateTime::currentMSecsSinceEpoch(),\
                                    getBlock("0").blockHash,\
                                    pData);
    insertBlock("0",curBlock);
    insertBlock(name.toLatin1(),curBlock);
    setDatabaseBlock(curHash,curHash);
    emit doDeployNewOK(name.toLatin1(),toString(curBlock));
}
void onnObject::onMethodNew(QByteArray pData){
    QByteArray curHash = GETSHA256(pData);
    if(getDatabaseBlock(curHash) != "null"){
        BUG << "bad method: hash data exist" << curHash;
        return;
    }
    QList<QByteArray> pList = pData.split('$');
    QString name = pList.at(2);
    QString code = pList.at(3);
    QString arg = QByteArray::fromHex(pList.at(4));
    QString key = GETADDR(pList.at(1));
    QString result;
    if(name == "0" && code == "transfer" && !getBossMissing(getPeerList()).isEmpty()){
        BUG << "bad method: an contract boss is missing" << getBossMissing(getPeerList());
        return;
    }
    if(!checkBlockNewIdentity(name,pData)){
        return;
    }
    if(hasSyncQueueRequest(name.toLatin1())){
        BUG << "bad method: hasSyncQueueRequest" << name;
        return;
    }
    if(_doMethodW(getContract(name.toLatin1()),code,arg,key,result)){
        onnBlock curBlock = createBlock(getBlock(name.toLatin1()).blockIndex.toLongLong()+1,\
                                        QDateTime::currentMSecsSinceEpoch(),\
                                        getBlock(name.toLatin1()).blockHash,\
                                        pData);
        insertBlock(name.toLatin1(),curBlock);
        emit doMethodNewOK(name.toLatin1(),toString(curBlock));
        if(!result.isEmpty() && result != "null"){
            BUG << "doBroadcastAppNew" << result;
            emit doBroadcastAppNew(result.toLatin1());
        }
        setDatabaseBlock(curHash,curHash);
    }
}
void onnObject::onPeerNew(QByteArray pData){
    QByteArray curHash = GETSHA256(pData);
    if(getDatabaseBlock(curHash) != "null"){
        BUG << "bad peer: hash data exist" << curHash;
        return;
    }
    if(!getPeerList().isEmpty() && !getBossMissing(getPeerList()).isEmpty()){
        BUG << "bad peer: an contract boss is missing" << getBossMissing(getPeerList());
        return;
    }
    QList<QByteArray> pList = pData.split('$');
    QString arg = QByteArray::fromHex(pList.at(4));
    if(!checkBlockNewIdentity("0",pData)){
        return;
    }
    if(hasSyncQueueRequest("0")){
        BUG << "bad peers: hasSyncQueueRequest";
        return;
    }
    if(arg.contains("?")){
        QStringList argList = arg.split("?");
        if(getPeerList().join(",")==argList.at(1)){
            return;
        }
        setPeerList(argList.at(0).split(","));
        setPeerLose(argList.at(1).split(","));
    }else{
        if(getPeerList().join(",")==arg){
            return;
        }
        setPeerList(arg.split(","));
    }
    setPeers();
    QByteArrayList curContractList = getBossMissingContracts();
    if(!curContractList.isEmpty())
        onBossMissing(curContractList);
    onnBlock curBlock = createBlock(getBlock("0").blockIndex.toLongLong()+1,\
                                    QDateTime::currentMSecsSinceEpoch(),\
                                    getBlock("0").blockHash,\
                                    pData);
    insertBlock("0",curBlock);
    setDatabaseBlock(curHash,curHash);
    emit doPeerNewOK(toString(curBlock));
}
void onnObject::onPeerNewOK(QByteArray pData){
    //BUG << pData;
    onnBlock curBlock = createBlock(pData);
    setDatabaseBlock(QByteArray("0-")+curBlock.blockIndex,pData);
    //emit doBoardcastBlockChainLevel("0",onnObject::toString(curBlock));
    BUG << curBlock.blockIndex;
}
void onnObject::onDeployNewOK(QByteArray pContract,QByteArray pData){
    onnBlock curBlock = createBlock(pData);
    setDatabaseBlock(QByteArray("0-")+curBlock.blockIndex,pData);
    setDatabaseBlock(pContract+'-'+curBlock.blockIndex,pData);
    //emit doBoardcastBlockChainLevel("0",onnObject::toString(curBlock));
    BUG << pContract << curBlock.blockIndex;
}
void onnObject::onMethodNewOK(QByteArray pContract,QByteArray pData){
    if(!hasBlock(pContract)){
        BUG << "ERROR: contract not exist" << pContract;
        exit(-1);
    }
    onnBlock curBlock = createBlock(pData);
    setDatabaseBlock(pContract+'-'+curBlock.blockIndex,pData);
    //emit doBoardcastBlockChainLevel(pContract,onnObject::toString(curBlock));
    BUG << pContract << curBlock.blockIndex;
}
void onnObject::onDestroyNewOK(QByteArray pData){
    onnBlock curBlock = createBlock(pData);
    setDatabaseBlock(QByteArray("0-")+curBlock.blockIndex,pData);
    //emit doBoardcastBlockChainLevel(pContract,onnObject::toString(curBlock));
    BUG << curBlock.blockIndex;
}

void onnObject::onSaveBlock(QByteArray,QByteArray){}

void onnObject::onBlockOldFinish(){}

void onnObject::onUdpdPeer(QStringList pList, QStringList pLose, QStringList pNew){
    if(flagStart == false){
        BUG << "fail: flagStart == false";
        return;
    }else{
        if(pList.isEmpty()){
            BUG << "fail: pList.count()==0";
            return;
        }
        pList.append(onnObjectKey.address);
        emit doSetBossList(getBossAddressList());
    }
    if(!pLose.isEmpty()){
        rmSyncLose(pLose);
    }
    setUdpClientList(pList);
    //pList = getHaveBalanceWorker0(pList,10000);
    BUG;
    BUG << "list" << pList;
    BUG << "lose" << pLose;
    BUG << "new " << pNew;
    //for test disable
    if(!pList.isEmpty() && pList != getPeerList()){
        if(getBoss("0") == onnObjectKey.address){
            QByteArray curData;
            if(pLose.isEmpty())
                curData = doCustomSet("peer","0","peer",(pList.join(",")).toLatin1().toHex());
            else
                curData = doCustomSet("peer","0","peer",(pList.join(",")+"?"+pLose.join(",")).toLatin1().toHex());
            //emit doBlockNew(curData);
            QtConcurrent::run(QThreadPool::globalInstance(),this,&onnObject::onBlockNew,curData);
        }
    }
}
void onnObject::onBroadcastBlockChainLevel(QString pContract, QString pAddress, QString pIndex){
    //BUG << pContract << pAddress;
    if(!hasUdpClientList(pAddress)){
        BUG << "!hasUdpClientList(pAddress)";
        return;
    }/*
    onnBlock curBlock = createBlock(pData.toLatin1());
    if(curBlock.blockIndex.isEmpty()){
        BUG << "curBlock.blockIndex.isEmpty()";
        return;
    }*/
    if(pContract == "0" && pIndex == "0"){
        BUG << "pContract == 0 && pIndex == 0";
        return;
    }
    if(!hasBlock(pContract.toLatin1())){
        //emit doRequireBlockChainData(pContract,curBlock.blockMaker,0,curBlock.blockIndex);
        BUG << "!hasBlock(pContract.toLatin1())";
        return;
    }
    onnBlock localBlock = getBlock(pContract);

    if(pIndex.toLongLong()<=localBlock.blockIndex.toLongLong()){
        //BUG << "pIndex.toLongLong()<=localBlock.blockIndex.toLongLong()" << pIndex << localBlock.blockIndex;
        return;
    }/*else if(curBlock.blockIndex.toLongLong()==localBlock.blockIndex.toLongLong()+1){
        emit doBlockOld(pData.toLatin1());
        return;
    }
    */
    if(!hasSyncQueue(pContract.toLatin1(),pAddress.toLatin1(),"request")){
        BUG << "doRequireBlockChainData" << localBlock.blockIndex.toLongLong()+1 << pIndex;
        //emit doRequireBlockChainData(pContract,pAddress,QString::number(localBlock.blockIndex.toLongLong()+1),curBlock.blockIndex);
        emit doCustomRequire(pContract,pAddress.toLatin1(),"require",QString::number(localBlock.blockIndex.toLongLong()+1)+":"+pIndex);
        setSyncQueue(pContract.toLatin1(),pAddress.toLatin1(),"request",QString::number(localBlock.blockIndex.toLongLong()+1).toLatin1(),pIndex.toLatin1());
    }
}
void onnObject::onRequireBlockChainData(QString pContract, QString nodeAddress, QString start, QString end){
    BUG << pContract << nodeAddress << start << end;
    if(!hasBlock(pContract.toLatin1())){
        BUG << "msg fail: !hasBlock(pContract)" << pContract;
        return;
    }
    if(start.toLongLong()<0 || end.toLongLong()<0){
        BUG << "msg fail: start.toLongLong()<0 || end.toLongLong()<0" << start << end;
        return;
    }
    if(start.toLongLong()>end.toLongLong()){
        BUG << "msg fail: start.toLongLong()<=end.toLongLong()" << start << end;
        return;
    }
    QByteArray curStartKey = pContract.toLatin1()+"-"+start.toLatin1();
    QByteArray curEndKey   = pContract.toLatin1()+"-"+end.toLatin1();
    if(getDatabaseBlock(curStartKey) == "null"){
        BUG << "msg fail: getDatabaseBlock(curStartKey) == null" << curStartKey;
        return;
    }
    if(getDatabaseBlock(curEndKey) == "null"){
        BUG << "msg fail: getDatabaseBlock(curEndKey) == null" << curEndKey;
        return;
    }
    quint32 curSize = 0;
    QJsonArray curArray;
    QJsonDocument curDocument;
    QByteArray curKey,curVar;
    for(qint64 i=start.toLongLong();i<=end.toLongLong() && curSize<8800;i++){
        curKey = pContract.toLatin1()+"-"+QString::number(i).toLatin1();
        curVar = getDatabaseBlock(curKey);
        curSize += curVar.count();
        curArray.append(QString(curVar));
    }
    BUG << "doSendBlockChainData" << curArray.size() << start << end;
    onnBlock curBlock = createBlock(curVar);
    curDocument.setArray(curArray);
    //emit doSendBlockChainData(pContract,nodeAddress,curDocument.toJson());
    emit doCustomRequire(pContract,nodeAddress.toLatin1(),"send",curDocument.toJson());
    if(!hasSyncQueue(pContract.toLatin1(),nodeAddress.toLatin1(),"response")){
        setSyncQueue(pContract.toLatin1(),nodeAddress.toLatin1(),"response",curBlock.blockIndex,end.toLatin1());
    }
    if(!updSyncQueueIndex(pContract.toLatin1(),nodeAddress.toLatin1(),"response",curBlock.blockIndex)){
        BUG << "rmSyncQueue response" <<  pContract;
        rmSyncQueue(pContract.toLatin1(),nodeAddress.toLatin1(),"response");
    }
}
void onnObject::onSendBlockChainData(QString pContract, QString pAddress, QString pData){
    BUG << pContract << pAddress << pData.count();
    QJsonDocument curDocument = QJsonDocument::fromJson(pData.toLatin1());
    QJsonArray curArray = curDocument.array();
    if(curArray.isEmpty()){
        return;
    }
    for(auto curData:curArray)
        emit doBlockOld(curData.toString().toLatin1());
    QByteArray lastBlock = curArray.last().toString().toLatin1();
    onnBlock curBlock = createBlock(lastBlock);
    if(curBlock.blockIndex.isEmpty()){
        return;
    }
    if(hasSyncQueue(pContract.toLatin1(),pAddress.toLatin1(),"request")){
        if(!updSyncQueueIndex(pContract.toLatin1(),pAddress.toLatin1(),"request",curBlock.blockIndex)){
            BUG << "rmSyncQueue request" <<  pContract;
            rmSyncQueue(pContract.toLatin1(),pAddress.toLatin1(),"request");
        }
    }
}


void onnObject::onCustomRequire(QString contractID, QString addr, QString cmd, QString data){
    if(flagStart == false){
        BUG << "fail: falg == false";
        return;
    }
    //BUG << cmd;
    if(cmd=="newblock"){
        //emit doBlockNew(data.toLatin1());
        QtConcurrent::run(QThreadPool::globalInstance(),this,&onnObject::onBlockNew,data.toLatin1());
    }else if(cmd=="level"){
        QStringList levelData = data.split(",");
        for(auto curLevel:levelData){
            QStringList curData = curLevel.split(":");
            if(curData.count() != 2){
                BUG << "error: data error" << curData;
                continue;
            }
            onBroadcastBlockChainLevel(curData.first(),addr,curData.last());
        }
    }else if(cmd=="require"){
        QStringList startEnd = data.split(":");
        if(startEnd.count()<2){
            BUG << cmd << "fail: startEnd.count()<2" << data;
            return;
        }
        onRequireBlockChainData(contractID,addr,startEnd.at(0),startEnd.at(1));
    }else if(cmd=="send"){
        onSendBlockChainData(contractID,addr,data);
    }else{
        BUG << "fail: Unknow cmd" << cmd;
    }
}

void onnObject::onBossMissing(QByteArrayList pList){
    for(auto curContract:pList){
        if(curContract=="0")
            continue;
        QString curResult = setNextBoss(curContract+"?10000");

        if(curResult == "fail"){
            BUG << "fail: _setNextBoss fail" << curContract << curResult;
        }else{
            BUG << "fail: _setNextBoss ok" << curContract << curResult;
            setBoss(curContract,curResult.toLatin1());
        }
    }
}

void onnObject::onTimeout(){
    if(!flagStart){
        BUG << "fail: flagStart == false" << QThread::currentThreadId();
        return;
    }
    if(getUdpClientList().isEmpty()){
        BUG << "fail: pList.isEmpty()";
        return;
    }
    QStringList curPeerList = getUdpClientList();
    if(curPeerList.count() == 1 && curPeerList.first() == onnObjectKey.address){
        BUG << "fail: curPeerList.count() == 1 && ==" << onnObjectKey.address;
        return;
    }
    QStringList levelData;
    QHash<QString,onnBossBlock> curBlockChain = *onnBlockChain;
    QHash<QString,onnBossBlock> *curBlockChainPtr = &curBlockChain;
    for(auto curBlockIter=curBlockChainPtr->begin();curBlockIter!=curBlockChainPtr->end();curBlockIter++){
        //BUG << "doBroadcastBlockChainLevel" << curBlockIter.key() << curBlockIter.value().blockCurrent.blockIndex;
        //emit doCustomBroadcast(curBlockIter.key(),"level",curBlockIter.value().blockCurrent.blockIndex);
        if(levelData.isEmpty()){
            levelData.append(curBlockIter.key()+":"+curBlockIter.value().blockCurrent.blockIndex);
        }else{
            if(levelData.last().count()>10000){
                levelData.append(curBlockIter.key()+":"+curBlockIter.value().blockCurrent.blockIndex);
            }else{
                levelData.replace(levelData.count()-1,levelData.last()+","+curBlockIter.key()+":"+curBlockIter.value().blockCurrent.blockIndex);
            }
        }
    }
    for(auto curLevel:levelData){
        emit doCustomBroadcast("*","level",curLevel);
    }
    QList<onnSyncQueue> curRemove;
    for(auto cur=onnSyncRequest.begin();cur!=onnSyncRequest.end();cur++){
        onnSyncQueue curData;
        if(!hasSyncQueue(cur.value().blockContract,cur.value().blockAddress,"request")){
            continue;
        }
        if(onnBlackList.contains(cur.value().blockAddress)){
            curRemove.append(getSyncQueue(cur.value().blockContract,cur.value().blockAddress,"request"));
            //rmSyncQueue(cur.value().blockContract,cur.value().blockAddress,"request");
            continue;
        }
        curData = getSyncQueue(cur.value().blockContract,cur.value().blockAddress,"request");
        if(QDateTime::currentMSecsSinceEpoch()-curData.blockLastModify>60*1000){
            curRemove.append(curData);
            //rmSyncQueue(cur.value().blockContract,cur.value().blockAddress,"request");
            onnBlackList.append(cur.value().blockAddress);
            //emit doRequireBlockChainData(cur.value().blockContract,cur.value().blockAddress,curData.blockCurrentIndex,curData.blockEnd);
        }
    }
    for(auto cur:curRemove){
        rmSyncQueue(cur.blockContract,cur.blockAddress,"request");
    }
    if(curRemove.count()>0)
        BUG << "curRemove Sync request =" << curRemove.count();
    curRemove.clear();
    QList<onnSyncQueue> curSyncQueue;
    for(auto cur=onnSyncResponse.begin();cur!=onnSyncResponse.end();cur++){
        if(!hasSyncQueue(cur.value().blockContract,cur.value().blockAddress,"response")){
            continue;
        }
        onnSyncQueue curQueue = getSyncQueue(cur.value().blockContract,cur.value().blockAddress,"response");
        quint32 curSize = 0;
        QJsonArray curArray;
        QJsonDocument curDocument;
        QByteArray curKey,curVar;
        for(qint64 i=curQueue.blockCurrentIndex.toLongLong();i<=curQueue.blockEnd.toLongLong() && curSize<88000;i++){
            curKey = cur.value().blockContract+"-"+QString::number(i).toLatin1();
            curVar = getDatabaseBlock(curKey);
            curSize += curVar.count();
            curArray.append(QString(curVar));
        }
        if(curSize>100000 && curArray.count()>1){
            curSize -= curArray.last().toString().count();
            curArray.removeLast();
            curVar = curArray.last().toString().toLatin1();
        }
        onnBlock curBlock = createBlock(curVar);
        BUG << curBlock.blockIndex;
        curDocument.setArray(curArray);
        //emit doSendBlockChainData(cur.value().blockContract,cur.value().blockAddress,curDocument.toJson());
        emit doCustomRequire(cur.value().blockContract,cur.value().blockAddress,"send",curDocument.toJson());
        if(!updSyncQueueIndex(cur.value().blockContract,cur.value().blockAddress,"response",curBlock.blockIndex)){
            curSyncQueue.append(curQueue);
        }
    }
    for(auto cur:curSyncQueue){
        rmSyncQueue(cur.blockContract,cur.blockAddress,"response");
    }
    if(curSyncQueue.count()>0)
        BUG << "curSyncQueue Sync response =" << curSyncQueue.count();
    if(!getBossAddressList().contains(onnObjectKey.address)){
        return;
    }
    if(getPeerList().isEmpty()){
        return;
    }
    //QStringList curBossLose = getBossLose(pLose);
    QByteArrayList curBossLose = getBossMissing(getPeerList());
    if(curBossLose.isEmpty()){
        return;
    }
    for(auto curBossAddress:curBossLose){
        rmBossFromAddress(curBossAddress);
    }
}
